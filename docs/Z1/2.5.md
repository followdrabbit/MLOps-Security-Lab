# 2.5 Anti-malware, CDR & Sandbox

Depois de:

1. passar pelo **WAF** (ataques genéricos),
2. ser **autenticado/autorizado** (sabemos quem é),
3. passar na **Content Validation** (tipo/tamanho/schema ok),

se a requisição envolve **arquivos** (PDF, imagem, CSV, ZIP, etc.), entra este bloco:

> “Antes de qualquer arquivo tocar no seu data lake ou pipeline de ML, trate como potencialmente malicioso.”

Esse componente é crítico porque:

* ingestão de documentos/arquivos é muito comum,
* libs de parsing são grandes e cheias de histórico de CVEs,
* ETL, workers e serviços internos normalmente não foram feitos pra enfrentar malware.

A Z1 resolve isso com três camadas combináveis:

1. **Antivírus/Anti-malware**
2. **CDR (Content Disarm & Reconstruction)**
3. (Opcional) **Sandbox/Detonação**

---

## 2.5.1 Escopo: o que passa por Anti-malware/CDR?

Nem tudo, senão você mata performance à toa.

**Passam por esse fluxo:**

* Uploads de:

  * documentos (PDF, DOCX, XLSX, PPTX),
  * imagens (se usadas como evidência, anexos),
  * arquivos comprimidos (ZIP, RAR, etc.),
  * qualquer binário vindo de cliente, parceiro, fonte externa.
* Arquivos oriundos de:

  * canais públicos,
  * parceiros,
  * automações internas de baixo controle.

**Normalmente não passam (direto nesse bloco):**

* JSON, CSV “simples” validados como texto (embora possam ter outras validações).
* Dados já produzidos por serviços internos confiáveis *dentro* do perímetro (aqui o risco é outro: lógica/poisoning, não malware).

---

## 2.5.2 Anti-malware (scan)

**Ideia:** rodar o arquivo por um ou mais motores de detecção antes de aceitar.

O que um motor de anti-malware bem configurado deve fazer na Z1:

* Analisar o arquivo:

  * assinaturas conhecidas de malware,
  * padrões suspeitos (macro, script, payload ofuscado),
  * comportamento típico de documentos maliciosos.
* Lidar com compressão:

  * descompactar ZIP/RAR,
  * analisar conteúdo interno,
  * aplicar limites de profundidade (anti “zip bomb”).
* Trabalhar de forma:

  * automatizada,
  * integrada no fluxo do gateway / serviço de ingestão.

**Política típica:**

* Se detectou malware/suspeito:

  * bloquear,
  * logar,
  * opcionalmente mandar para área de análise (quarentena),
  * nunca deixar seguir para Z2.
* Se não detectou:

  * segue para próxima etapa (CDR, se aplicável) ou direto para ETL.

**No lab (como simular sem virar SOC real):**

* Usar um container com ClamAV ou similar.
* Criar um serviço de “scan”:

  * upload chega,
  * a API chama o scanner,
  * se “infectado” → 4xx + log,
  * se “limpo” → continua.
* Mesmo que seja simplificado, o conceito fica claro:

  > “arquivo não entra direto no bucket, passa por checagem dedicada”.

---

## 2.5.3 CDR — Content Disarm & Reconstruction

CDR é o “modo paranóico inteligente”:

> Em vez de só perguntar “esse arquivo tem vírus conhecido?”,
> ele pergunta: “que partes desse arquivo podem ser perigosas?”
> e reconstrói uma **versão segura**.

Exemplos práticos de como CDR atua:

* Em documentos Office:

  * remove macros, OLE, links ativos, conteúdo dinâmico.
* Em PDFs:

  * remove JavaScript embutido,
  * remove formulários/ações automatizadas.
* Em imagens:

  * normaliza o formato,
  * descarta metadata suspeita.

**Resultado:**
Você guarda/usa apenas uma cópia “sanitizada”, reduzindo muito a superfície de ataque.

**Quando faz sentido:**

* Upload de documentos por clientes (KYC, comprovação, etc.).
* Intercâmbio de arquivos com terceiros.
* Quando o objetivo do arquivo é só “conteúdo visual/textual”, não execução.

**No lab:**

* Você pode não implementar um CDR real hardcore,
* mas pode:

  * simular removendo metadata,
  * restringindo certos tipos de arquivo,
  * explicitar no doc:

    > “Neste ponto, em ambiente real, entraria o CDR para documentos de alto risco.”

---

## 2.5.4 Sandbox / Detonação (opcional, avançado)

Para cenários de alto risco:

> “Ainda tô na dúvida se esse arquivo é malicioso. Vamos rodar isolado e ver.”

Sandbox é:

* Executar o arquivo em ambiente isolado,
* Observar comportamento:

  * tentativas de conexão,
  * escrita em disco,
  * criação de processos estranhos.

Se se comportar mal → marca como malicioso, bloqueia.

**Por que é opcional no lab:**

* É pesado,
* mais complexo pra montar,
* mas importante citar como prática de mercado para bancos e operações críticas.

---

## 2.5.5 Integração no fluxo Z1 (onde entra Anti-malware/CDR)

Ordem lógica típica:

1. Requisição chega (arquivos incluídos).
2. **WAF** avalia padrão de ataque geral.
3. **AuthN/AuthZ** garante identidade e escopo.
4. **Content Validation** confirma:

   * tipo,
   * tamanho,
   * formato esperado.
5. **Anti-malware/CDR** executa para arquivos:

   * se infectado/suspeito:

     * bloqueia + log.
   * se limpo/sanitizado:

     * entrega para o pipeline (ETL/MQ) enviar a Z2.
6. ETL/MQ escreve no **Raw Data Lake (Z2)**.

**Importante:**

* Se o arquivo falhar em qualquer etapa (tipo errado, muito grande, malware detectado):

  * ele **NÃO** deve vazar para Z2.
* Sempre deixar rastro:

  * fonte,
  * motivo do bloqueio,
  * hash do arquivo (se armazenado em quarentena).

---

## 2.5.6 Riscos mitigados

Esse bloco é a defesa contra:

* entrada de malware na infra de dados,
* exploração de bibliotecas de parsing (PDF, Office, etc.),
* uso do pipeline de ingestão como canal para ataque interno,
* abuso do ambiente de ML/ETL como trampolim para lateral movement.

E conversa diretamente com:

* princípios de **Defesa em profundidade**,
* controles de código malicioso (equivalente a NIST SI-3),
* boas práticas OWASP para upload seguro.

---

## 2.5.7 Implementação sugerida no Lab (prático e didático)

Para o **MLOps Security Lab**, você pode propor:

* Um serviço `scan-service` (ex.: FastAPI + ClamAV):

  * endpoint interno `/scan`,
  * recebe o arquivo,
  * responde `clean` ou `infected`.
* O Ingestion Gateway:

  * ao receber um upload:

    * checa tipo/tamanho (2.4),
    * chama `scan-service`,
    * se `infected` → 4xx, log, não salva,
    * se `clean` → salva em área temporária / manda para ETL.
* Documentar claramente:

  * “arquivos só são persistidos após o scan”.

Mesmo simples, isso consolida o padrão mental:

> “Arquivo é dado perigoso por padrão. Se não passou por scan/CDR, não entra no dataset.”