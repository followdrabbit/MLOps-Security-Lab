# 2.5 Anti-malware, CDR & Sandbox

Depois de:

1. passar pelo **WAF** (ataques genéricos),
2. ser **autenticado/autorizado** (sabemos quem é),
3. passar na **Content Validation** (tipo/tamanho/schema ok),

se a requisição envolve **arquivos** (PDF, imagem, CSV, ZIP, etc.), entra este bloco:

> **Antes de qualquer arquivo tocar no seu data lake ou pipeline de ML, trate como potencialmente malicioso.**

Esse componente é crítico porque:

* ingestão de documentos/arquivos é muito comum,
* libs de parsing são grandes e cheias de histórico de CVEs,
* ETL, workers e serviços internos normalmente não foram feitos pra enfrentar malware.

A Z1 resolve isso com camadas combináveis:

1. **Antivírus/Anti-malware com Multi-engine & Recursive Scan**
2. **CDR (Content Disarm & Reconstruction)**
3. (Opcional) **Sandbox/Detonação**

---

## 2.5.1 Escopo: o que passa por Anti-malware/CDR?

Nem tudo, senão você mata performance à toa.

**Passam por esse fluxo (obrigatório Anti-malware, preferencialmente com CDR quando aplicável):**

* Uploads de:

  * documentos (PDF, DOCX, XLSX, PPTX),
  * imagens (quando enviadas como evidência, anexos, comprovantes),
  * arquivos comprimidos (ZIP, RAR, etc.),
  * qualquer binário vindo de cliente, parceiro ou fonte externa.
* Arquivos oriundos de:

  * canais públicos,
  * parceiros,
  * automações internas com menor governança.

**Normalmente não passam diretamente por scan de arquivo binário:**

* JSON, CSV “simples” tratados como texto estruturado (mas ainda sujeitos à validação de conteúdo e qualidade).
* Dados produzidos por serviços internos confiáveis *dentro* do perímetro (aqui o foco passa a ser integridade/poisoning lógico, não malware).

> Mesmo assim, qualquer fluxo novo ou pouco confiável pode ser incluído na política de scan conforme risco.

---

## 2.5.2 Anti-malware (Multi-engine + Recursive Scan)

**Ideia:** não confiar em um único motor, nem só na “casca” do arquivo.

Um mecanismo de anti-malware bem desenhado na Z1 deve:

### Multi-engine

Rodar o arquivo contra **mais de um mecanismo de detecção**, por exemplo:

* um antivírus open source (ex.: ClamAV),
* * um motor comercial ou serviço dedicado,
* * regras internas (ex.: [YARA](https://virustotal.github.io/yara/), assinaturas específicas).

>Nota: “YARA é uma ferramenta usada em segurança para criar regras customizadas de detecção de malware e artefatos suspeitos. Em vez de depender só das assinaturas do antivírus, a gente escreve padrões específicos — strings, estruturas, comportamentos — e aplica sobre arquivos ou memória. Em uma arquitetura de ingestão segura, ela pode ser usada como parte de um multi-engine scan, aumentando a capacidade de identificar arquivos maliciosos em uploads antes de chegarem no data lake.”

Benefícios:

* reduz falsos negativos (se um engine falha, outro pode detectar),
* aumenta a cobertura contra diferentes famílias/técnicas.

### Recursive scan

Não olhar só o arquivo externo, mas também:

* descompactar ZIP/RAR/TAR,
* inspecionar arquivos internos (PDF dentro de ZIP, DOCX dentro de outro ZIP, etc.),
* aplicar limites de proteção:

  * profundidade máxima,
  * tamanho total descompactado,
  * defesa contra “zip bomb” e aninhamentos abusivos.

### Comportamento esperado na Z1

* Analisar o arquivo (e seus filhos internos) em busca de:

  * assinaturas conhecidas de malware,
  * macros e scripts maliciosos,
  * payloads ofuscados,
  * padrões de exploração comuns.
* Operar de forma:

  * automatizada,
  * integrada ao fluxo do gateway / serviço de ingestão,
  * com resposta clara: `clean`, `infected`, `suspicious`.

**Política típica:**

* Se qualquer engine ou regra indicar `infected` ou `suspicious`:

  * bloquear,
  * logar (incluindo hash, origem, endpoint),
  * opcionalmente enviar para quarentena/forense,
  * **jamais** permitir que siga para Z2.
* Se todos retornarem “limpo”:

  * segue para CDR (se aplicável) ou próxima etapa do fluxo.

**No lab (simulação prática):**

* Usar um serviço `scan-service` com ClamAV (e, se quiser, stub para “multi-engine”).
* O Ingestion Gateway:

  * envia o arquivo para esse serviço,
  * decide com base na resposta:

    * `infected` → 4xx + log, não persiste,
    * `clean` → continua o fluxo.

> Mensagem didática: **“arquivo nunca vai direto pro bucket; sempre passa por scan dedicado.”**

---

## 2.5.3 CDR — Content Disarm & Reconstruction

CDR é o “modo paranóico inteligente”:

> Em vez de perguntar só “tem malware conhecido?”,
> pergunta “que partes deste arquivo podem ser perigosas?”
> e reconstrói uma **versão segura**.

Exemplos de atuação:

* Em documentos Office:

  * remove macros, OLE, links ativos, conteúdo dinâmico.
* Em PDFs:

  * remove JavaScript embutido,
  * remove formulários/ações automatizadas.
* Em imagens:

  * reprocessa o arquivo,
  * limpa metadata suspeita.

**Resultado:**
Você guarda/usa apenas uma cópia **sanitizada**, reduzindo muito a superfície de ataque.

**Quando faz sentido:**

* Upload de documentos por clientes (KYC, comprovantes, contratos).
* Troca de arquivos com terceiros.
* Cenários em que o conteúdo é de leitura/visualização, não execução.

**No lab:**

* Não precisa implementar CDR corporativo,
* mas pode:

  * restringir tipos aceitos,
  * normalizar arquivos,
  * documentar que em ambiente real:

    > “Aqui entraria o CDR para documentos de alto risco.”

---

## 2.5.4 Sandbox / Detonação (opcional, avançado)

Para contextos de risco muito alto:

> “Mesmo após scan e CDR, ainda quero observar o comportamento.”

Sandbox é:

* executar o arquivo em ambiente totalmente isolado,
* monitorar:

  * tentativas de conexão externa,
  * criação de arquivos/execução suspeita,
  * alterações estranhas no sistema.

Se o comportamento for malicioso → bloqueio definitivo, alerta, possível investigação.

**Por que é opcional no lab:**

* Alto custo operacional e técnico,
* mais comum em bancos/grandes empresas,
* mas importante citar como “próximo nível” para uploads críticos.

---

## 2.5.5 Integração no fluxo Z1 (onde entra Anti-malware/CDR)

Ordem lógica típica:

1. Requisição chega (com arquivos).
2. **WAF** filtra ataques genéricos.
3. **AuthN/AuthZ** garante identidade e escopo.
4. **Content Validation** confere:

   * tipo/MIME permitido,
   * tamanho máximo,
   * formato básico.
5. **Anti-malware (Multi-engine + Recursive Scan)**:

   * se `infected`/`suspicious`:

     * bloqueia + log + (opcional) quarentena.
   * se `clean`:

     * segue.
6. **CDR** (quando aplicável):

   * gera cópia sanitizada para uso interno.
7. Apenas então:

   * arquivos/dados seguem para **2.6 Higiene inicial (quando estruturado)**,
   * e para **2.7 ETL / MQ / Streaming (conectores oficiais)**,
   * que persistem em **Z2 — Raw Data Lake**.

**Importante:**

* Se o arquivo falhar em qualquer etapa:

  * ele **NÃO** deve chegar à Z2.
* Sempre registrar:

  * fonte,
  * decisão,
  * motivo do bloqueio,
  * hash ou ID do arquivo (especialmente se for para quarentena).

---

## 2.5.6 Riscos mitigados

Este bloco é a defesa direta contra:

* entrada de malware e payloads ativos na infraestrutura de dados,
* exploração de bibliotecas de parsing (PDF, Office, imagens, compactadores),
* uso da camada de ingestão como vetor para ataque interno ou lateral,
* ocultação de malware em arquivos aninhados/compactados.

Conecta-se com:

* **Defesa em profundidade**,
* **NIST SP 800-53 SI-3** (proteção contra código malicioso),
* boas práticas **OWASP** para upload seguro.

---

## 2.5.7 Implementação sugerida no Lab (prático e didático)

Para o **MLOps Security Lab**, você pode:

* Criar um serviço `scan-service` (FastAPI + ClamAV, por exemplo):

  * endpoint interno `/scan`,
  * recebe arquivo,
  * faz scan (e simula multi-engine se quiser),
  * responde `clean` ou `infected`.
* Ajustar o Ingestion Gateway para:

  * checar tipo/tamanho (Content Validation),
  * enviar o arquivo ao `scan-service`,
  * decidir:

    * se `infected` → 4xx + log, não salvar,
    * se `clean` → salvar em staging seguro / acionar ETL oficial.
* Documentar explicitamente no README/Z1:

> “Nenhum arquivo é persistido em Raw (Z2) sem passar por scan (multi-engine + recursive) e, quando aplicável, sanitização (CDR). Arquivo é dado hostil por padrão.”
