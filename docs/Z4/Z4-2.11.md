# Z4-2.11 — **Promoção Final & Handoff Operacional (Z5→Z6)**

*o “fechamento de release” que transforma um candidato aprovado em **versão operável**, com governança, comunicação e plano de vida útil*

Após a aprovação em **Staging/Shadow/Canary** (Z4-2.10), esta etapa consolida a **promoção no Registry (Z5)**, aplica **políticas finais de mudança**, publica **artefatos de release** (manifestos, notas, políticas de runtime), coordena o **handoff** com Operações/Segurança/Negócio e libera a versão para **consumo controlado na Z6**.
É aqui que a versão “viva” do modelo ganha **identidade operacional**, **ciclo de vida** e **pontos de controle**.

---

## 1) Objetivo & Momento de execução

**Objetivo:** promover a versão do modelo para um estado **Approved** no Z5, emitir os **artefatos de release** e **conectar** as políticas operacionais (SLOs, guardrails, monitoramento, depreciação) ao runtime da Z6.

**Quando:** somente após:

* `security_decision=PASS` (Z4-2.5),
* **Readiness** (Z4-2.8) **aprovado**,
* **Staging/Shadow/Canary** (Z4-2.10) **sem violações**,
* **Higiene pós-treino** (Z4-2.9) concluída.

---

## 2) Entradas (pré-requisitos)

* **Z5/Registry**: model version em `Staging` (assinaturas/attestation válidas).
* **Relatórios**: `staging_report.json`, `shadow_eval.json`, `canary_plan.md` + `rollout_decision.txt`.
* **Governança**: **Model Card** final, **SCDR/ADR** finalizados e linkados ao run/versão.
* **SLOs/SLIs**: latência p95/p99, taxa de erro, limites de custo por 1k chamadas, políticas LLM.

---

## 3) Saídas (artefatos do release)

* `release_manifest.json`

  * `model_name`, `version`, `run_id`, `registry_uri`, `security_decision`, `signatures`, `attestation`, `dataset@snapshot`,
  * **SLOs/SLIs**, **guardrails** (limites de saída/LLM policies), **drift thresholds**, **fairness watchlist**,
  * **janela de revalidação** (ex.: 90 dias), **data de expiração** (EoL/EoS).
* `release_notes.md`

  * mudanças vs. versão anterior, impacto de negócio, riscos residuais aceitos, limitações conhecidas.
* `policy_snapshot/`

  * cópias versionadas das políticas de **Z6** (Inference/LLM Gateway, ABAC, rate, quotas).
* `dashboards_links.json`

  * URLs de métricas/traces/logs por versão (Z9), alertas ativos (p95, erro, drift).
* (Opcional) `clients_compat_report.json`

  * checagem de compatibilidade com consumidores críticos (esquema/contrato de API).

> Todos anexados ao **run** (Z4-2.6) e referenciados na versão do **Z5**.

---

## 4) Fluxo de promoção (passo a passo)

### 4.1 Transition no Registry

* Mover a versão `Staging → Approved` **somente** via pipeline com verificação de assinatura/attestation + checklist de readiness.
* Bloquear promoção se houver **CVEs bloqueadoras** na **SBOM** pós-build ou **políticas não encontradas**.

### 4.2 *Bind* de políticas de runtime (Z6)

* Publicar **Policy Snapshot**:

  * **Inference Gateway**: AuthN/AuthZ (ABAC), mTLS, rate/quotas, schema enforcement.
  * **LLM Gateway**: input/output filtering, PII masking, anti-prompt injection, **policy.yaml** de conteúdo.
  * **Output Limits**: intervalos de score, *no NaN/Inf*, JSON Schema (contrato).
* Registrar no Z5 **hashes/digests** dos arquivos de política vinculados à versão (imobilidade/reprodutibilidade).

### 4.3 Comunicação & Janela de Mudança

* Abrir **change ticket** (CAB/ITIL) com: escopo, janelas, impacto, plano de rollback, aprovações.
* Notificar **consumidores** (Z7) e **Sec/Priv/Negócio**: release notes, data/hora, SLOs, como reportar incidentes.
* Para **bancos**: anexar **conformidade LGPD**, finalidade de uso, contatos de DPO/Segurança.

### 4.4 Agendamento de revalidação

* Definir **retreinamento/review** periódico (ex.: **90 dias**) ou *gatilhos* (drift, fairness, KPIs).
* Programar **auditoria** de aderência (Z9) e **teste de DR/rollback** em ambiente de ensaio.

---

## 5) Automação (exemplos)

### 5.1 Transição no MLflow Registry (Python)

```python
from mlflow.tracking import MlflowClient
c = MlflowClient()
c.transition_model_version_stage(
  name="risk-default", version=mv.version,
  stage="Approved", archive_existing_versions=False
)
c.set_model_version_tag("risk-default", mv.version, "approved_by", "sec_ops_bot")
c.set_model_version_tag("risk-default", mv.version, "policy_digest", policy_sha256)
```

### 5.2 Gate de promoção (OPA/Rego – resumo)

```rego
package registry.promote

default allow = false

allow {
  input.stage_from == "Staging"
  input.stage_to   == "Approved"
  input.signatures.valid
  input.attestation.present
  input.security_decision == "PASS"
  not input.sbom.has_blocking_cves
  input.canary.result == "PROCEED"
  input.policies.bound == true
}
```

### 5.3 Snapshot de políticas (hash)

```bash
tar -cf policy_snapshot.tar policies/*
sha256sum policy_snapshot.tar | cut -d' ' -f1 > policy_snapshot.sha256
```

---

## 6) Integrações (Z5/Z6/Z9)

* **Z5 (Registry)**: guarda estado `Approved`, *tags* (`policy_digest`, `slo_profile`), links para **SCDR/ADR**, **release artifacts**.
* **Z6 (Serving)**: no *startup*, valida **assinaturas**, lê **policy snapshot** e publica `model_version/run_id` + `policy_digest` no Z9.
* **Z9 (Obs/Audit)**: dashboards “per-version”, alertas prontos, *trace exemplars*; registra “**release_published**”.

---

## 7) Ciclo de vida (**EoL/EoS**) & Decomissionamento

* **EoS (End of Support)**: data limite de **suporte** (hotfix, bugfix, segurança).
* **EoL (End of Life)**: data de **desligamento** (versão será revogada no Z5).
* **Plano de depreciação**:

  * comunicar consumidores,
  * manter **duas versões** no ar (N e N-1) por janela definida,
  * **revogar** versão antiga no Z5 e **invalidar cache** na Z6.

---

## 8) Riscos × Controles × Frameworks

| Risco                            | Controles (Z4-2.11)                                               | Referências                                |
| -------------------------------- | ----------------------------------------------------------------- | ------------------------------------------ |
| Promover sem políticas aplicadas | *Bind* de **policy snapshot** com digest + verificação em startup | NIST SP 800-53 AC-/SC-, CSA AICM (SEF/LOG) |
| Falta de comunicação/ITIL        | **Change ticket**, janela de mudança, release notes               | ITIL/CAB, NIST PM-/IR-                     |
| Observabilidade insuficiente     | `dashboards_links.json`, alertas por versão, OTel/Prom            | NIST AU-2/AU-12, CSA CCM (LOG)             |
| Não conformidade (LGPD)          | Model Card + finalidade/base legal + SCDR/ADR                     | LGPD/GDPR, ISO/IEC 23894                   |
| Versões zumbis em produção       | EoL/EoS, **revogação** no Z5, limpeza de cache Z6                 | NIST CM-/SI-, SRE runbooks                 |

---

## 9) Runbooks (operacionais)

* **Falha na validação de políticas na Z6 (startup)**
  Ação: impedir carga; revisar `policy_digest`; re-publicar snapshot; auditar alterações.
* **Consumidor incompatível (quebra de contrato)**
  Ação: ativar *compat layer* (rota vN-1), abrir *task* de adequação, rebaixar tráfego.
* **Incidente pós-promoção**
  Ação: **rollback** via Registry (promover versão anterior Approved); registrar **post-mortem** (Z9); atualizar SCDR.
* **Drift/deriva precoce**
  Ação: acionar *playbook* de recalibração/retreino; reduzir tráfego; revisar thresholds.

---

## 10) Frase pronta para a entrevista

> “Depois do canary, faço a **promoção final no Registry** e publico um **release manifest** com SLOs, políticas de runtime, thresholds de drift e links de observabilidade. **Ligo** o *policy snapshot* (hash) à versão aprovada e notifico consumidores via **change ticket**. Defino **revalidação periódica** e **EoL/EoS**. Em produção, a Z6 só carrega modelos **Approved** com assinatura válida e **policy_digest** correspondente — qualquer divergência bloqueia o *startup* e dispara rollback.”
