# Z4-2.9 — **Higiene Pós-Treino, Retenção & Limpeza Segura**

*o “pós-op” que evita vazamentos, resíduos sensíveis e acúmulo de custo*

Depois que o modelo **passa** por Higiene (Z4-2.4), Testes Adversariais (Z4-2.5), Tracking (Z4-2.6) e Empacotamento/Assinatura (Z4-2.7) — e antes de encerrar o job — executamos a **higiene operacional**: apagar **com segurança** temporários e caches, **revogar** segredos efêmeros, **aplicar retenção** e **sanitizar** o ambiente de execução.
Isso reduz **risco de vazamento** (logs/artefatos/caches), **deriva de compliance** e **custo**.

---

## 1) Objetivos & Princípios

**Objetivos**

* **Minimização de dados**: manter **apenas** o que é necessário (artefatos assinados + evidências).
* **Sanitização**: eliminar resíduos (temp, caches, *staging areas*, dumps).
* **Revogação**: fechar *leases* de credenciais e tokens usados no treino.
* **Retenção & descarte**: aplicar política explícita (o que guardar, por quanto tempo, quem pode ver).
* **Custo**: desligar/limpar recursos automaticamente (GPU/volumes/logs).

**Princípios**

* **Defense-in-depth**: limpeza no **pod/job**, no **orquestrador** e no **storage**.
* **“No evidence, no keep” invertido**: **só** persistem evidências aprovadas/assinadas (Z4-2.6/2.7).
* **Automação auditável**: tudo via pipeline, com logs enviados à Z9.

---

## 2) Escopo (o que é alvo de limpeza/retention)

* **Filesystem do job**: `/tmp`, *working dirs*, *checkpoints* intermediários, *merge* temporário de datasets.
* **Caches**: `pip`/conan/conda, `huggingface`/`transformers`, `torch/hub`.
* **Volumes efêmeros**: `emptyDir`, PVCs de *scratch*, *named volumes* de staging.
* **Segredos efêmeros**: tokens de acesso, *leases* do Vault, *session keys*.
* **Logs/artefatos** não aprovados: *debug dumps*, *sample outputs* que contenham PII.
* **Recursos de compute**: pods/Jobs K8s, VMs spot, nós GPU; *auto-shutdown*.

> **Fora do escopo**: artefatos **assinados** (Z4-2.7), relatórios oficiais (Z4-2.4/2.5) e metadados do run (Z4-2.6) — **estes ficam**.

---

## 3) Quando roda (gancho no pipeline)

1. `train` → `eval/sec` → `package/sign` → **`post-run:cleanup` (esta etapa)** → `submit Z5`/`readiness`.
2. Em caso de **FAIL** em gates, roda **mesma limpeza** (não há exceção).

---

## 4) Procedimentos (o “como” fazer)

### 4.1 Sanitização de arquivos & volumes

* Usar **volumes efêmeros** por padrão (`emptyDir` com `medium: Memory` para *scratch* sensível).
* **Apagar** diretórios temporários e **zerar** blocos em volumes persistentes que foram usados como *scratch*:

  * K8s: *post-container hook* executa `shred`/`srm` (quando aplicável) ou reformat/renew de PVC de scratch.
  * VMs: *cloud-init* final executa `wipefs`/`blkdiscard` em discos efêmeros.
* **Nunca** usar `hostPath` para dados sensíveis de treino.

### 4.2 Revogação de segredos e credenciais

* Vault: **revogar leases** e *tokens* usados no job (`vault lease revoke -prefix` + *response wrapping*).
* OIDC/JWT de CI: **expirar** curto (mins) e **invalidar** no término do *stage*.
* Remover **env vars** e *files* de segredos do *workspace* antes do *pod exit*.

### 4.3 Limpeza de caches & *artifacts* não aprovados

* **Caches**: `pip cache purge`, `conda clean --all`, `huggingface-cli cache delete --all`.
* **Dumps**: *delete* de *checkpoints*/amostras que **não** foram para o pacote oficial.
* **Logs**: *redaction* automático (mascarar PII/segredos) → só **resumo** vai à Z9.

### 4.4 Retenção & classificação

* **Classes de dados pós-treino**:

  * **Evidências oficiais** (ficam): relatórios Z4-2.4/2.5, SBOM, assinaturas/attestations, `model_card.md`, métricas.
  * **Intermediários sensíveis** (descartar ou criptografar com prazo curto): *debug sets*, *augmented sets*, *samples*.
  * **Transientes** (apagar já): *tmp*, *scratch*, *previews*.
* Políticas: `RET-90` (evidências 90d/1y/5y conforme regulatório), `RET-7` (intermediários 7d), `RET-0` (transientes).

### 4.5 Encerramento do compute & *quotas*

* K8s: `ttlSecondsAfterFinished` nos *Jobs*, *finalizers* para limpar PVCs efêmeros.
* Cloud: *auto-shutdown* de nós GPU, *lifecycle hooks* para *deprovision*.
* Orquestrador: alarmes para *jobs* zumbis e *volumes* órfãos.

---

## 5) Evidências geradas por esta etapa (artefatos)

* `postrun/cleanup_report.json`

  * itens removidos (paths/volumes), tamanho liberado, *hash* de confirmação quando aplicável;
  * *leases* revogados; *tokens* invalidados; **carimbo de data/hora**.
* `postrun/retention_manifest.json`

  * classificação aplicada (RET-90/RET-7/RET-0), responsáveis, prazos, base legal.
* Logs de *hooks* enviados à **Z9** (auditoria).

---

## 6) Automação (exemplos rápidos)

### 6.1 Hook de limpeza (K8s Job – *epilogue*)

```yaml
lifecycle:
  preStop:
    exec:
      command:
        - /bin/sh
        - -c
        - |
          set -e
          rm -rf /work/tmp/* /work/.cache/*
          pip cache purge || true
          huggingface-cli cache delete --all || true
```

### 6.2 Revogação de leases (Airflow BashOperator)

```bash
vault lease revoke -prefix "auth/approle/login" || true
vault token revoke "$VAULT_TOKEN" || true
```

### 6.3 Política de retenção (pseudo-OPA)

```rego
package retention

keep[file] {
  input[file].class == "EVIDENCE"
}

delete_now[file] {
  input[file].class == "TRANSIENT"
}

delete_in_days[file] {
  input[file].class == "INTERMEDIATE"
  input[file].days <= 7
}
```

---

## 7) Riscos × Controles × Frameworks

| Risco                                         | Controles (Z4-2.9)                                                          | Referências                                            |
| --------------------------------------------- | --------------------------------------------------------------------------- | ------------------------------------------------------ |
| **Vazamento por resíduos** (tmp/caches)       | Volumes efêmeros, `emptyDir: Memory`, *wipe/blkdiscard*, *hooks* de limpeza | NIST SP 800-88 (sanitização), NIST 800-53 MP-6, SI-12  |
| **Exposição de segredos** em disco/log        | Tokens curtos, **revogação de leases**, redaction de logs                   | NIST 800-53 IA-5/SC-12, CSA CCM (SEF/LOG)              |
| **Retenção indevida** de PII/dados sensíveis  | Classificação + `RET-0/7/90`, minimização, criptografia transitória         | LGPD/GDPR (minimização/retenção), NIST AI RMF (Govern) |
| **Custo/recursos órfãos**                     | `ttlSecondsAfterFinished`, GC de PVCs, *auto-shutdown* GPU                  | FinOps, boas práticas K8s/Cloud                        |
| **Forense impossível** (limpeza sem rastreio) | `cleanup_report.json`, eventos Z9, *who/when/what*                          | NIST 800-53 AU-2/AU-12                                 |

---

## 8) Runbooks (quando algo sai do trilho)

* **Detectamos segredo em log/artefato**

  1. **Revogar** credenciais impactadas (Vault/IdP).
  2. **Deletar** artefato/log, gerar versão limpa;
  3. Abrir **incidente** e SCDR de correção; adicionar *redaction* ao pipeline.

* **Volumes órfãos/custos altos**

  1. Rodar *garbage collector* de PVC/volumes;
  2. Revisar `ttlSecondsAfterFinished`;
  3. Definir *budget*/alertas FinOps no orquestrador.

* **Falha na revogação de leases**

  1. Forçar `vault token revoke`;
  2. Auditar quem ainda consegue acesso;
  3. Ajustar TTLs e *wrapping*.

* **Dado intermediário necessário para auditoria**

  1. Reclassificar como **EVIDENCE** com prazo e criptografia;
  2. Atualizar `retention_manifest.json`;
  3. Registrar justificativa no **Model Card/SCDR**.

---

## 9) Integrações (com outras seções)

* **Z4-2.6 (Tracking)**: anexa `cleanup_report.json`/`retention_manifest.json` ao **run**.
* **Z4-2.7 (Assinatura/Empacote)**: só **artefatos finais** permanecem — o resto é alvo de limpeza.
* **Z5 (Registry)**: recebe **somente** conteúdo final; nada de *debug* ou *samples* com PII.
* **Z9 (Observabilidade/Auditoria)**: trilhas de limpeza/revogação e *cost dashboards*.

---

## 10) Frase pronta para a entrevista

> “No final do treino, rodamos um **pós-op automatizado**: limpamos **tmp/caches/volumes efêmeros**, **revogamos** *leases* do Vault e tokens OIDC, aplicamos **políticas de retenção** (RET-0/7/90) e registramos um `cleanup_report.json` no MLflow/Z9. Só ficam os **artefatos assinados** e as **evidências oficiais**. Isso corta **risco de vazamento** e evita **custos órfãos**, alinhado a NIST 800-88/800-53, LGPD e CSA.”
