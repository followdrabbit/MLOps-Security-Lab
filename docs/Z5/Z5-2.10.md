# Z5-2.10 — **Integrações (Z6, Z8, Z9)**

*“o Registry é o pivô: valida, assina, versiona e **conversa** com quem serve (Z6), com quem protege (Z8) e com quem observa (Z9)”*

---

## 1) Objetivo & Escopo

Garantir integrações **padronizadas e auditáveis** entre a Z5 (Registry & Governança) e:

* **Z6 — Serving & Inference:** *startup check*, *policy digest*, controle de download e rollback.
* **Z8 — Security & Trust Services:** chaves/rotação (Vault/KMS), identidade e papéis (IAM/IdP), classificação/DLP.
* **Z9 — Monitoring, Drift & Audit:** eventos de ciclo de vida, métricas por versão, trilhas de decisão.

---

## 2) Integração com **Z6 — Model Serving & Inference**

### 2.1 Handshake de startup/refresh

1. **Z6** solicita versão por **alias** (ex.: `production`) ou `name@version`.
2. **Z5** retorna **metadados mínimos**: `stage`, `artifact_digest`, `policy_digest`, `revoked`, `quarantined`, *URIs seguros*.
3. Z6 **nega** se `revoked/quarantined=true` ou `stage` não permitido no ambiente.
4. Z6 baixa **por digest** e verifica: **assinatura** (cosign), **attestation** (in-toto/SLSA), **policy_digest** (snapshot).
5. **Sucesso** → Z6 registra `startup_permit`; **falha** → `startup_deny` + rollback automático.

**Contrato (resumo)**

```json
{
  "name": "risk-default",
  "version": "v2.3.0",
  "stage": "Approved",
  "artifact_digest": "sha256:...",
  "policy_digest": "a1b2c3...",
  "revoked": false,
  "quarantined": false,
  "uris": {"artifact": "s3+iam://...@sha256:...","attestation": "oci://..."},
  "model_card_ref": "MC-risk-default-v2.3.0"
}
```

### 2.2 Runtime guard (pós-startup)

* Z6 envia **probes** periódicos à Z5: “esta versão foi **revogada**?” “`policy_digest` mudou?”
* Se sim → **quiesce** tráfego, **purge cache** e **rollback** para a Approved saudável anterior.

### 2.3 Batch & LLM Gateway

* **Batch Orchestrator** resolve **sempre** de Z5 (nunca de diretórios soltos).
* **LLM/GenAI Gateway** referencia **guardrails**/políticas versionadas no **Model Card** e impede servir modelos não-Approved.

---

## 3) Integração com **Z8 — Security & Trust Services**

### 3.1 Vault/KMS (chaves, assinatura, rotação)

* Z5 utiliza **KMS/Vault Transit** para assinar artefatos e **policy snapshots**; as chaves têm **SoD** (quem roda ≠ quem administra).
* **Rotação**: nova chave `KID=v3` → Z5 reemite **trust bundle**; Z6 confere KID nos *signatures*.
* **Segredos**: conexão a storage/DB do Registry via **Vault Agent** (sem credenciais estáticas).

### 3.2 IAM/IdP (RBAC+ABAC)

* IdP (Keycloak/OIDC) emite *claims* (`tenant_id`, `domain`, `env`, `role`, `purpose`).
* Z5 aplica **RBAC+ABAC** nas APIs (registrar/promover/revogar/baixar) — ver Z5-2.6.
* Tokens **curto-vivos** + **mTLS** entre Z5↔Z6/CI/CD.

### 3.3 DLP / Catálogo / Classificação

* **Model Card** recebe **labels** (ex.: `pii:restricted`, `finalidade:concessao_credito`).
* DLP pode marcar modelos como **sensíveis** ⇒ Z5 exige **políticas adicionais** (ex.: *purpose check* no download).
* Integração com **Data Catalog** para rastrear **dataset_snapshot** usado em cada versão.

---

## 4) Integração com **Z9 — Monitoring, Drift & Audit**

### 4.1 Event bus (padrão mínimo)

Z5 publica eventos para Z9 (SIEM/observabilidade):

* `release_published` — versão `Candidate` aceita.
* `promotion` — `Candidate→Staging`, `Staging→Approved`.
* `revocation` / `quarantined` — kill-switch/isolamento.
* `alias_updated` — *cutover* de produção.
* `startup_permit` / `startup_deny` — decisões de Z6 (com motivo).
* `policy_changed` — `policy_digest` alterado (gera reconciliação).

**Schema (resumo)**

```json
{
  "event": "promotion",
  "ts": "2025-11-12T22:10:00Z",
  "model": "risk-default",
  "version": "v2.3.0",
  "from": "Staging", "to": "Approved",
  "artifact_digest": "sha256:...",
  "policy_digest": "a1b2...",
  "tenant": "banking", "domain": "risk", "env": "prod",
  "chg_id": "CHG-10234", "approvals": ["security:maria.s","product:raphael.f"]
}
```

### 4.2 Dashboards *per-version*

* Latência/erro (canary vs prod), **drift PSI**, taxa de **deny** em startup, **incidentes**/CVE por versão, *revalidate_by* próximos de expirar.

### 4.3 Auditoria forense

* **Decision logs** (OPA) e *input snapshots* (sem PII) correlacionados ao **CHG/INC**.
* Evidências em **WORM/Object Lock** com política de retenção.

---

## 5) Fluxos **fim-a-fim** (resumos)

### 5.1 Promoção → Deploy

1. CI/CD gera artefato, **SBOM**, **attestation**, assina com KMS.
2. Z5 aceita `Candidate` (gate PASS).
3. Gates promovem até `Approved`; Z5 publica `promotion`.
4. Z6 detecta `alias_updated`, **startups checks** e serve.

### 5.2 Revogação → Rollback

1. Z5 marca **`Revoked`** e publica `revocation`.
2. Z6 bloqueia **download/startup**, faz **purge** e **rollback** de alias.
3. Z9 mostra linha do tempo T0→T+N, sucesso de purge e validação pós-backout.

---

## 6) Segurança & Resiliência (pontos de atenção)

* **Pin por digest** em tudo (artefato e imagens); **sem `:latest`**.
* **Anti-downgrade**: não carregar versão mais antiga sem *change* explícito.
* **Clock sync** (NTP) — tokens/attestations dependem de tempo.
* **Modo degradado**: se Rekor/PKI estiver fora, aceitar **apenas** com *bundle* confiável; do contrário, **negar**.

---

## 7) Mapeamento a Frameworks

* **NIST SP 800-53**: SA-10, CM-3/CM-5/CM-6, SC-8/SC-13, SI-7, AU-2/AU-12.
* **NIST SSDF / SLSA**: proveniência, assinatura, *attestation* no consumo.
* **NIST AI RMF**: Govern/Measure/Manage — eventos, risco residual, revalidação.
* **CSA CCM / AICM**: **IAM**, **SEF**, **LOG**, **DSS** (segurança de dados).
* **ISO/IEC 27001**: A.9 (acesso), A.12 (operações), A.14 (dev seguro).

---

## 8) Runbooks (situações típicas)

* **`startup_deny` em Z6**: checar assinatura/attestation/`policy_digest`/revogação; se necessário, **rollback** por alias.
* **`policy_changed` detectado**: sincronizar *policy snapshot* em Z6; reexecutar startup check.
* **CVE crítica pós-release**: publicar `revocation`, segregar em **Quarentena**, acionar correção e **re-promover** nova versão.
* **Waiver expirado** (SCDR): gate de *expiry* bloqueia **promote**; renovar/mitigar.

---

## 9) “Frases prontas” (entrevista)

> “A Z5 integra com a Z6 via **startup checks**: assinatura cosign, **attestation** SLSA, `policy_digest` e estado (`Approved/Staging`, **não revogado**). Com a Z8, usa **Vault/KMS** para assinar/rotacionar chaves e **IAM** (RBAC+ABAC) para isolar *tenant/domínio/finalidade*. Com a Z9, emite **eventos** (`promotion`, `revocation`, `startup_deny`) e mantém **dashboards por versão**. Se `policy_digest` diverge ou a versão é revogada, a Z6 **bloqueia** e executa **rollback** — tudo auditado.”
