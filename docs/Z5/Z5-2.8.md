# Z5-2.8 — **Revogação, Quarentena & Rollback**

*“se algo cheirar mal, o modelo **para de servir agora**, fica **isolado** para perícia e o tráfego volta para uma versão **confiável** — com trilha completa.”*

---

## 1) Definições rápidas

* **Revogação (`Revoked`)**: estado definitivo que **proíbe** download/startup e **bloqueia** consumo na Z6. Exige **purga de cache** e comunicação ampla.
* **Quarentena (`Quarantined`)**: estado **temporário** de investigação. Não é servível. Mantém artefatos íntegros para perícia, com **TTL** e critérios de saída.
* **Rollback**: retorno **controlado** para uma versão `Approved` anterior, via **alias**/rota, com validações pós-mudança.

---

## 2) Gatilhos (quando acionar)

**Segurança / Supply chain**

* Assinatura inválida, chave comprometida, **attestation** divergente (Z5-2.2).
* **SBOM** com **CVE crítica** em runtime/dep. (descoberta pós-release).
* `policy_digest` **mismatch** no startup da Z6.
* Suspeita de **poisoning**, **exfiltração**, ou uso fora da **finalidade** LGPD.

**Operacional / Qualidade**

* Quebra de **SLO** sustentada (latência/erro).
* **Drift/bias** acima do limiar (Z9).
* Regressão severa em **canary**.

**Regulatório / Jurídico**

* Incidente de privacidade, ordem regulatória, violação contratual com parceiro/provedor.

> Política: gatilhos **podem** ser automáticos (gate OPA) ou manuais (comitê SEG+PROD+OPS).

---

## 3) Fluxo de **Revogação** (normal vs. emergência)

### 3.1 Revogação **de emergência** (tempo-alvo: minutos)

1. **Marcar `Revoked` no Registry** (API/pipeline).
2. **Emitir eventos**: `model.revoked` para Z9 e canais operacionais.
3. **Bloquear consumo**: gates de **download/startup** da Z6 negam imediatamente.
4. **Purgar caches** (ver §6):

   * Inference Gateway (rota/objeto), servidores de modelo, vector cache, CDN (se houver).
5. **Cut traffic**: se era apontado por **alias** `production`, **remover o alias** ou trocar para versão estável anterior.
6. **Congelar batch**: pausar *jobs* que resolvem essa versão; **anotar** outputs gerados após o marco T0.
7. **Comunicar**: IR/Privacidade/Produto/Compliance; abrir **INC-ID** e atualizar landing page interna.

### 3.2 Revogação **normal** (tempo-alvo: horas)

* Passos acima com janela combinada, notificação prévia, e rollback planejado.

---

## 4) **Quarentena** (isolamento para perícia)

**Quando usar**: suspeita **ainda não confirmada** (ex.: alerta de drift severo, denúncia de dado sensível, indício de envenenamento).

**Efeitos**

* Estado `Quarantined`: **não servível** (Z6 bloqueia como se fosse `Revoked`).
* **Imutabilidade probatória**: copiar artefatos, `release_manifest`, logs e amostras para *bucket forense* com **WORM/Object Lock**.
* **Acesso mínimo**: somente `Security`/`Auditor` leitura; **no downloads** para times de produto.
* **TTL** claro (ex.: 7–30 dias) com **critérios de saída**:

  * *Confirmação* ⇒ promover a `Revoked`.
  * *Falso positivo* ⇒ retornar ao estado anterior (ex.: `Approved`) com **relatório**.

---

## 5) **Rollback** (retorno seguro para versão estável)

**Pré-requisitos**

* Versão `Approved` anterior **saudável** e testada.
* **Plano de backout** documentado (cutover e verificações).

**Passos**

1. **Atualizar alias** `production` para `Approved@<versão anterior>`.
2. **Pre-warm**: carregar modelo no cluster de serving (Z6), validar startup gate (assinatura/attestation/policies).
3. **Purgar caches** relacionados à versão revogada (§6).
4. **Validação pós-backout**: SLO (latência/erro), métricas de negócio (ex.: aprovação de crédito), logs sem erros.
5. **Comunicação**: “rollback concluído” + próximos passos.

**Exemplo (pseudo)**

```bash
# 1) remover versão ruim dos aliases
./update_alias.sh risk-default none production
# 2) apontar para versão anterior estável
./update_alias.sh risk-default v2.2.4 production
# 3) purgar caches do gateway/serving
./purge_serving_cache.sh risk-default v2.3.0
# 4) validar saúde
./health_check.sh --model risk-default --alias production
```

---

## 6) **Purge de cache** (onde limpar de verdade)

* **Inference Gateway**:

  * Rotas e objetos (ex.: `GET /admin/purge?model=risk-default&version=v2.3.0`).
  * Tabelas LRU de *feature fetch* e *schema enforcement*.
* **Servidores de modelo** (TorchServe/Triton/FastAPI):

  * Cache de **artefatos** (pesos ONNX/Torch), **compilações JIT**, **tokenizers**, **adapter weights**.
  * Reinicialização de *workers* se for necessário.
* **Vector/Feature caches**: invalidar *keys* associadas à versão, recarregar índices (se aplicável).
* **CDN/Edge** (se APIs forem cacheáveis): `PURGE` por caminho/ETag.
* **Batch**: esvaziar *staging areas* e marcar **outputs** pós-T0 como **suspeitos** ou **descartados**.

> Registre o **que** foi purgado, **quando** e **por quem**; falha de purge deve **bloquear** tráfego.

---

## 7) Propagação & sincronização (Z5 → Z6/Z7/Z9)

* **Webhooks/Bus**: o Registry emite `revoked`, `quarantined`, `alias_updated`.
* **Watchers** na Z6: param *rollouts*, abortam *startup*, e forçam **reload de políticas**.
* **Denylists temporárias** no Gateway até caches confirmarem purge.
* **Z9**: painéis com linha do tempo (T0…T+N), contadores de requisições bloqueadas, e sucesso do purge.

---

## 8) Policy-as-Code (exemplos Rego)

**Bloquear consumo (`Revoked`/`Quarantined`)**

```rego
package registry.download
default permit = false
permit {
  input.stage in {"Staging","Approved"}
  not input.revoked
  not input.quarantined
  input.policy_digest == input.runtime.policy_digest
}
```

**Revogação por CVE crítica (SBOM)**

```rego
package registry.revoke
should_revoke {
  input.sbom.has_blocking_cves
}
```

**Auto-hold por drift**

```rego
package runtime.guard
hold {
  input.monitoring.drift_psi > 0.2
}
```

---

## 9) Auditoria, evidências & retenção

* **INC-ID/CHG-ID** vinculados ao evento.
* *Decision logs* (OPA), *who/what/when/why/from*.
* **Snapshots**: `release_manifest`, `policy_snapshot`, métricas antes/depois, amostras de requests (sem PII).
* **Retenção**: logs/evidências em **WORM** pelo prazo regulatório (ex.: 5 anos).

---

## 10) Checklists operacionais

### 10.1 Revogação rápida

* [ ] Setar `Revoked` no Registry
* [ ] Emitir `model.revoked` e notificar times
* [ ] **Purgar caches** (gateway, serving, vector, CDN)
* [ ] Remover/ajustar **alias** `production`
* [ ] Pausar batch e marcar outputs pós-T0
* [ ] Abrir **INC-ID**, iniciar forense, registrar tudo no Z9

### 10.2 Quarentena

* [ ] Setar `Quarantined` + **TTL**
* [ ] Copiar artefatos/logs para *bucket forense* (**WORM**)
* [ ] Restringir acessos (RBAC/ABAC)
* [ ] Definir critérios de saída (confirmar/limpar)
* [ ] Atualizar SCDR com risco preliminar

### 10.3 Rollback

* [ ] Identificar `Approved` anterior e **pre-warm**
* [ ] Atualizar **alias** `production`
* [ ] Purge completo
* [ ] Validar SLOs & métricas de negócio
* [ ] Comunicar conclusão + lições aprendidas

---

## 11) Riscos × Controles × Frameworks

| Risco                                      | Controle                                           | Referências                            |
| ------------------------------------------ | -------------------------------------------------- | -------------------------------------- |
| Continuidade de uso de versão comprometida | `Revoked` + **startup/download gate** + purge      | NIST SP 800-53 **SI-4**, **CM-3/CM-4** |
| Contaminação de evidências                 | **Quarentena** com **WORM** e RBAC restrito        | NIST **AU-9**, ISO 27037 (forense)     |
| Backout incompleto                         | **Rollback** via **alias** + validação pós-mudança | ITIL Change, NIST **CM-3**             |
| Drift/violação LGPD em produção            | **Runtime guard** + demotion/quarentena            | NIST AI RMF (Manage/Measure), LGPD     |
| Purge incompleto (stale cache)             | Playbook de **purga multi-camada** + auditoria     | SRE/SOC runbooks                       |

---

## 12) Frases prontas (entrevista)

> “Tratamos **revogação** como *kill-switch* operado pelo Registry: muda para `Revoked`, emite evento, a Z6 **bloqueia startup/download** e executamos **purga de cache** em gateway/serving/vector/CDN. Se a evidência não é conclusiva, usamos **Quarentena** com **WORM** e acesso mínimo. O **Rollback** é via **alias** para a última `Approved` saudável, com validação pós-backout. Tudo fica **auditado** no Z9 e amarrado a **INC/CHG IDs**.”
