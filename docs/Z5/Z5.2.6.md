# Z5-2.6 — **Acesso & Tenancy (IAM/ABAC)**

*“quem pode fazer **o quê**, **em qual recurso**, **em qual contexto** — com segregação de funções e trilha de auditoria”*

---

## 1) Objetivo & Escopo

Garantir que **todas** as operações do Registry (ler, registrar, promover, revogar, fazer download, vincular políticas, etc.) respeitem:

* **Mínimo privilégio** (least privilege),
* **Segregação de funções** (SoD / *four-eyes*),
* **Isolamento por tenant/domínio/ambiente** (multi-tenant),
* **Condições de contexto** (região, finalidade LGPD, sensibilidade de dados).

Modelo híbrido **RBAC + ABAC**:

* **RBAC** define *quem* (papéis).
* **ABAC** decide *quando/onde* (atributos no token e no recurso).

---

## 2) Identidades (quem opera o Registry)

**Humanas**

* `Admin` (gestão do serviço, não promove versão)
* `Security` (pode **revogar**, co-aprovar promoções)
* `ProductOwner` (co-aprova promoções)
* `Auditor` (somente leitura e trilhas)

**Técnicas (service accounts)**

* `CI/CD` (registra versões **Candidate** – *Registrar*)
* `PolicyBot` (executa OPA, vincula **policy_snapshot**)
* `Serving(Z6)` (baixa **Approved/Staging**, verifica políticas)
* `BatchOrchestrator` (resolve versão para *batch inference*)

**Parceiros internos/externos**

* `ConsumerApp` (metadados somente leitura)
* (Opcional) `PartnerOps` (somente leitura em escopos específicos)

> Todas as identidades **OIDC/OAuth2** (Keycloak/IdP), tokens **curto-vivos**, sem credenciais fixas.

---

## 3) Atributos (ABAC) — exemplos de *claims* no token

* `tenant_id`: `banking`, `wealth`, `insurance`
* `env`: `dev|staging|prod`
* `domain`: `risk|fraud|credit|llm`
* `region`: `br|eu|us`
* `purpose`: `concessao_credito`, `prevencao_fraude` (LGPD)
* `data_sensitivity`: `public|internal|confidential|restricted`
* `role`: `admin|security|product|auditor|registrar|promoter|consumer`
* `subject`: identidade única (para SoD)

> O recurso também tem atributos: `resource.tenant_id`, `resource.env`, `resource.domain`, `resource.model_name`, `resource.stage`.

---

## 4) Matriz de ações × papéis (com condições ABAC)

| Ação (Registry)               | Quem (RBAC)                                                | Condições ABAC (exemplos)                                                                                  |
| ----------------------------- | ---------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| `models:list/read`            | `auditor`,`consumer`,`security`,`product`,`admin`          | `token.tenant_id == resource.tenant_id`                                                                    |
| `versions:create (Candidate)` | `registrar` (CI/CD)                                        | `env in {"dev","staging","prod"}` **e** `token.domain == resource.domain`                                  |
| `versions:promote → Staging`  | `promoter` (pipeline)                                      | *Gate PASS* + `policy_snapshot.bound` **e** `SoD` válido                                                   |
| `versions:promote → Approved` | `promoter` **com** co-aprovação `security` **e** `product` | `canary.result=="PROCEED"` **e** `env=="prod"` **e** janela de revalidação definida                        |
| `versions:revoke`             | `security`                                                 | Motivo obrigatório + evento Z9; bloqueia consumo                                                           |
| `artifacts:download` (Z6)     | `serving`                                                  | `stage in {"Staging","Approved"}` **e** `token.tenant_id == resource.tenant_id` **e** `policy_digest` bate |
| `policies:bind`               | `policybot`                                                | *snapshot assinado*; grava `policy_digest` como *tag*                                                      |
| `aliases:update`              | `promoter`                                                 | Apenas em `env=="prod"`; auditar *quem/quando/por quê*                                                     |

> **SoD**: `created_by != approved_by` e chaves de assinatura separadas.

---

## 5) Exemplo de **token JWT** (resumo)

```json
{
  "sub": "svc-ci-github@corp",
  "role": ["registrar"],
  "tenant_id": "banking",
  "env": "prod",
  "domain": "risk",
  "region": "br",
  "purpose": ["concessao_credito"],
  "exp": 1762900000,
  "iss": "https://idp.corp/realms/mlops"
}
```

---

## 6) Políticas OPA/Rego (amostras)

### 6.1 Download por Z6 (somente versões servíveis, com isolamento)

```rego
package registry.authz.download
default allow = false

allow {
  input.action == "artifacts:download"
  input.requester.role == "serving"
  input.resource.stage == "Approved"  # ou "Staging" em ambientes controlados
  input.requester.tenant_id == input.resource.tenant_id
  input.runtime.policy_digest == input.resource.policy_digest
}
```

### 6.2 Promoção exige **dupla aprovação** e **SoD**

```rego
package registry.authz.promote
default allow = false

allow {
  input.action == "versions:promote"
  input.meta.stage_from == "Staging"
  input.meta.stage_to == "Approved"
  input.approvals.security == true
  input.approvals.product  == true
  input.resource.created_by != input.approvals.security_by  # SoD
  input.resource.created_by != input.approvals.product_by   # SoD
}
```

### 6.3 Isolamento por **finalidade LGPD**

```rego
package registry.authz.purpose
default allow = false

allow {
  input.action == "artifacts:download"
  some p
  p := input.requester.purpose[_]
  p == input.resource.model_card.purpose.allowed[_]
}
```

---

## 7) Integração com **IdP/Vault/KMS**

* IdP (Keycloak): *mappers* para emitir *claims* ABAC no JWT (tenant/domain/env/purpose).
* Vault/KMS: guarda chaves de **assinatura** (cosign/KMS), com **rotação** e **SoD** (quem usa ≠ quem administra).
* **Workload Identity / OIDC**: CI/CD e Z6 obtêm tokens **curto-vivos** (minutos), sem segredo estático.

---

## 8) Particionamento & Isolamento de dados

* Namespace lógico dos recursos: `/tenants/{tenant}/domains/{domain}/models/{model}/versions/{v}`.
* **Storage** segregado por *tenant* (prefixos/buckets distintos com políticas de bucket).
* **Índices** no banco de metadados filtram por `tenant_id` **por padrão** (toda query é *scoped*).

---

## 9) Segurança operacional

* **TTL** curto para tokens; *refresh* via IdP; **revogação** honrada.
* **mTLS** entre Registry e clientes internos (Z6/CI/CD).
* **Headers** de segurança nas UIs (se expostas) e proteção por OIDC (SSO).
* **Rate limit** por identidade para evitar abuso (mesmo em rede interna).

---

## 10) Auditoria & Observabilidade (Z9)

Registrar **sempre**:

* `who` (subject), `what` (ação), `on` (recurso), `decision`, `why` (regra/razão), `from` (IP/Workload), `when`.
* *Decision logs* do OPA (com *redaction*), *correlação* com eventos de promoção/revogação.
* Alertas: tentativas de **cross-tenant**, token **expirado**, **mismatch** de `policy_digest`.

---

## 11) Mapeamento a frameworks

* **NIST SP 800-53**: AC-2 (contas), AC-3 (enforcement), AC-6 (least privilege), AC-17 (remoto), IA-2/IA-5 (autenticação), CM-6/CM-7 (políticas), AU-2/AU-12 (auditoria).
* **CSA CCM**: **IAM**, **SEF**, **LOG**.
* **ISO/IEC 27001**: A.9 (controle de acesso), A.12 (operações), A.18 (compliance).
* **NIST AI RMF** (Govern/Manage): accountability e controles de acesso ligados a finalidade.

---

## 12) Runbooks (falhas comuns)

* **“Access denied” para promoção** → checar *approvals* (security/product), SoD (criador ≠ aprovadores), *claims* do token.
* **Z6 não consegue baixar versão** → verificar `stage`, *tenant match*, validade do token, `policy_digest` divergente.
* **Parceiro vendo modelo errado** → revisar *mappers* do IdP (tenant/domain), incluir `aud`/`azp` corretos.
* **CI/CD não consegue registrar** → token expirado, `role` ausente (`registrar`), política de *namespace* não coincide.

---

## 13) Frase pronta (entrevista)

> “No Registry aplico **RBAC+ABAC**: papéis limitam o *tipo* de ação e atributos no token (tenant, domínio, ambiente, finalidade) limitam **onde/quando**. **SoD** impede que quem criou aprove; promoção para `Approved` exige **duas aprovações**. O **Z6** só baixa versões `Approved/Staging` do **mesmo tenant**, com **`policy_digest`** conferindo. Tudo com **tokens curto-vivos OIDC**, chaves em **KMS/Vault**, **mTLS** e **trilhas de decisão** no Z9.”
