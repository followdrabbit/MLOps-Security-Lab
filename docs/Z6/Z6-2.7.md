# Z6-2.7 — Scored Output Access API

*(Operational/Analytical Views • ABAC/Field-Level Masking • Pagination • Webhooks/CDC • SLO & Cost Controls)*

## 1) Papel e posicionamento

A **Scored Output Access API** é a **única interface de leitura** das saídas de inferência armazenadas na **Z6-2.6 (Scored Output Store)**. Ela entrega **visões operacionais** (ex.: “último score por cliente”) e **analíticas** (ex.: “histórico por janela”), aplicando **AuthN/AuthZ fortes**, **mascaramento de campos**, **contratos de schema**, **paginação** e **observabilidade**.

> Objetivo: permitir que **Z7 (Core/Risk/Fraud/Apps)** consuma resultados **sem acesso direto ao bucket/tabela**, com **governança, privacidade e SLO**.

---

## 2) Capacidades obrigatórias

### 2.1 Autenticação & Autorização (ABAC + field-level)

* **AuthN**: OIDC/OAuth2 (client-credentials) e, quando serviço-a-serviço, **mTLS**.
* **AuthZ (ABAC)**: por **tenant/área/modelo/versão/rota**, com **field-level masking** e **row-level filtering**.
* **Perfis** comuns:

  * `core-banking`: leitura **operacional** de “última predição por entidade” (somente campos mínimos).
  * `risk-analyst`: leitura **analítica** (histórico) com **explanations** quando permitido.
  * `fraud-engine`: acesso a **janelas curtas** (últimas N horas) com limites de taxa.
* **Nada de hardcoded secrets**; segredos via **Vault**.

### 2.2 Contratos de API e schemas

* **OpenAPI** versionado (**/v1**, **/v2**).
* **Schemas fixos** por rota; **validação** de parâmetros (tipos, ranges, regex) e **envelope** de resposta padronizado:

  ```json
  { "meta": { "request_id": "...", "page": 2, "page_size": 200, "total": 3942 }, "items": [ ... ] }
  ```
* **Datas/tempos** em **UTC ISO-8601**; **entity_key** sempre **tokenizada/HMAC**.

### 2.3 Visões suportadas (views)

* **Operational View** — *lookup* rápido:

  * `GET /api/scored/v1/last?tenant=...&entity=...&model=...&major=...`
  * Retorna **uma** linha por entidade (última `as_of_out` válida + metadados).
* **Analytical View** — histórico:

  * `POST /api/scored/v1/search` com filtros (tenant, janela temporal, modello/versão, faixa de score).
  * Paginado; ordering por `as_of_out`.
* **Explainability View** (condicional):

  * `GET /api/scored/v1/explanations?tenant=...&entity=...&model=...&as_of_out=...`
  * Retorna **explanations resumidas** (ex.: SHAP binarizado/compactado) quando **policy permitir**.
* **Aggregations** (pré-definidas):

  * `GET /api/scored/v1/metrics?window=1d&model=...` (médias, p95, taxas de aprovação, etc.) — **sem dados por entidade**.

### 2.4 Paginação, limites e ordenação

* **page/page_size** com **limite máximo** (ex.: 1k registros/página).
* **Rate limit** por identidade/rota; **quotas** (diárias/mensais) por **custo de leitura**.
* **Sort** controlado (ex.: `as_of_out desc`) e **time-slicing** (cursores `since_id`/`since_ts`).

### 2.5 Máscara/Redação de campos sensíveis

* **Field-level masking** conforme papel/tenant:

  * `entity_key` → tokenizada (mostrar parcial opcional `****1234`).
  * `explanations` → só para `risk-analyst`; demais recebem `null`.
  * `runtime_meta` → subset (latência/SLO), nunca hostnames/IPs internos.
* **Nenhum PII bruto** sai pela API.

### 2.6 CDC / Webhooks / Streaming

* **Eventos de disponibilidade** após **commit atômico** (Z6-2.6):

  * `POST /webhooks/scored` (configurado por cliente) **ou** publicação em **Kafka/MQ** (`topic: scored.available`).
* **Pull seguro**: `since_ts` para coleta incremental.
* **Idempotência do consumidor**: `idempo_key` presente no payload.

### 2.7 SLOs, performance e cache

* **SLO**: p95/p99 de latência por rota; **timeouts** e **limites** por consulta.
* **Cache**:

  * *In-memory* (TTL curto) para **last**,
  * cache distribuído (Redis) para consultas quentes,
  * **ETags**/**If-None-Match** para GETs idempotentes.
* **Hot store** (opcional) para *lookups* operacionais (ex.: Postgres/KeyDB/ClickHouse) sincronizado do **Scored Output**.

### 2.8 Observabilidade e auditoria

* **Logs estruturados** (sem payload sensível): `request_id`, `tenant`, `route`, `filters_hash`, `items`, `latency_ms`, `status`.
* **Métricas**: QPS, p95/p99, taxa de erro, page_size médio, custo estimado.
* **Tracing** end-to-end; **Z9** como destino.

### 2.9 Governança e ciclo de vida

* **Versionamento** de rotas/schemas (depreciação com janela).
* **Aprovação** de novos campos (ADR/SCDR) + **catálogo** atualizado.
* **Retenção**: logs de acesso com **minimização** + política LGPD.

---

## 3) Fluxos de referência

### 3.1 Consulta operacional (last)

1. `core-banking` chama `GET /last` com `tenant`, `entity`, `model`.
2. API valida **AuthN/AuthZ**, aplica **masking**, busca em **hot store/cache**.
3. Retorna **último score** com `model_version`, `as_of_in/out`, `policy_digest`.
4. Registra métricas/logs; envia **trace** para Z9.

### 3.2 Consulta analítica (histórico)

1. `risk-analyst` envia `POST /search` com janela `2025-11-01..2025-11-13`, `model=churn`, `tenant=X`.
2. API valida filtros, pagina, consulta base colunar (Parquet/Iceberg/Hudi) **sem PII**.
3. Retorna página 1/…; cliente usa cursor para próximas páginas.

### 3.3 Evento de disponibilidade

1. Z6-2.6 conclui **commit** do lote `dt=2025-11-12`.
2. Emite **webhook** assinado para assinantes ou publica em **topic**.
3. Consumidor busca via `since_ts` mantendo **idempotência**.

---

## 4) Políticas — exemplos (pseudo-Rego)

### 4.1 ABAC por rota (operacional × analítica)

```rego
package scored.api.authz
default allow = false

allow {
  input.route == "/api/scored/v1/last"
  input.claims.role == "core-banking"
  input.tenant == input.claims.tenant
}

allow {
  input.route == "/api/scored/v1/search"
  input.claims.role == "risk-analyst"
  input.tenant == input.claims.tenant
}
```

### 4.2 Field-level masking

```rego
package scored.api.mask
mask[field] {
  field == "entity_key"
}
mask[field] {
  field == "explanations"
  input.claims.role != "risk-analyst"
}
```

### 4.3 Limites de janela

```rego
package scored.api.window
default ok = false
ok {
  # janela máxima de 90 dias por requisição
  input.to - input.from <= 90*24*60*60
}
```

---

## 5) Exemplos de implementação (trechos)

### 5.1 Esqueleto OpenAPI (resumo)

```yaml
openapi: 3.0.3
info: { title: Scored Output API, version: "1.0.0" }
paths:
  /api/scored/v1/last:
    get:
      parameters:
        - in: query; name: tenant; schema: { type: string }; required: true
        - in: query; name: entity; schema: { type: string }; required: true
        - in: query; name: model;  schema: { type: string }; required: true
        - in: query; name: major;  schema: { type: integer }
      responses:
        "200": { description: OK }
  /api/scored/v1/search:
    post:
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [tenant, model, from, to]
              properties:
                tenant: { type: string }
                model:  { type: string }
                from:   { type: string, format: date-time }
                to:     { type: string, format: date-time }
                page:   { type: integer, minimum: 1 }
                page_size: { type: integer, maximum: 1000 }
      responses:
        "200": { description: OK }
```

### 5.2 Nginx (camada externa — trechos)

```nginx
server {
  listen 443 ssl http2;
  server_name scored.example.bank;

  # TLS/mTLS...

  location /api/scored/v1/ {
    client_max_body_size 256k;
    # JWT forward-auth (IdP)
    proxy_pass http://scored-api-backend;
    # Rate-limit por rota/identidade (map/zone)
    # Security headers (HSTS, no-sniff, frame-deny)
  }
}
```

### 5.3 Exemplo de resposta (operacional)

```json
{
  "meta": { "request_id": "b3e9...", "page": 1, "page_size": 1, "total": 1 },
  "items": [{
    "tenant_id": "retail-br",
    "entity_key": "****3a1f",             // tokenizado/masked
    "model_name": "churn",
    "model_version": "2.3.1",
    "model_digest": "sha256:...",
    "score": 0.83,
    "decision": "monitor",
    "as_of_in": "2025-11-12T23:59:59Z",
    "as_of_out": "2025-11-13T00:01:12Z",
    "policy_digest": "sha256:..."
  }]
}
```

---

## 6) Checklists operacionais

**Antes do go-live**

* [ ] **OpenAPI** publicado; **contratos** versionados.
* [ ] **ABAC/field-masking** testados (positivo/negativo).
* [ ] **Rate-limit/quotas** por rota/identidade; limites de **janela**.
* [ ] **Cache/hot-store** para `last`; **paginação** e **ETags**.
* [ ] **Webhooks/CDC** com assinatura e reentrega (DLQ).
* [ ] **Logs/métricas/tracing** integrados à **Z9** (sem PII).

**Durante operação**

* [ ] Monitorar **p95/p99**, taxa de erro e **custo** por consumidor.
* [ ] Alertas para **spikes** de páginas grandes / janelas extensas.
* [ ] Revisão periódica de **acessos** (quem lê, o que e por quê).
* [ ] Depreciações comunicadas e **guardadas** (feature flags).

---

## 7) Riscos × Controles (recorte da API)

| Risco                              | Controles na Scored Output Access API                                 |
| ---------------------------------- | --------------------------------------------------------------------- |
| Bypass/Leitura direta do bucket    | **API única**; buckets/tabelas sem permissão de leitura para apps     |
| Vazamento de PII/segredos          | **Field-level masking**, tokenização/HMAC, minimização                |
| Exploração via consultas pesadas   | **Rate-limit, quotas, paginação, limites de janela**                  |
| Enumeração/cross-tenant            | **ABAC** por tenant/rota; filtros obrigatórios; *row-level filtering* |
| Inconsistência/“leituras fantasma” | **Commit atômico**, cursores `since_ts`, ETags, *read-after-commit*   |
| Falta de rastreabilidade           | Logs estruturados, `request_id`, tracing, **Z9**                      |

---

## 8) Integrações

* **Z6-2.6 (Scored Output Store):** fonte de verdade; a API aplica masking/contratos.
* **Z7 (Consumers):** Core/Risk/Fraud/Apps consomem **somente via API**.
* **Z8 (IAM/Vault/KMS/DLP):** identidade, segredos, chaves para HMAC/tokenização, políticas de DLP.
* **Z9 (Monitoring & Audit):** observabilidade, trilhas, reconciliações.

---

## 9) Frases prontas (entrevista)

* “**Ninguém lê direto do bucket**: Z7 consome **apenas via Scored Output Access API**, com **ABAC** e **field-level masking**.”
* “Para operação, expomos `GET /last` (p95 baixo); para análise, `POST /search` paginado — **mesmo schema, políticas diferentes**.”
* “Publicamos **webhooks/CDC** depois do **commit atômico**; consumidores usam `since_ts` com **idempotência**.”
* “Controlamos **custo e abuso** com **rate-limit/quotas**, limites de janela e **SLOs** por rota/modelo.”
