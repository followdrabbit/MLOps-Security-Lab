# Z6-2.8 — Traffic Shaping & Safe Release

*(Canary • Shadow/Replay • A/B • Segmentação por Tenant/Região • Kill Switch • Orçamentos de Exposição)*

## 1) Papel e posicionamento

Este componente comanda **como** o tráfego de inferência é distribuído entre **versões de modelos/serviços** em produção. Ele permite **lançar com segurança** (progressivamente), medir impacto e **reverter instantaneamente** sob desvios de qualidade, custo ou SLO.

> Objetivo: “**mudar o motor com o avião voando**”, mas com **guardrails** — tráfego controlado, observabilidade rica e **políticas** que evitam danos a clientes/negócio.

---

## 2) Capacidades obrigatórias

### 2.1 Roteamento ponderado (Canary/Blue-Green)

* **Pesos por versão** (ex.: v2 = 5%, v1 = 95%).
* **Granularidades**: global → por **tenant/canal/região/feature flag**.
* **Progressão automática** condicionada a **SLOs/qualidade**.

### 2.2 Shadow/Dark Launch (avaliação sem impacto)

* **Cópia do tráfego** para a nova versão (v2) **sem afetar a resposta** ao cliente.
* **Comparação offline** de métricas (score drift, latência, custo, erros).
* **Amostragem** configurável (ex.: 1–10%).

### 2.3 A/B testing (controle científico)

* **Randomização** estável (por entidade/cliente) para evitar *switching*.
* **Hipóteses** e **métricas de sucesso** definidas (uplift, perda aceitável).
* **Janela** e **tamanho de amostra** mínimos antes de decidir promoção.

### 2.4 Segmentação por risco/valor

* **White/blacklist** de **tenants/regiões/produtos** (ex.: clientes VIP ficam no estável).
* **Exceções** para domínios regulados/sensíveis.
* **Orçamentos de exposição** (máx. N requisições ou % receita).

### 2.5 Kill Switch & rollback instantâneo

* **Flag** por **modelo/versão/tenant/canal** com **propagação rápida** (segundos).
* Reversão automática ao detectar **violação de SLO**/**pico de erro**/**desvio de métrica**.

### 2.6 Políticas como código (gate de promoção)

* **Critérios mínimos** antes de aumentar peso: p95, taxa de 5xx, custo/token, métricas de negócio, *drift/PSI*.
* **Promoção automática** quando todos os critérios forem “OK”; **reversão** caso “ALERTA/CRÍTICO”.

### 2.7 Observabilidade e auditoria de release

* **Métricas por braço** (v1 vs v2): latência, erro, custo, distribuição de `score`.
* **Cardinality keys**: `tenant`, `region`, `model`, `version`, `route`.
* **Audit trail**: quem alterou pesos/flags, quando e por qual justificativa (ADR/SCDR).

### 2.8 Segurança e conformidade

* **Roteamento só entre modelos “Approved (Z5)”**.
* **Sem shadow** para dados **proibidos** (soberania, LGPD, cláusulas contratuais).
* **Masking/PII rules** mantidas também no caminho shadow.

---

## 3) Fluxos de referência

### 3.1 Canary progressivo

1. Inicia v2 com **5%** (segmentos de baixo risco).
2. **Z9** monitora SLOs/qualidade/custo.
3. Se “OK” por `X` horas → **25%** → **50%** → **100%**.
4. Qualquer violação → **Kill Switch** (0%) e **rollback** → abrir ADR com análise.

### 3.2 Shadow com replay

1. Copia requisições de v1 → v2 (shadow).
2. Armazena **pares (input, output_v1, output_v2)** (sem PII) e **deltas** de score.
3. Se deltas dentro do **limite contratado** e SLO/custo OK → promover para canary.

### 3.3 A/B (randomização)

1. Geração de **seed** por `entity_key_hmac` → aloca em A ou B (v1/v2).
2. Agrega resultados e calcula **uplift**; respeita janelas mínimas.

---

## 4) Políticas — exemplos (pseudo-Rego)

### 4.1 Gate de promoção por SLO/custo/qualidade

```rego
package serving.traffic.promotion
default promote = false

promote {
  input.window_hours >= 2
  input.metrics.v2.p95_ms <= input.slo.p95_ms
  input.metrics.v2.error_rate <= input.slo.error_rate
  input.metrics.v2.cost_per_1k_tokens <= input.budget.max_cost_per_1k
  abs(input.metrics.v2.avg_score - input.metrics.v1.avg_score) <= input.quality.max_score_delta
}
```

### 4.2 Kill Switch automático

```rego
package serving.traffic.killswitch
default cut = false

cut {
  input.metrics.v2.error_rate > input.thresholds.critical_error_rate
} 
cut {
  input.metrics.v2.p95_ms > input.thresholds.critical_latency_ms
}
```

### 4.3 Segmentação/Exceções

```rego
package serving.traffic.segments
allow_canary {
  not input.tenant in {"vip_retail","regulated_fx"}
  input.region in {"BR","LATAM"}
}
```

---

## 5) Exemplos de implementação (trechos)

### 5.1 Istio — roteamento ponderado

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata: { name: churn-serving }
spec:
  hosts: ["churn.internal.svc"]
  http:
  - match:
    - headers:
        x-tenant:
          exact: "retail-br"
    route:
    - destination: { host: churn, subset: v1 }
      weight: 95
    - destination: { host: churn, subset: v2 }
      weight: 5
```

### 5.2 Envoy — shadow traffic

```yaml
route_config:
  name: local_route
  virtual_hosts:
  - name: churn
    domains: ["*"]
    routes:
    - match: { prefix: "/predict" }
      route:
        cluster: churn-v1
        request_mirror_policies:
        - cluster: churn-v2   # shadow
          runtime_fraction: { default_value: { numerator: 10, denominator: HUNDRED } }
```

### 5.3 Feature flag (exemplo simples)

```json
{
  "model:churn": {
    "canary_weight": 5,
    "kill": false,
    "blocked_segments": ["vip_retail","regulated_fx"]
  }
}
```

---

## 6) Checklists operacionais

**Antes do canary**

* [ ] v2 **Approved (Z5)**, com **digest/assinatura**.
* [ ] **Shadow** rodou e comparativos “OK”.
* [ ] **SLOs**, **thresholds** e **orçamentos** definidos.
* [ ] Dashboards por **versão/tenant/região** prontos.
* [ ] **Kill Switch** testado (tabletop + ambiente).

**Durante canary**

* [ ] Monitorar **p95/p99**, **5xx**, **custo**, **score delta** vs v1.
* [ ] **Alertas** configurados; promoção automática exige “OK” contínuo.
* [ ] **Exceções** aplicadas (VIP/Regulado fora do canary).

**Rollback**

* [ ] 1-click (flag/peso=0); **mensagem de incidente** + **ADR** de causa/ação.
* [ ] Marcar v2 como “**revoked**” no Registry se necessário.

---

## 7) Riscos × Controles

| Risco                                | Controle                                                              |
| ------------------------------------ | --------------------------------------------------------------------- |
| Degradar produção com versão ruim    | **Shadow → Canary progressivo**, gates por SLO/qualidade/custo        |
| Impactar clientes VIP/regulados      | **Segmentação/Exceções** fora do canary                               |
| Aumento de custo/tokens inesperado   | **Orçamento de exposição**, métricas por braço, promoção condicionada |
| Dano persistente antes de detectar   | **Kill Switch** instantâneo + rollback                                |
| Falta de rastreabilidade de mudanças | **Audit trail** de pesos/flags + ADR/SCDR                             |

---

## 8) Integrações

* **Z5 (Registry)**: só versões **Approved** participam de canary/AB.
* **Z6-2.1 (Inference Gateway)**: aplica **pesos**, **segmentação** e **shadow**.
* **Z6-2.3 (Serving)**: expõe **/healthz**, **versão/digest** e métricas por instância.
* **Z9 (Monitoring & Audit)**: dashboards comparativos, alertas e trilhas de mudança.

---

## 9) Frases prontas (entrevista)

* “Lançamos modelo via **shadow → canary progressivo**, com **gates de promoção** por SLO/qualidade/custo.”
* “Clientes **VIP/regulados** **não** entram em canary; temos **orçamentos de exposição** e **kill switch** instantâneo.”
* “Toda alteração de peso/flag fica em **audit trail** e gera **ADR**; rollback é **1-click**.”
