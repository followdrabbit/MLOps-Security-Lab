# Z7-2.2 — Canais & Apps Internos (Portais, Back-office, APIs de Produtos)

*(UI privacy-by-default • BFF/SDK • OIDC/mTLS • ABAC/Row/Field masking • Sem leitura direta de storage)*

## 1) Papel e posicionamento

“Canais & Apps Internos” são **interfaces e serviços de experiência** (portais, back-office, APIs de produtos, apps internos) que **consomem modelos com governança**, apoiam **operações humanas** (adjudicação/HITL) e **exponham decisões** a times internos — **sempre** via **Z6** (Inference/LLM Gateway e Scored Output Access API), **nunca** direto de buckets/tabelas.

---

## 2) Capacidades obrigatórias

### 2.1 Identidade, SSO e sessão

* **AuthN** por **OIDC/OAuth2** (Keycloak/IdP).
* **SPAs**: **PKCE** + tokens **curto-vivos**; **refresh rotation**.
* **mTLS** em chamadas **serviço→serviço** (BFF → Z6).
* **Step-up** para ações sensíveis (aprovar alto valor, liberar dados críticos).

### 2.2 Autorização (ABAC) e segregação de tenants

* **ABAC** por **tenant/área/rota/modelo**; **row-level filtering** em consultas.
* **Field-level masking** (ex.: esconder `entity_key`, *explanations* só para perfis autorizados).
* **Separação de funções** (operador vs auditor vs admin).

### 2.3 BFF/SDK e contratos

* Padrão **Backend-for-Frontend (BFF)**: o **front** fala **apenas com o BFF**; o BFF fala com **Z6**.
* **SDK interno** padroniza Auth, **retries**, idempotência, **telemetria** e **masking**.
* **OpenAPI versionado** (v1/v2) para estabilidade e depreciação guiada.

### 2.4 Privacidade por padrão (LGPD)

* **Minimização**: mostrar **só** o necessário à decisão.
* **Masking/redaction** em UI e **logs sem PII**.
* **Propósito declarado** por rota/tela; **retenção** e **expurgo** na UI (ex.: “limpar” dados após N minutos).

### 2.5 Consumo seguro de modelos (ligação com Z6)

* **Online**: chamadas a **Inference Gateway (Z6-2.1)** / **LLM Security Gateway (Z6-2.2)**.
* **Leitura**: **Scored Output Access API (Z6-2.7)** para `/last` e `/search`.
* **Proibido**: ler buckets/DBs diretamente; baixar dumps brutos para a UI.

### 2.6 Segurança de entrada (forms e chamadas)

* **Validação server-side** + client-side (defesa em profundidade).
* **CSRF** (se sessão via cookie), **anti-XSS** (escape + **CSP** estrita), **rate-limit** por usuário/rota, **anti-automation** em endpoints sensíveis.
* **Uploads** (KYC, anexos): **não** passam pelo BFF — são **redirecionados** para **Z1 (Ingestion & Security Gateway)**.

### 2.7 Erros, mensagens e UX resiliente

* Mensagens de erro **genéricas** (sem dados internos); **códigos** e **correlação** (`request_id`).
* **Circuit breakers** e **fallback** visível (ex.: “modo degradado / última decisão disponível”).

### 2.8 Segredos, tokens e configuração

* **Zero secrets no front**; tokens em **cookies httpOnly + SameSite** (ou **token in-memory** para SPAs).
* Mobile: **Keystore/Secure Enclave**.
* Chaves **rotacionadas**; **Feature Flags** para ativar rotas/camadas.

### 2.9 Observabilidade e custo

* **RUM** (erros JS, latência de tela) + métricas do BFF (p95/p99, erro, *cache hit*).
* **Tracing E2E**: UI → BFF → Z6 → Serving → Store; envio à **Z9**.
* **Quotas/custos** para rotas LLM (limites por equipe/tenant).

### 2.10 Acessibilidade & conformidade

* **A11y** (WAI-ARIA), **auditoria de acessos** e **registros** de justificativa (quando há revisão humana).
* **Mensagens neutras** (evitar viés explícito na UI).

---

## 3) Fluxos de referência

### 3.1 Portal Operacional — “último score”

1. Operador abre caso → BFF chama **`GET /api/scored/v1/last`** (Z6-2.7).
2. **ABAC + masking** aplicados; UI exibe `score`, `model_version`, `as_of_in/out`, **sem PII**.
3. Operador aplica **regras** e grava **decisão** no domínio do Core/Back-office.

### 3.2 Adjudicação (HITL) com explicabilidade controlada

1. Caso “hold” cai no Back-office.
2. BFF solicita **explanations** (Z6-2.7) **se papel permitir**.
3. Operador registra justificativa; trilha segue para **Z9**.

### 3.3 Chat interno / GenAI

1. UI envia prompt ao **LLM Security Gateway** (Z6-2.2) via BFF.
2. **Input/Output filtering, PII masking, tool allowlist**; resposta volta sanitizada.

### 3.4 Upload KYC

1. Usuário seleciona arquivo; **BFF retorna URL de upload** da **Z1**.
2. Upload acontece **diretamente** na Z1 (WAF + AV/CDR + sandbox).
3. BFF recebe **webhook** de sucesso e atualiza o caso.

---

## 4) Políticas — exemplos (pseudo-Rego)

### 4.1 UI só consome via BFF (nunca direto Z6)

```rego
package z7.ui.bff
default allow_direct = false
allow_via_bff {
  input.client == "ui"
  input.target == "bff"
}
```

### 4.2 Masking por papel

```rego
package z7.ui.mask
mask[field] { field == "entity_key" }
mask[field] { field == "explanations"; input.claims.role != "risk-analyst" }
```

### 4.3 Uploads só pela Z1

```rego
package z7.upload
default permit = false
permit {
  input.route == "/upload"
  input.presigned_target == "z1-ingestion"
}
```

---

## 5) Exemplos de implementação (trechos)

### 5.1 BFF (Node/Express) — OIDC + chamada `/last`

```javascript
import express from "express";
import { auth, requireAuth } from "./oidc.js"; // middleware OIDC (PKCE/client-creds)
import { scoredApi } from "./sdk-z6.js";       // SDK padronizado

const app = express();
app.use(auth());

app.get("/cases/:tenant/:entity/last", requireAuth("scored:last:read"), async (req, res) => {
  const { tenant, entity } = req.params;       // entity = HMAC/tokenizado
  const data = await scoredApi.getLast({ tenant, entity, model: "churn" });
  // masking adicional no BFF (defesa em profundidade)
  delete data.runtime_meta?.internal_host;
  res.json({ score: data.score, model_version: data.model_version, as_of_out: data.as_of_out });
});

app.listen(8443);
```

### 5.2 Headers de segurança (reverse proxy do portal)

```nginx
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
add_header X-Content-Type-Options "nosniff"            always;
add_header X-Frame-Options "DENY"                       always;
add_header Referrer-Policy "no-referrer"                always;
add_header Content-Security-Policy "default-src 'self'; frame-ancestors 'none'; object-src 'none'" always;
```

### 5.3 Form seguro (exemplo conceitual)

* **Server-side validation**; recusar campos extras (*mass assignment*).
* **CSRF token** obrigatório (session cookie).
* **Rate-limit** por usuário/IP/rota.

---

## 6) Checklists operacionais

**Antes do go-live**

* [ ] **BFF** único; **SDK** integrado (Auth, retries, idempotência, telemetria).
* [ ] **OpenAPI** estável das rotas Z6 usadas; **feature flags** prontos.
* [ ] **ABAC/Masking/Row-level** testados (positivo/negativo).
* [ ] **CSP/HSTS/anti-XSS/CSRF** configurados; **uploads** via **Z1**.
* [ ] **RUM + tracing** até **Z9**; mensagens de erro sem dados sensíveis.

**Durante operação**

* [ ] p95/p99 por rota, taxa de erro, custo (LLM), *cache hit*.
* [ ] *Access reviews* periódicos (quem usa telas/rotas e por quê).
* [ ] Auditoria de adjudicações (HITL) e revisão de justificativas.
* [ ] Gestão de versões (UI/BFF/SDK) e depreciações com janela.

---

## 7) Riscos × Controles × Referências

| Risco típico em canais internos           | Controles em Z7-2.2                                                                           | Referências (ex.)                |
| ----------------------------------------- | --------------------------------------------------------------------------------------------- | -------------------------------- |
| XSS/CSRF/IDOR/Mass Assignment             | **CSP**, escape/validação server-side, **CSRF tokens**, checagem de **permissão por recurso** | OWASP ASVS/Top-10; OWASP API Sec |
| Vazamento de PII em UI/logs               | **Minimização**, **masking**, logs **sem payload**                                            | LGPD; NIST SC-28; CSA DSI        |
| Bypass para leitura direta de storage     | **Somente via Z6-2.7**; bloquear redes/ACLs; BFF como única porta                             | NIST SC-7/SC-39                  |
| Prompt-injection/Exfiltração (chat/GenAI) | **LLM Security Gateway** (input/output filter, tool allowlist), **no-secrets in prompt**      | OWASP LLM/GenAI; CSA AICM        |
| Uso fora do propósito (purpose creep)     | **Propósito** por rota, catálogo, *access reviews*                                            | LGPD; NIST AI RMF (Govern)       |
| Dependência frágil de APIs de inferência  | **SDK**, OpenAPI versionado, BFF, *feature flags*, *circuit breakers*                         | NIST CM-*; SRE (SLO/SLA)         |

---

## 8) Integrações

* **Z6** (Inference/LLM/Scored API) — consumo governado de modelos e saídas.
* **Z1** (uploads) — KYC/anexos passam pelo gateway seguro (WAF + AV/CDR).
* **Z8** (IAM/Vault/KMS/Catálogo) — identidade, segredos, classificação, propósito.
* **Z9** (Monitoring & Audit) — RUM, métricas do BFF, tracing, auditoria de adjudicação.

---

## 9) Frases prontas (entrevista)

* “Canais internos **nunca** leem storage: **UI → BFF → Z6**, com **ABAC** e **masking**.”
* “Uploads (KYC) **não** passam pelo BFF: vão para **Z1**, onde há **WAF + AV/CDR**.”
* “Usamos **PKCE + tokens curto-vivos** e **mTLS** no serviço; **CSP/CSRF/anti-XSS** na borda.”
* “Adjudicação (HITL) tem **explanations** somente para perfis autorizados, com **trilhas para Z9**.”
