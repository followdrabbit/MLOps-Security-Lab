# Z7-2.4 — Decisioning & Orquestração (BPM/Regras)

*(Cut-offs e bands • Regras determinísticas • HITL • Explainability controlada • Políticas como código • Auditoria & LGPD)*

## 1) Papel e posicionamento

A camada de **Decisioning & Orquestração** transforma **predições** (scores/labels) em **decisões de negócio executáveis** (aprovar/recusar/hold, limite, canal, alçada). Ela **não** “reinventa o modelo”; ela **aplica políticas** e **regras** sobre os sinais vindos da **Z6** e orquestra os passos seguintes (ex.: abrir fila de revisão, notificar sistemas, acionar BPM).

> Objetivo: **consistência, rastreabilidade e conformidade** — a mesma entrada gera a mesma decisão, com justificativas e trilha de auditoria.

---

## 2) Capacidades obrigatórias

### 2.1 Política em camadas (policy layering)

1. **Eligibility Gates (hard rules)** – regras impeditivas antes de olhar o score
   *Ex.: CPF inválido, KYC pendente, lista de sanções, idade mínima do produto.*
2. **Uso do Score** – **cut-offs e bands** por produto/tenant/campanha
   *Ex.: score ≥ 0.85 → aprova; 0.25–0.85 → “hold”; < 0.25 → nega.*
3. **Exceções regulatórias/contratuais** – regras que **sobrepõem** o score
   *Ex.: segmento regulado, limite por perfil, tempo mínimo de relacionamento.*
4. **Controles de risco/fairness** – salvaguardas de **deriva** e **equidade**
   *Ex.: se PSI > limiar ou taxa de recusa do segmento ↑ → ativa **modo conservador**.*

### 2.2 Motor de regras e/ou DMN

* Suporte a **tabelas de decisão** (DMN) e **regras declarativas** (ex.: Drools, Open Policy Agent).
* **Versionamento** e **rollbacks** de regras/políticas.
* **Testes unitários** das regras (simuladores com casos sintéticos).
* **Explainability controlada**: reason codes padronizados por decisão.

### 2.3 Orquestração de processos (BPM)

* Modelagem de **workflows** (BPMN) para **HITL** e pós-decisão (ex.: coletar documento, pendência de compliance).
* Estados: `approved`, `denied`, `hold:manual_review`, `hold:data_missing`, etc.
* **SLAs** por etapa; **retries** e compensações (sagas).

### 2.4 Identidade, escopo e propósito (LGPD)

* Decisões condicionadas a **claims** (tenant/papel).
* **Propósito** da decisão registrado (ex.: *credit_decisioning*).
* **Minimização**: regras consomem **apenas** atributos necessários; nada de PII extra.

### 2.5 Idempotência, consistência e correlação

* **`decision_id`** por solicitação; reprocessar com o mesmo `decision_id` deve **reproduzir** a decisão.
* Guardar **entrada → saída → versão de regra/modelo** (chaves de reconciliação).
* **Clock** único (UTC ISO-8601) para carimbo de tempo.

### 2.6 Observabilidade e auditoria

* Métricas: **coverage do score**, **distribuição de bands**, **hold rate**, **SLA HITL**.
* Logs estruturados: `decision_id`, `policy_version`, `model_version`, `reason_codes` (sem PII).
* **ADR/SCDR** para alterações relevantes de política.

---

## 3) Fluxos de referência

### 3.1 Decisão automática (sem intervenção)

1. Sistema de origem cria `decision_id` e envia contexto mínimo + `entity_key_hmac` → **Inference Gateway (Z6-2.1)**.
2. Recebe `score`, `model_version`, `policy_digest`.
3. **Decisioning** aplica: eligibility → bands → exceções → **decisão final**.
4. Publica evento de decisão + `reason_codes`; segue orquestração (ex.: notificar Core).

### 3.2 Decisão com **HITL** (Human-In-The-Loop)

1. Mesma entrada; bands retornam “**hold**”.
2. Orquestrador abre **tarefa** para Back-office; define **SLA**.
3. (Opcional) Exibe **explanations** *somente* a perfis autorizados.
4. Operador decide; sistema persiste **justificativa** e encerra.

### 3.3 Degradação (fallback)

* Se Z6 indisponível, **regra-only** (perfil mais conservador) ou **uso de `/last`** por janela curta — *conforme política aprovada*.

---

## 4) Políticas — exemplos (pseudo-Rego/DMN)

### 4.1 Eligibility gate (hard rule)

```rego
package decision.eligibility
default eligible = false

eligible {
  input.kyc.status == "ok"
  not input.person.sanctioned
  input.product in {"cartao","emprestimo"}
}
```

### 4.2 Bands (cut-offs por produto/tenant)

```rego
package decision.bands

band := "approve" {
  input.score >= input.thresholds.approve    # ex.: 0.85
}
band := "deny" {
  input.score <  input.thresholds.deny       # ex.: 0.25
}
band := "hold" {
  not (input.score >= input.thresholds.approve)
  not (input.score <  input.thresholds.deny)
}
```

### 4.3 Exceções regulatórias (sobrepõem bands)

```rego
package decision.overrides
final := "deny" {
  input.customer.segment == "regulado_fx"
  input.request.amount > 10000
}
```

### 4.4 Reason codes (mapeamento)

```rego
package decision.reasons
reasons := {"LOW_SCORE"} {
  input.band == "deny"
}
reasons := {"MANUAL_REVIEW","KYC_PENDING"} {
  input.band == "hold"
  input.kyc.status != "ok"
}
```

### 4.5 Fairness/deriva (modo conservador)

```rego
package decision.guardrails
conservative := true {
  input.monitor.psi > 0.25
} 
```

### 4.6 Tabela de decisão (DMN simplificada)

| Condição                        | Resultado   | Reason Codes          |
| ------------------------------- | ----------- | --------------------- |
| `eligible=false`                | deny        | `INELIGIBLE`          |
| `eligible=true ∧ override=deny` | deny        | `REGULATORY_OVERRIDE` |
| `eligible=true ∧ band=approve`  | approve     | `HIGH_SCORE`          |
| `eligible=true ∧ band=deny`     | deny        | `LOW_SCORE`           |
| `eligible=true ∧ band=hold`     | hold:manual | `MANUAL_REVIEW`       |

---

## 5) Esquemas de payload (contratos)

### 5.1 Entrada (resumo)

```json
{
  "decision_id": "uuid",
  "tenant": "retail-br",
  "purpose": "credit_decisioning",
  "entity_key": "hmac:****3a1f",
  "context": {
    "product": "cartao",
    "request": { "amount": 3500, "channel": "web" },
    "kyc": { "status": "ok" }
  }
}
```

### 5.2 Sinais do modelo (da Z6)

```json
{
  "score": 0.83,
  "model_version": "2.3.1",
  "policy_digest": "sha256:..."
}
```

### 5.3 Saída (decisão)

```json
{
  "decision_id": "uuid",
  "decision": "approve|deny|hold:manual",
  "reason_codes": ["HIGH_SCORE"],
  "policy_version": "2025-11-13.1",
  "model_version": "2.3.1",
  "as_of": "2025-11-13T22:04:11Z"
}
```

---

## 6) Implementação (trechos ilustrativos)

### 6.1 Orquestrador (BPMN/Zeebe/Temporal) — pseudo

```python
def workflow_decision(evt):
    s = call_inference(evt)           # Z6-2.1
    pol = load_policy(evt.tenant)     # versão aprov.
    res = evaluate_rules(evt, s, pol) # eligibility + bands + overrides
    if res.decision.startswith("hold"):
        open_task(queue="manual_review", sla="4h", payload=res)
    else:
        publish("decision.out", res)  # notifica Core
```

### 6.2 Testes de regra (unit)

```python
def test_low_score_denies():
    evt = mk_evt(score=0.10, kyc="ok")
    out = evaluate_rules(evt, thresholds={"approve":0.85,"deny":0.25})
    assert out.decision == "deny"
    assert "LOW_SCORE" in out.reason_codes
```

---

## 7) Checklists operacionais

**Antes do go-live**

* [ ] **Eligibility gates** definidos e testados.
* [ ] **Cut-offs/bands** por produto/tenant com simulação A/B offline.
* [ ] **Exceções regulatórias** mapeadas (documentadas em ADR/SCDR).
* [ ] **Reason codes** padronizados e exibíveis em auditorias.
* [ ] **HITL** com SLA, filas e justificativas obrigatórias.
* [ ] **Testes unitários** de regras + **cenários sintéticos**.
* [ ] **Observabilidade** (coverage, distribuições, hold rate) e **trilhas** prontas.

**Durante operação**

* [ ] Monitorar **drift/PSI** e ativar **modo conservador** quando aplicável.
* [ ] Revisões periódicas de **cut-offs** e **impacto** (negócio/risco).
* [ ] Auditoria de **overrides manuais** (quem/por quê/quando).
* [ ] Gestão de **versões de política** e **rollback seguro**.

---

## 8) Riscos × Controles × Referências

| Risco na decisão                            | Controle na camada de Decisioning                                                  |
| ------------------------------------------- | ---------------------------------------------------------------------------------- |
| **Inconsistência/aleatoriedade**            | **Política versionada**, idempotência por `decision_id`, testes de regra           |
| **Violação regulatória/contratual**         | **Exceções explícitas** (gates) + ADR/SCDR + auditoria                             |
| **Uso de score fora do contexto**           | **Eligibility** + **purpose** + minimização de atributos                           |
| **Viés/deriva operacional**                 | **Guardrails** (PSI/qualidade) + **modo conservador**                              |
| **Caixa-preta inacreditável**               | **Reason codes** e **explainability controlada** (apenas perfis autorizados)       |
| **Dependência frágil de serviços externos** | **Circuit breakers**, fallback “regras-only”/`/last`, orquestração com compensação |

---

## 9) Integrações

* **Z6-2.1/2.2**: fornece scores/predições; decisioning consome.
* **Z6-2.7**: leitura operacional/histórica para reconciliação.
* **Z7-2.2 (Back-office)**: tarefas HITL, justificativas e encerramento.
* **Z8**: IAM/Vault (claims, segredos), Catálogo (propósito).
* **Z9**: métricas, logs e trilhas; relatórios de auditoria.

---

## 10) Frases prontas (entrevista)

* “Separo **eligibility** (hard rules), **bands** (uso do score) e **exceções regulatórias**; tudo **versionado** e testado.”
* “Casos incertos viram **HITL** com **SLA** e **reason codes** — **explainability** só para perfis autorizados.”
* “Decisão é **idempotente** (via `decision_id`) e **auditável**: guardo entrada, política e versão do modelo.”
* “Quando **PSI/qualidade** foge do normal, o **modo conservador** reduz risco até a causa ser tratada.”
