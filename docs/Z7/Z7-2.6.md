# Z7-2.6 — Catálogo & **Data Contracts** (Leitura)

*(Descoberta • Finalidade (LGPD) • Versionamento • Compatibilidade • Testes de Contrato • Dicionário de Dados • Classificação & Masking)*

## 1) Papel e posicionamento

Esta camada garante que **consumidores Z7** (core, canais, back-office, chatbots) **leiam predições/resultados** **somente** via **contratos de API e esquema publicados**, com **propósito declarado**, **versionamento claro** e **compatibilidade controlada**.

> Sem contrato publicado e aprovado → **não existe consumo**.

Integra-se diretamente com:

* **Z6-2.7 Scored Output Access API** (rotas `/last`, `/search`, etc.).
* **Z8** (Catálogo de Dados, Classificação/PII, IAM) para **metadados, sensibilidade e propósito**.
* **Z9** para trilhas e reconciliação de consumo.

---

## 2) Capacidades obrigatórias

### 2.1 Catálogo de dados (descoberta & governança)

* **Catálogo único** (página/portal) com:

  * **APIs disponíveis** (ex.: `scored.v1`, `scored.v2`), **esquemas**, **exemplos** e **limites**.
  * **Dicionário de dados**: nome, tipo, semântica, **sensibilidade** (PII, confidencial, interno).
  * **Propósito** permitido (LGPD) por **rota/atributo**.
  * **Owner/steward**, **SLOs**, **janelas de retenção** e **política de depreciação**.
* **Busca** por `modelo`, `tenant`, `campo`, `sensibilidade`.

### 2.2 Data contracts (machine-readable)

* **OpenAPI** (REST) e/ou **JSON Schema/Avro** (payloads).
* **Policy binding**: anotações de **LGPD purpose**, **masking** e **ABAC** por campo:

  ```yaml
  x-purpose: credit_decisioning
  x-sensitivity: pii_masked
  x-abac-claim: tenant
  x-masking: hmac_sha256
  ```
* **Semântica estável**: nomes, tipos e unidades documentados; **enums** versionados.

### 2.3 Versionamento e compatibilidade

* **SemVer de API** (v1, v2) e **versão de esquema** (`schema_version: 2025-11-13.1`).
* Regras:

  * **Mudança compatível**: adicionar **campo opcional** documentado.
  * **Mudança *breaking***: renomear/remover campo, mudar tipo/unidade → **nova major** (v3).
* **Negociação de versão**: `Accept-Version: v2` ou base path `/api/scored/v2/...`.
* **Janela de depreciação** com datas e guia de migração.

### 2.4 Contratos por caso de uso (leitura)

* **Operacional**: `/last` minimalista (campos essenciais).
* **Analítico/Reconciliação**: `/search` paginado, janelas e filtros controlados.
* **Explainability**: rotas com **campo sensível opcional** (ex.: `explanations`), liberado **somente** a perfis/propósitos autorizados (ABAC + masking).

### 2.5 Testes de contrato (consumer/producer)

* **Producer contract tests**: gateway valida schema **antes** de publicar nova versão.
* **Consumer-driven contracts** (ex.: Pact) para times de core/canais.
* **CI obrigatório**: PR que altera contrato roda **suite** e gera **changelog**.

### 2.6 Catálogo ↔ Z6 (enforcement)

* O gateway de leitura (Z6-2.7) **valida**:

  * **Versão solicitada**, **propósito** (`X-Purpose`), **claims** (tenant/role),
  * **Campos de resposta** habilitados por **perfil** (masking quando necessário).
* **Logs estruturados** com `contract_version`, `purpose`, `masking_applied`.

---

## 3) Esquemas & contratos (exemplos)

### 3.1 OpenAPI — `GET /api/scored/v2/last`

```yaml
paths:
  /api/scored/v2/last:
    get:
      summary: Última predição por entidade
      parameters:
        - in: header
          name: Accept-Version
          schema: { type: string, enum: ["v2"] }
        - in: header
          name: X-Purpose
          schema: { type: string, enum: ["credit_decisioning"] }
        - in: query
          name: tenant
          required: true
          schema: { type: string }
        - in: query
          name: entity_key_hmac
          required: true
          schema: { type: string, pattern: "^hmac:[a-f0-9]{8,}$" }
        - in: query
          name: model
          required: true
          schema: { type: string, enum: ["churn","fraud","credit"] }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScoredLastV2"
components:
  schemas:
    ScoredLastV2:
      type: object
      properties:
        score:          { type: number, format: float, minimum: 0, maximum: 1 }
        model_version:  { type: string, pattern: "^[0-9]+\\.[0-9]+\\.[0-9]+$" }
        as_of_out:      { type: string, format: date-time }
        explanations:
          type: array
          items: { type: string }
          x-sensitivity: restricted
          x-abac-claim: role=risk-analyst
      required: ["score","model_version","as_of_out"]
      x-purpose: credit_decisioning
      x-schema-version: "2025-11-13.1"
```

### 3.2 JSON Schema (campo com masking)

```json
{
  "$id": "scored.last.v2",
  "type": "object",
  "properties": {
    "entity_key_hmac": { "type": "string", "pattern": "^hmac:.+" , "x-masking":"never-reveal" },
    "score": { "type": "number", "minimum": 0, "maximum": 1 },
    "model_version": { "type": "string" }
  },
  "required": ["score","model_version"]
}
```

---

## 4) Regras de evolução (boas práticas)

1. **Add-only** por padrão (campos opcionais).
2. **Enums**: só **adicionar** valores novos; remoções → **major**.
3. **Unidades** sempre explícitas (ex.: `amount_brl` ou `amount_cents`).
4. **Campos sensíveis** → **opt-in** por papel e propósito; **default: omitido**.
5. **Depreciação**: publicar **guia** + **data de corte**; alertas no **catálogo** e **logs**.

**Anti-padrões (proibidos):**

* Quebra silenciosa (renomear campo sem nova major).
* “Campo polimórfico” (tipo variando conforme dado).
* Retornar PII sem anotação/masking.
* Acesso **direto** a bucket/tabela contornando API.

---

## 5) Políticas como código (exemplos Rego)

### 5.1 Enforce de versão & propósito

```rego
package z7.contract.enforce
default allow = false

allow {
  input.headers["accept-version"] == "v2"
  input.headers["x-purpose"] == "credit_decisioning"
}
```

### 5.2 Masking por campo sensível

```rego
package z7.contract.mask
redact[field] { field == "entity_key_hmac" }     # nunca devolve original
redact[field] { field == "explanations"; not input.claims.role == "risk-analyst" }
```

### 5.3 Limites de janela em `/search`

```rego
package z7.contract.limits
deny {
  input.route == "/api/scored/v2/search"
  time.diff(input.query.from, input.query.to, "hours") > 168  # max 7 dias
}
```

---

## 6) Fluxos de referência

### 6.1 Publicação de novo contrato

1. Time de modelos define **schema v2** (+ dicionário + exemplos).
2. **Contract tests** rodam na CI (producer + consumers).
3. Catálogo atualiza **v2** (marca **v1** como “deprecated” com data).
4. Z6-2.7 começa a aceitar `Accept-Version: v2` e emitir **warnings** a quem usa v1.

### 6.2 Consumo operacional

1. App chama `/last` com `Accept-Version: v2` + `X-Purpose: credit_decisioning`.
2. Gateway aplica **ABAC** e **masking** conforme contrato.
3. Resposta mínima para decisão; logs com `contract_version` e `purpose`.

### 6.3 Consulta histórica (reconciliação)

1. Back-office usa `/search` com janela ≤ 7 dias.
2. Padrões de paginação e filtros **pré-aprovados**; sem PII em massa.

---

## 7) Checklists operacionais

**Para publicar (owner do contrato)**

* [ ] OpenAPI/Schema **completo**, exemplos e **dicionário** de dados.
* [ ] Classificação de **sensibilidade** e **propósito** por campo/rota.
* [ ] **SemVer** definido; **rota v2** criada quando houver *breaking change*.
* [ ] **Contract tests** e **CI** verdes; **SBOM/assinatura** do artefato.
* [ ] **Guia de migração** + **data de depreciação** do legado.

**Para consumir (times Z7)**

* [ ] Uso via **SDK** (Z7-2.5), **nunca** via HTTP cru.
* [ ] `Accept-Version` correto; **minimização** de parâmetros.
* [ ] Verificado **propósito** (LGPD) e **perfis** com acesso a campos sensíveis.
* [ ] Alertas para **erros de contrato** (422), janelas e paginação.

---

## 8) Riscos × Controles × Referências

| Risco                                     | Controle (Z7-2.6)                                                                 | Referências                |
| ----------------------------------------- | --------------------------------------------------------------------------------- | -------------------------- |
| **Quebra silenciosa** de consumidores     | **SemVer + changelog + depreciação**; contract tests (producer & consumer-driven) | NIST CM-*; OWASP ASVS      |
| **Vazamento de PII** por contrato frouxo  | **Classificação**, **masking por campo**, **ABAC** por propósito/tenant           | LGPD; NIST SC-28; CSA DSI  |
| **Uso fora de propósito** (purpose creep) | `X-Purpose` obrigatório, catálogo com finalidades, **access reviews**             | LGPD; NIST AI RMF (Govern) |
| **Consultas massivas** fora do escopo     | **Limites de janela/paginação**, rotas distintas para uso analítico               | OWASP API (API4)           |
| **Acoplamento frágil** a rotas/esquemas   | **SDK** + contratos estáveis + guia de migração                                   | OWASP ASVS                 |

---

## 9) Integrações

* **Z6-2.7**: aplica contrato em tempo de execução (valida versão, máscara campos, impõe limites).
* **Z8 (Catálogo/PII/IAM)**: metadados e classificações; propósito; perfis.
* **Z9**: auditoria de consumo (contrato/versão/purpose) e alertas de uso fora de política.

---

## 10) Frases prontas (entrevista)

* “Consumo de scores é **por contrato publicado**: OpenAPI + **classificação por campo** e **propósito LGPD**, com **masking** e **ABAC**.”
* “Mudanças *breaking* viram **nova major** (`v3`) com **janela de migração** e **contract tests** para evitar regressões.”
* “Rotas **operacionais** (`/last`) são **mínimas**; histórico (`/search`) vem **paginado** e **limitado** por política.”
* “O **Catálogo** é a fonte de verdade: dicionário, donos, SLO, e **data de depreciação** — sem contrato, **não há consumo**.”
