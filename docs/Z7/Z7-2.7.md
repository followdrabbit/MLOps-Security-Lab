# Z7-2.7 — Reconciliação & Fechamento Operacional (D+1)

*(“score ↔ decisão” • consistência de ledger • janelas controladas • fairness/PSI • auditoria pronta-pra-regulador)*

## 1) Papel e posicionamento

Essa camada garante que **toda decisão de negócio** (approve/deny/hold, limite, alçada) tomada por **Core/Risk/Fraud/Canais** esteja **coerente** com os **scores/predições** servidos pela **Z6**.
Objetivos centrais:

* **Conciliação diária (D+1)** de *score* vs *decisão* (**ledger de decisões**).
* **Detecção de anomalias** (cobertura, duplicidade, versões trocadas, latência fora do SLO).
* **Medição de fairness/drift** operacional (ex.: **PSI** por segmento) e disparo de **guardrails**.
* **Pacotes de auditoria** com trilhas (“quem decidiu o quê, baseado em qual modelo, quando e por quê”).

> Regra de ouro: reconciliação **não** lê buckets/tabelas brutas; usa **Scored Output Access API (Z6-2.7)** e eventos/consultas **governados**.

---

## 2) Capacidades obrigatórias

### 2.1 Chaves e correlação

* **`decision_id`** (do consumidor) ↔ **`predict_id`** / `as_of_in|out` (da Z6).
* **Join keys**: `tenant`, `entity_key_hmac`, `model`, `model_version`, *time window* (ex.: ±5 min entre *request_ts* e `as_of_out`).
* **Idempotência**: reprocessar **com o mesmo `decision_id`** deve produzir o mesmo resultado.

### 2.2 Janelas e limites

* Janelas **curtas e fixas** (ex.: **D** 00:00–23:59Z) com **watermark** para eventos atrasados (ex.: +2h).
* **Reprocesso controlado** para *backfills* (janela de 7 dias máx., conforme política).

### 2.3 Métricas e checks mínimos

* **Cobertura**: % de decisões com *score* correspondente.
* **Versões**: % de decisões por `model_version` esperado (bandeira se “versão surpresa”).
* **Latência**: p95/p99 entre *request_ts* e `as_of_out`.
* **Distribuições**: *score histogram*, **bands** (approve/hold/deny).
* **Fairness/drift**: **PSI** por segmento/região/canal; **cut-offs** sob revisão se PSI > limiar.

### 2.4 Controles de qualidade e invariantes

* **Sem duplicidade**: para (`decision_id`,`tenant`) deve existir **no máx. 1** decisão final.
* **Sem recombinação indevida**: *score* usado deve ser **compatível** com o contrato (rota/versão).
* **Quarentena**: inconsistências → fila de análise (não alteram o ledger sem revisão).

### 2.5 Segurança, propósito e minimização

* Consumo via **SDK (Z7-2.5)** com **OIDC+mTLS**; **`X-Purpose`** obrigatório (ex.: `reconciliation`).
* **ABAC** por time/tenant; **minimização** (sem PII crua; chaves tokenizadas).
* Exportações (CSV/Parquet) **assinadas**, criptografadas e com **expurgo** programado.

### 2.6 Saídas e evidências

* **Relatório diário** (JSON/CSV assinado) com: totais, deltas, outliers, anomalias, “itens pendentes”.
* **Evidências**: `policy_version`, `model_version`, `reason_codes` (quando disponíveis), hashes, horários.
* Publicação em **Z9** (painéis/alertas) e armazenamento **WORM-like** conforme política.

---

## 3) Fluxos de referência

### 3.1 Conciliação D+1 (alto nível)

1. Job **D+1** coleta **decisões** do dia D (evento/DB operacional) e **scores** via **`/search`** (Z6-2.7).
2. Faz **join** por `tenant`,`entity_key_hmac`,`model` e **janela de tempo**.
3. Calcula **cobertura**, **latência**, **distribuições**, **PSI** e **mismatches**.
4. Gera **relatório assinado**, envia para **Z9** e **abre incidentes** para anomalias críticas.

### 3.2 Backfill/reprocesso

* Operador aciona reprocesso de **janela limitada** (ex.: “ontem 12–18h”).
* Sistema **invalida apenas** os agregados afetados e reaplica **invariantes** antes de publicar.

### 3.3 Alerta de guardrail

* Se **PSI > 0.25** ou **hold rate** ↑ anormal → **“modo conservador”** no *decisioning* (Z7-2.4) até análise.

---

## 4) Consultas e joins (exemplos)

### 4.1 Consulta ao `search` (SDK pseudo-TS)

```ts
const it = sdk.scored.search({
  tenant: "retail-br",
  model: "credit",
  from: "2025-11-12T00:00:00Z",
  to:   "2025-11-13T00:00:00Z",
  page: 1, size: 500
});
// Agregar streaming, sem materializar PII
for await (const row of it) { /* join por entity_key_hmac + janela */ }
```

### 4.2 Join exemplificativo (SQL conceitual)

```sql
SELECT d.decision_id, d.tenant, d.entity_key_hmac, d.model,
       s.score, s.model_version, s.as_of_out, d.decision, d.request_ts
FROM decisions d
LEFT JOIN scored s
  ON s.tenant = d.tenant
 AND s.model  = d.model
 AND s.entity_key_hmac = d.entity_key_hmac
 AND s.as_of_out BETWEEN d.request_ts - INTERVAL '5 minutes'
                     AND d.request_ts + INTERVAL '5 minutes';
```

---

## 5) Fairness/PSI e guardrails (exemplos)

### 5.1 Cálculo de PSI (pseudo-Python)

```python
def psi(expected_bins, actual_bins):
    # expected/actual são distribuições normalizadas
    import math
    return sum((a - e) * math.log(a / e) for e, a in zip(expected_bins, actual_bins) if e > 0 and a > 0)
```

### 5.2 Política de guardrail (Rego)

```rego
package z7.recon.guardrails
conservative_mode := true { input.psi > 0.25 }
```

---

## 6) Políticas & limites (Rego)

### 6.1 Janelas e exportações

```rego
package z7.recon.limits
default allow = false

# Janela máxima de 7 dias
allow {
  input.route == "/api/scored/v2/search"
  time.diff(input.query.from, input.query.to, "hours") <= 24*7
  input.headers["x-purpose"] == "reconciliation"
}
```

### 6.2 Papel autorizado e minimização

```rego
package z7.recon.access
permit {
  input.claims.role in {"risk-ops","audit"}
  not input.response.contains_pii  # API já aplica masking; aqui é dupla checagem
}
```

---

## 7) Checklists operacionais

**Antes do go-live**

* [ ] Definir **join keys** e **janela**; contrato de `/search` publicado (Z7-2.6).
* [ ] Criar **invariantes de ledger** (sem duplicidade; versionamento coerente).
* [ ] Painéis em **Z9**: cobertura, latência, PSI, hold/approve/deny.
* [ ] Alertas (Slack/Pager) para **cobertura < alvo** ou **PSI > limiar**.
* [ ] Geração de **relatório assinado** + retenção/expurgo definidos.

**Durante operação**

* [ ] Acompanhar **p95/p99** de conciliação e **erros de join**.
* [ ] Revisar **análises pendentes** e *tickets* abertos por anomalias.
* [ ] Rodar **backfills** controlados quando houver indisponibilidade.
* [ ] Revisão mensal de **cut-offs** à luz dos relatórios.

---

## 8) Riscos × Controles × Referências

| Risco na reconciliação                     | Controle                                                                     |
| ------------------------------------------ | ---------------------------------------------------------------------------- |
| **Decisão sem score** (perda de cobertura) | Alerta em Z9; *fallback* contabilizado; revisão de SLO da Z6                 |
| **Join errado/duplicado**                  | **Join keys** claras + janela fixa + **invariantes** de ledger               |
| **Versão de modelo inesperada**            | Checagem de `model_version` + alerta + bloqueio opcional                     |
| **Fairness/drift não percebidos**          | **PSI por segmento** + guardrail (modo conservador)                          |
| **Vazamento de PII em relatórios**         | **Minimização**, **masking**, exporto **assinado/criptografado** com expurgo |
| **Uso fora de propósito**                  | `X-Purpose: reconciliation`, **ABAC** por papel/tenant                       |

(Alinhado a **NIST AI RMF** — Map/Measure/Manage; **NIST SP 800-53** AU-*, CM-*, SI-*; **OWASP API Security**; **CSA AICM**.)

---

## 9) Integrações

* **Z6-2.7**: leitura governada (`/last`, `/search`).
* **Z7-2.4**: *feedback loop* para **bands/cut-offs** e exceções.
* **Z8**: IAM/Vault/Catálogo (claims, propósito, classificação, segredos).
* **Z9**: painéis, alertas, armazenamento de evidências e *incident response*.

---

## 10) Frases prontas (entrevista)

* “Fechamos **D+1** com **ledger** que casa **decisão ↔ score/model_version**; **PSI e cobertura** disparam **guardrails**.”
* “Usamos **`/search` (Z6-2.7)** com **janela controlada** e **minimização**; **sem acesso bruto** a storage.”
* “Relatórios são **assinados/criptografados**, sem PII, e **publicados em Z9** com *SLO* e alertas operacionais.”
