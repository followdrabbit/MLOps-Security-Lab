# Z7-2.8 — **Egress Seguro & Compartilhamento Controlado**

*(Exports/Relatórios • Terceiros & Parceiros • Anonimização/Tokenização • Assinatura & Criptografia • DLP • Purpose-binding)*

## 1) Papel e posicionamento

Governa **toda saída** de dados/outputs de IA para **fora do domínio do consumidor interno**: relatórios operacionais, integrações com **parceiros** (bureaus, adquirentes), **reguladores**, *managed file transfer* e **APIs externas**.
Princípios: **minimização**, **finalidade (LGPD)**, **contrato de egress**, **assinatura & criptografia**, **auditoria** e **expurgo/TTL**.

> Regra: nada sai de Z7 sem **manifesto de exportação**, **policy check** e **canal seguro**.

---

## 2) Capacidades obrigatórias

### 2.1 Manifesto de Exportação (machine-readable)

Documento anexado a **cada export**:

* **purpose** (ex.: `regulatory_reporting` | `partner_scoring_feed`), **owner**, **tenant**.
* **dataset/rotas** de origem (ex.: `scored.v2:/search`), **colunas**, **agregações**.
* **classificação** por campo (PII/Confidencial/Interno) + **máscara/anônimização** aplicada.
* **destino** (SFTP mTLS, MFT, API externa com mTLS/OIDC), **janelas**, **retenção** e **TTL**.
* **hash** (SHA-256) do artefato, **assinatura** (PGP/Cosign) e **KMS** utilizado.

### 2.2 Minimização, (Pseudo)Anonimização & Tokenização

* **Default**: apenas **atributos necessários** ao propósito.
* **Tokenização/HMAC** para chaves de entidade; **sem PII crua**.
* **Anonimização** ou **agregação** para uso estatístico.
* **Consistência**: mesmo HMAC/seed por tenant quando necessário reconciliar.

### 2.3 Validação de Conteúdo + DLP

* **DLP** antes de gerar/entregar (regex de PII, fingerprints, dictionaries).
* **Schemas rígidos** (Avro/JSON Schema) e **limites de volume** (linhas/tamanho).
* **Watermarking** (coluna `export_id`, `created_at`, `purpose`).

### 2.4 Canais de Entrega

* **MFT/SFTP** com **mTLS** + chaves rotacionadas e **IP allowlist**.
* **APIs externas** via **mTLS + OIDC** (client credentials), quotas e **replay-protection**.
* **Pre-signed URLs** apenas se inevitável: **curto TTL**, **download único**, **escopo por IP**.

### 2.5 Assinatura, Criptografia & Retenção

* **Assinatura** do arquivo (detached) e **criptografia** end-to-end (PGP/KMS).
* **Retenção** mínima para **replay** (ex.: 7 dias) e **expurgo automático** após SLA.
* **WORM-like** para provas regulatórias quando requerido.

### 2.6 Observabilidade & Auditoria

* **Log estruturado**: `export_id`, `manifest_digest`, `rows`, `size`, `pii_masked=true`, `destino`.
* **Traces** (pipeline → DLP → assinatura → entrega).
* **Relatórios mensais** de egress por **purpose/destino** (Z9), *access reviews*.

---

## 3) Fluxos de referência

### 3.1 Feed diário para parceiro (SFTP/MFT)

1. Job monta **manifesto** (`partner_scoring_feed`).
2. Lê **apenas** via **Scored Output Access API (Z6-2.7)** com `X-Purpose: partner_feed`.
3. **DLP + schema check** → **assinatura + criptografia** → **upload MFT**.
4. Loga `export_id` + métricas; **TTL** e expurgo agendados.

### 3.2 Relatório regulatório

1. *Template* fixo (campos e agregações pré-aprovados).
2. Geração **determinística** (idempotente por janela) + **assinatura**.
3. Publicação em canal regulatório + **evidence pack** no Z9 (hashes, versões).

### 3.3 API externa (pull)

1. Terceiro chama **/exports/:id** com **mTLS+OIDC**.
2. Gateway valida **purpose/tenant**, **janela**, **quota** e **versão**.
3. Entrega stream **assinado**; bloqueia **re-download** após N horas.

---

## 4) Políticas como código (exemplos Rego)

### 4.1 Campos permitidos por propósito

```rego
package z7.egress.contract
default allow = false

allow {
  input.purpose == "partner_scoring_feed"
  every k in input.columns { k in {"entity_key_hmac","score","model_version","as_of_out"} }
}
deny[msg] {
  input.columns[_] == "cpf"    # PII crua proibida
  msg := "PII proibida no feed de parceiro"
}
```

### 4.2 Limites de janela e volume

```rego
package z7.egress.limits
deny { time.diff(input.from, input.to, "hours") > 24 }     # máx. 24h
deny { input.rows > 5_000_000 }                            # hard cap
```

### 4.3 Destinos autorizados

```rego
package z7.egress.dest
allow { input.dest.type == "mft" ; input.dest.host in {"mft.parceiroA.com"} }
allow { input.dest.type == "api" ; input.dest.aud == "partnerA-egress" }
```

---

## 5) Esquemas & exemplos

### 5.1 Manifesto (YAML)

```yaml
export_id: "exp-2025-11-13-001"
purpose: "partner_scoring_feed"
owner: "risk-ops@corp"
tenant: "retail-br"
source:
  api: "scored.v2:/search"
  window: { from: "2025-11-12T00:00:00Z", to: "2025-11-13T00:00:00Z" }
columns: ["entity_key_hmac","score","model_version","as_of_out"]
classification:
  entity_key_hmac: pii_masked
  score: internal
delivery:
  type: "mft"
  host: "mft.parceiroA.com"
  path: "/in/retail-br/scored_2025-11-12.csv.pgp"
security:
  sign: "pgp:corp-risk"
  encrypt: "pgp:partnerA-key"
  kms: "aws-kms:alias/mlops-exports"
retention: { days: 7, expunge: true }
hash: "sha256:…"
```

### 5.2 Cabeçalho mínimo de export (CSV)

```
# export_id=exp-2025-11-13-001 purpose=partner_scoring_feed schema=scored.v2
entity_key_hmac,score,model_version,as_of_out
hmac:ab12…,0.83,2.3.1,2025-11-12T18:41:01Z
```

---

## 6) Checklists operacionais

**Antes do go-live**

* [ ] **Catálogo** publica **contratos de egress** (campos, propósito, destino, retenção).
* [ ] **DLP** calibrado (regex, fingerprints, allowlist).
* [ ] **Canais** com **mTLS+OIDC**, chaves rotacionadas e **IP allowlist**.
* [ ] **Assinatura & criptografia** testadas ponta-a-ponta; **replay** idempotente.
* [ ] **Alertas Z9** para volume anômalo, PII detectada, retry excessivo.

**Durante operação**

* [ ] Revisão mensal de **purpose/destinos**; *access reviews*.
* [ ] Auditoria de **falhas DLP** e **exceções** com aprovação.
* [ ] Verificação de **hash/assinatura** no destino (comprovante).
* [ ] Limpeza automática conforme **TTL/retention**.

---

## 7) Riscos × Controles × Referências

| Risco de egress                              | Controles                                                                              |
| -------------------------------------------- | -------------------------------------------------------------------------------------- |
| **Vazamento de PII/segredos**                | **Minimização**, **tokenização/HMAC**, **DLP**, **output filtering**, **criptografia** |
| **Uso fora de propósito (LGPD)**             | **purpose-binding** no manifesto + políticas OPA + *access reviews*                    |
| **Integridade/repúdio**                      | **Assinatura** + **hash** + recibo/verificação no destino                              |
| **Canal inseguro/impersonação**              | **mTLS + OIDC**, IP allowlist, rotação de chaves, quotas                               |
| **Dump massivo/exfiltração**                 | **Janelas/volumes limitados**, quotas, *rate limit*, alertas Z9                        |
| **Contrato instável/coluna sensível “vaza”** | **Egress contract** versionado + **policy check** por campo + CI de contratos          |

(Alinhado a **LGPD**, **OWASP API Security (API4: Resource Consumption, API8: Injection – validação de payloads)**, **NIST SP 800-53** AC-*, SC-*, MP-*, AU-*, **CSA CCM (DSI, EKM, SEF, TVM)**.)

---

## 8) Integrações

* **Z6-2.7**: única fonte de saída de *scores* (leitura governada).
* **Z8**: IAM/Vault/KMS/DLP/Catálogo (identidade, segredos, chaves, classificação).
* **Z9**: monitoração, auditoria, detecção de anomalias e *evidence packs*.

---

## 9) Frases prontas (entrevista)

* “Egress só acontece com **manifesto** (purpose, colunas, destino, retenção), **DLP**, **assinatura** e **criptografia**.”
* “Usamos **tokenização/HMAC** — **sem PII crua** — e contratos **versionados** por propósito/destino.”
* “Entrega apenas por **mTLS+OIDC/MFT**, com **janelas/volumes** limitados, **quotas** e **auditoria Z9**.”
