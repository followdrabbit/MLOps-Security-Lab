# Z8-2.1 — Identity, Access & PAM (IdP/OIDC/IAM)

- ↩️ [Voltar ao Z8 — Security & Trust Services](./Z8-index.md)
- ↩️ [Voltar ao README — Mapa Z0–Z9](../../README.md)

> **Resumo**: Centraliza **autenticação** (humanos e workloads), **autorização** (RBAC/ABAC/policy-as-code), **PAM/JIT** para acessos privilegiados e integra com **Vault/KMS**. É a espinha dorsal de identidade que amarra **Z1/Z6/Z7** (borda/serving/consumo) e alimenta **Z9** (auditoria).

---

## 1) Objetivos & Escopo

**Objetivos**

* Identidades **humanas** (devs, analistas, SREs) e **técnicas** (serviços, CI/CD, jobs) federadas com **IdP** (OIDC/OAuth2/SAML).
* **Autorização mínima necessária** (least privilege) com **RBAC/ABAC**; decisões **policy-as-code** (OPA/Rego) quando aplicável.
* **PAM/JIT** para operações sensíveis, com **session recording** e **break-glass** auditado.
* Tokens **curto prazo** (access/refresh), **rotação**, **revogação**, **auditoria**.

**Fora de escopo (nesta página)**

* Gestão de segredos (detalhe em **Z8-2.2 Vault**).
* Criptografia/PKI (detalhe em **Z8-2.3 KMS/HSM/PKI**).

---

## 2) Ameaças principais

* **AuthN fraca**: senhas fracas, ausência de MFA, *phishing*.
* **AuthZ incorreta**: escopos amplos, *tenant escape*, *over-privilege*.
* **Compartilhamento de contas**: *account sharing* e falta de rastreabilidade.
* **Tokens long-lived**: *refresh tokens* sem rotação; *replay*.
* **Acesso privilegiado sem controle**: sem JIT, sem *recording*, sem aprovação.
* **Shadow identity**: serviços fora do IdP, chaves/tokens “alternativos”.

---

## 3) Componentes & Controles

### 3.1 IdP (Keycloak/ADFS/…) — OIDC/OAuth2/SAML

* **Realms/Tenants**: segregação por ambiente/cliente (ex.: `lab-prod`, `lab-np`).
* **Clients**:

  * *Confidential* (server-side): Authorization Code + **PKCE** (mesmo em *confidential*), **Client Credentials** para M2M.
  * *Public* (CLI/SPA): Authorization Code + **PKCE** (sempre).
* **Federação OIDC para workloads** (ex.: **GitHub Actions → Vault**), reduzindo segredos estáticos no CI.
* **MFA** para humanos; **device posture** opcional (amplia sinal de risco).
* **Sessões & tokens**: `access_token_ttl` curto (ex.: 5–15 min), `refresh_ttl` moderado (ex.: 1–8 h) com **rotação** e **detecção de reuse**.

### 3.2 IAM: RBAC + ABAC

* **RBAC**: papéis canônicos (“`ml-trainer`”, “`ml-sec`”, “`reader`”).
* **ABAC**: *claims* por **tenant**, **rota**, **modelo**, **versão**, **ambiente** (ex.: `tenant=bankA`, `model=churn`, `version=v2`).
* **Scopes** padronizados:

  * `inference:{model}:{version}:invoke`
  * `registry:model:approve`
  * `dataset:raw:write` / `feature:store:read`
* **Deny-by-default**: tudo começa negado; políticas habilitam o mínimo necessário.

### 3.3 Workload Identity (M2M)

* **OIDC Federation** (ex.: GH Actions emite JWT → IdP/Vault valida → entrega *short-lived secret*).
* **Service Accounts** com **mTLS** para S2S (certs emitidos por PKI da Z8-2.3).
* **Rotação/Revogação**: *leases* curtos (minutos/horas), *auditoria* de cada emissão.

### 3.4 Autorização como código (OPA/Rego)

* **PDP** externo (OPA) ou *sidecar* consulta políticas; **PIP** enriquece (tenant, rota, tags do modelo).
* **Uso**: *gates* do **Z5** (promover/assinar), **Z1** (ingestão), **Z6/Z7** (chamadas de inferência).

### 3.5 PAM/JIT (Privileged Access Management)

* **Fluxo JIT**: solicitação → aprovação → janela curta (ex.: 60 min) → **session recording** → *auto-revoke*.
* **Break-glass**: cofre + 2FA adicional + justificativa/ticket + notificação + revisão posterior.
* **SoD** (Segregation of Duties): quem aprova não opera; papéis separados para *deploy* x *approve*.

### 3.6 Auditoria & Conformidade

* **Eventos**: `login_success/failed`, `token_issue/revoke`, `policy_decision`, `jit_grant/revoke`, `break_glass_use`.
* **Enriquecimento**: `tenant`, `route`, `model/version`, `client_id`, `source_ip`, `device`.
* Envio para **Z9** (SIEM/UEBA/SOAR) com **retenção** e **impossibilidade de alteração** (WORM).

---

## 4) Contratos & Padrões

### 4.1 Formato mínimo de *access token* (JWT)

**Requeridos**: `iss`, `aud`, `sub`, `exp`, `iat`, `nbf`, `jti`
**Custom claims** (exemplos):

* `tenant` (ex.: `bankA`)
* `scopes` (lista)
* `roles` (lista)
* `model` / `model_version` (ex.: `churn` / `v2`)
* `env` (ex.: `prod`)

**Exemplo (trecho)**

```json
{
  "iss": "https://idp.example.com/realms/lab-prod",
  "aud": "inference-gw",
  "sub": "svc:core-banking",
  "exp": 1731600000,
  "tenant": "bankA",
  "scopes": ["inference:churn:v2:invoke"],
  "roles": ["consumer"],
  "model": "churn",
  "model_version": "v2",
  "env": "prod"
}
```

### 4.2 Boas práticas de tokens

* **Não** use **ID Token** para autorização de API; use **Access Token**.
* **Curto prazo** + **refresh rotation** com revogação em *reuse*.
* **Bind** via **mTLS** quando possível (token + canal).
* **Validações**: assinatura (JWKS), `exp/nbf`, `aud/iss` esperados, *clock skew*, `jti` anti-replay.

---

## 5) Fluxos de referência

### 5.1 Humano → Admin UI

1. Browser → IdP (**Authorization Code + PKCE + MFA**).
2. UI recebe `access_token` curto; chama **API admin** com **OPA** verificando `roles=scoped`.
3. Eventos `login/token_issue/policy_decision` → **Z9**.

### 5.2 CI/CD (GitHub) → Vault (OIDC Federation)

1. Job emite **OIDC JWT** → troca no **Vault** por *token* curto (AppRole/JWT).
2. Usa segredos efêmeros para *deploy* de modelo (Z5→Z6).
3. `token_issue/secret_lease` → **Z9**; *access review* periódico.

### 5.3 Serviço → Inference Gateway

1. Cliente S2S com **mTLS** + **Access Token** (`inference:{model}:{version}:invoke`).
2. Gateway valida JWT/JWKS, chama **OPA** com `{route, tenant, model, version, scopes}`.
3. Decisão **allow/deny**; logs de decisão → **Z9**.

### 5.4 PAM/JIT

1. Operador solicita *JIT role*; aprovação por gestor/rotina.
2. IdP emite sessão **limitada no tempo**; **session recording** habilitado.
3. `jit_grant/revoke/session_record_link` → **Z9**. *Post-review* obrigatório.

---

## 6) Riscos × Controles × Frameworks

| Risco                            | Controle                                                               | Referências (ex.)                          |
| -------------------------------- | ---------------------------------------------------------------------- | ------------------------------------------ |
| AuthN fraca / *phishing*         | MFA, PKCE, sessões curtas, CAE (opcional)                              | OWASP ASVS A2/A3; NIST IA-2/IA-5           |
| *Over-privilege* / tenant-escape | RBAC+ABAC, **deny-by-default**, OPA/Rego                               | OWASP API1/5; NIST AC-2/AC-6; CSA IAM      |
| Tokens reutilizados / long-lived | TTL curto, **refresh rotation**, *revoke on reuse*, `jti` anti-replay  | NIST IA-5; OWASP ASVS Token Best Practices |
| Acesso privilegiado sem controle | **PAM/JIT**, session recording, break-glass auditado                   | NIST AC-17/AC-19; CSA IAM, SEF             |
| Falta de trilhas de auditoria    | Eventos completos → Z9, WORM, *evidence links*                         | NIST AU-2/AU-12; CSA LOG                   |
| Shadow identity / bypass do IdP  | Federation para workloads, *service accounts* + mTLS, *access reviews* | NIST AC-2/CM-8; CSA IAM/IVS                |

---

## 7) Checklists operacionais

**Antes do go-live**

* [ ] Realms/clients configurados; **MFA** obrigatório p/ admins.
* [ ] **Scopes** padronizados; **políticas OPA** *deny-by-default*.
* [ ] **TTL** de access/refresh definidos; **refresh rotation** ativa.
* [ ] **OIDC Federation** no CI/CD; nenhuma credencial estática.
* [ ] **PAM/JIT** com aprovação, *recording* e **runbook** de *break-glass*.
* [ ] Painéis e alertas em **Z9** para `login_fail`, `reuse_detected`, `deny_rate`.

**Operação contínua**

* [ ] **Access reviews** mensais (humanos e workloads).
* [ ] Rotação periódica de chaves/signing keys do IdP.
* [ ] Teste de *break-glass* e restauração (table-top).
* [ ] Revisão de políticas OPA (mudanças de rota/modelo/tenant).
* [ ] Relatório de uso por *scope* e por *tenant* (detecção de abuso).

---

## 8) Exemplos práticos

### 8.1 Scopes padronizados (nomenclatura)

```
inference:{model}:{version}:invoke
registry:model:approve
dataset:raw:write
feature:store:read
```

### 8.2 Rego — autorização por rota/tenant/versão

```rego
package z8.authz
default allow = false

allow {
  input.route == "/api/churn/v2/predict"
  input.claims.tenant == input.request.tenant
  some s
  s := input.claims.scopes[_]
  s == "inference:churn:v2:invoke"
}
```

### 8.3 Validação de JWT (pseudocódigo)

```python
def validate(token, jwks, expected_iss, expected_aud):
    claims = verify_signature_and_decode(token, jwks)
    assert claims["iss"] == expected_iss
    assert expected_aud in claims["aud"]
    assert now() < claims["exp"] and now()+skew > claims["nbf"]
    assert claims["jti"] not in revoked_jtis()
    return claims
```

---

## 9) Frases prontas (entrevista)

* “Em **Z8**, **RBAC+ABAC** com **OPA/Rego** garante **deny-by-default** por **rota/tenant/model/version**.”
* “**Workloads** usam **OIDC Federation** (ex.: **GitHub→Vault**) para receber **segredos efêmeros** — sem credenciais estáticas.”
* “Acesso **privilegiado é JIT**, com **session recording** e **break-glass** auditado — fechando o ciclo no **Z9**.”
* “Tokens são **curto prazo** com **refresh rotation** e **revoke on reuse**; validação **aud/iss/exp/nbf/jti** em *edge*.”
