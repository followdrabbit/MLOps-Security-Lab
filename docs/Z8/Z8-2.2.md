# Z8-2.2 — Secrets Manager (Vault)

- ↩️ [Voltar ao Z8 — Security & Trust Services](./Z8-index.md)
- ↩️ [Voltar ao README — Mapa Z0–Z9](../../README.md)

> **Resumo**: Centraliza **segredos** e **criptografia como serviço**. Entrega credenciais **efêmeras** em **runtime** (Vault Agent/sidecar), aplica **rotação/renovação/revogação**, registra **auditoria**, e oferece **Transit**/**PKI** para selar dados e assinar/verificar artefatos. Integra-se a **Z1** (ingestão), **Z5** (registry) e **Z6/Z7** (serving/consumo), com eventos indo para **Z9**.

---

## 1) Objetivos & Escopo

**Objetivos**

* **Remover segredos do código e imagens**; entregar **on-demand** via **Vault Agent/sidecar**.
* **Identidade de workload** com **OIDC/AppRole/Kubernetes Auth**; *leases* curtos e **revogação**.
* **Criptografia** via **Transit/KMS** (envelope encryption), **assinaturas/attestations** e **PKI** (mTLS).
* **Auditoria completa** de acesso a segredos e chaves; evidências para compliance.

**Fora de escopo nesta página**

* Detalhes de **KMS/HSM/PKI** (ver **Z8-2.3**).
* Políticas de autorização de APIs (ver **Z8-2.4**).

---

## 2) Ameaças principais

* **Segredo no código/imagem** (acesso não autorizado, *secret sprawl*).
* **Credenciais long-lived** sem rotação/renovação; **tokens reutilizados**.
* **Políticas permissivas** (acesso a caminhos amplos; *tenant escape*).
* **Falta de auditoria** ou logs alteráveis.
* **Entrega insegura** (env vars/leaks em logs, *response wrapping* ausente).

---

## 3) Componentes & Controles

### 3.1 Engines (principais montagens)

* **KV v2 (segredos estáticos com versão)**: *metadata*, versionamento, soft-delete/retention.
* **Transit (cripto como serviço)**: `encrypt/decrypt/hmac/sign/verify` (chaves **não** saem do Vault).
* **Database Secrets (dinâmicos)**: credenciais efêmeras para Postgres/MySQL/etc.
* **Cloud secrets** (AWS/GCP/Azure): chaves temporárias para acesso a serviços.
* **PKI** (opcional aqui; detalhado em Z8-2.3): emitir/rotacionar certs (mTLS).

> **Regra**: **dinâmico** sempre que possível (DB/Cloud). **KV v2** apenas quando inevitável.

### 3.2 Métodos de Auth (humanos & workloads)

* **OIDC/JWT** (preferencial para CI/CD e serviços que emitem *identity tokens*).
* **AppRole** (serviços *headless*; combine com *response wrapping*).
* **Kubernetes Auth** (pod se autentica com *service account JWT*).
* **TLS Cert Auth** (para *mTLS* S2S em ambientes sem OIDC).

> **Token TTL** curto (ex.: 15m), `max_ttl` controlado, **renovação explícita**; **revogue** em suspeita ou *reuse*.

### 3.3 Vault Agent & Templates

* **Sidecar** resolve auth (OIDC/AppRole/K8s), **renova** e **renderiza** segredos via templates `.ctmpl`.
* **Entrega por arquivo** em **`/run/secrets/*`** (tmpfs) → **nunca** em env vars ou diretórios persistentes.
* **Sinalização** ao app (SIGHUP/Reload) quando renovar/rotacionar.

**Exemplo de template (`db-creds.ctmpl`)**

```tpl
username={{ with secret "database/creds/reader" }}{{ .Data.username }}{{ end }}
password={{ with secret "database/creds/reader" }}{{ .Data.password }}{{ end }}
```

**Exemplo de Agent (`agent.hcl`)**

```hcl
auto_auth {
  method "jwt" {
    mount_path = "auth/jwt"
    config = { role = "svc-inference" }
  }
  sink "file" { config = { path = "/run/secrets/vault_token" } }
}
template {
  source      = "/etc/secrets/db-creds.ctmpl"
  destination = "/run/secrets/db-creds"
  command     = "kill -HUP 1" # reload do processo principal
}
cache { use_auto_auth_token = true }
```

### 3.4 Políticas (ACL) & Namespaces

* **Políticas por inquilino/rota/ambiente** (ex.: `tenant/bankA/*`, `env/prod/*`).
* **Deny-by-default**; libere caminhos **específicos** (lista de capacidade).
* **Namespaces** para isolar tenants (quando multi-tenant real).

**Exemplo de política (HCL)**

```hcl
path "kv/data/app/inference/prod/*" {
  capabilities = ["read"]
}
path "database/creds/readonly" {
  capabilities = ["read"]
}
```

### 3.5 Leases, Rotação & Revogação

* **Leases curtos** (minutos/horas); **auto-renew** pelo Agent.
* **Revogação automática** no término do job/pod.
* **Rotação periódica** de segredos estáticos (KV v2) e chaves Transit/PKI (ver Z8-2.3).

### 3.6 Audit Devices & Evidências

* **Audit** obrigatório (file/syslog/socket) com **integridade** e **retenção** (WORM → Z9).
* **Campos mínimos**: `auth.entity_id`, `path`, `operation`, `request_id`, `policy`, `remote_addr`.
* **Redação**: evite logar valores de segredos (`log_raw=false`).

---

## 4) Contratos & Padrões

### 4.1 Convenções de caminhos (exemplos)

```
kv/{env}/{tenant}/{app}/{component}/...
database/creds/{role}
transit/keys/{purpose}
pki/issue/{role}
```

### 4.2 Regras de entrega

* **Arquivo em tmpfs** (`/run/secrets`) com `0600`; **nunca** env var.
* **Reload** gracioso do app quando o arquivo muda.
* **Zeroização** na parada (tmpfs limpa; *preStop hook* se necessário).

### 4.3 SLOs mínimos (lab)

* `p95 secret render` < 300ms; `p95 transit encrypt` < 200ms.
* **Erro** de Agent/Transit → **fail-safe** (bloquear operação sensível).

---

## 5) Fluxos de referência

### 5.1 CI/CD → Vault (OIDC) → Deploy seguro

1. Pipeline emite **OIDC JWT** → autentica no Vault (auth/jwt).
2. Recebe **token curto**; renderiza **`/run/secrets/registry-signing`** (chave Transit) para **assinar modelo** (Z5).
3. Auditoria: `token_issue`, `secret_render`, `transit_sign` → **Z9**.

### 5.2 Pod (K8s) → Agent → DB Secrets dinâmicos

1. Pod com **service account** autentica via **K8s Auth**.
2. Agent renderiza `database/creds/readonly` (TTL 30m).
3. App usa credenciais efêmeras; **revogação** no término do pod/job.

### 5.3 App → Transit (Envelope Encryption)

1. App gera chave de dados; chama **Transit** para **selar** (`encrypt`).
2. Armazena **dados selados** em Z2/Z3; chaves **nunca** saem do Vault.
3. **Verify/HMAC** para integridade; auditoria associada.

---

## 6) Riscos × Controles × Frameworks

| Risco                                   | Controle                                                                         | Referências (ex.)                  |
| --------------------------------------- | -------------------------------------------------------------------------------- | ---------------------------------- |
| Segredo em código/imagem                | **Vault Agent/sidecar**, templates `.ctmpl`, **sem env vars**                    | NIST IA-5/AC-6; OWASP ASVS Secrets |
| Credenciais long-lived / reuso de token | **TTL curto**, *auto-renew*, **revogação**; OIDC/AppRole com *response wrapping* | NIST IA-5; OWASP ASVS Token        |
| Escopo amplo / *tenant escape*          | Políticas **path-based** mínimas; **namespaces** por tenant                      | NIST AC-2/AC-6; CSA IAM            |
| Falta de audit trail                    | **Audit devices** obrigatórios + WORM (→ Z9)                                     | NIST AU-2/AU-12; CSA LOG           |
| Vazamento por entrega                   | **/run/secrets (tmpfs)**, permissão `0600`, redaction de logs                    | NIST SC-28; CSA DSI                |
| Chaves expostas / sem rotação           | **Transit/KMS**, rotação planejada, CRL/PKI (ver Z8-2.3)                         | NIST SC-12/SC-13; SSDF/SLSA        |

---

## 7) Checklists operacionais

**Antes do go-live**

* [ ] **Auth methods** habilitados (OIDC/AppRole/K8s) com TTL curtos.
* [ ] **Agent** configurado (templates, destino `/run/secrets`, reload).
* [ ] **Políticas** mínimas por tenant/ambiente; *deny-by-default*.
* [ ] **Audit** ativo e testado; retenção WORM configurada.
* [ ] **Transit** pronto (chaves por propósito) e **DB secrets** dinâmicos.

**Operação contínua**

* [ ] **Rotação** de KV estáticos e chaves Transit/PKI.
* [ ] **Access reviews** de políticas/namespaces.
* [ ] Teste de **revogação** e **response wrapping**.
* [ ] Alarmes: falha de Agent, *lease* expirando, picos de “permission denied”.

**Incidente**

* [ ] **Revoke tokens** relacionados; **disable** caminhos comprometidos.
* [ ] *Forense* em Audit logs; gerar **evidências** (→ Z9).
* [ ] Rotacionar segredos/chaves afetadas; **post-mortem** e melhoria de política.

---

## 8) Exemplos práticos

**8.1 Política HCL (mínima por app/ambiente)**

```hcl
path "kv/data/prod/bankA/inference/*" { capabilities = ["read"] }
path "database/creds/bankA-readonly"  { capabilities = ["read"] }
path "transit/*"                      { capabilities = ["update"] } # sign/encrypt
```

**8.2 AppRole com *response wrapping* (CLI)**

```bash
vault write -wrap-ttl=5m auth/approle/login role_id=$ROLE_ID secret_id=$SECRET_ID
# entrega um wrap_token que só o destino desembrulha (cubbyhole)
```

**8.3 Pseudocódigo – uso de arquivo em /run/secrets**

```python
with open("/run/secrets/db-creds") as f:
    cfg = parse_kv(f.read())
conn = pg.connect(user=cfg["username"], password=cfg["password"])
```

**8.4 Transit — assinatura/verificação (curl)**

```bash
vault write transit/sign/model-sign input=$(base64 <<<"$digest")
vault write transit/verify/model-sign input=$(base64 <<<"$digest") signature="$SIG"
```

---

## 9) Frases prontas (entrevista)

* “**Segredos não vivem em env var**: uso **Vault Agent** em `/run/secrets` com **TTL curto** e **reload** do app.”
* “**Dinâmico quando possível**: DB/Cloud *short-lived*; KV v2 apenas onde inevitável, sempre com **rotação**.”
* “**Transit** faz o *envelope encryption* e **assinatura**; as chaves **nunca** saem do Vault.”
* “Tenho **auditoria obrigatória** com WORM e **evidence links** para compliance; *access reviews* periódicos.”
