# Z8-2.3 — Key Management, KMS/HSM & PKI

- ↩️ [Voltar ao Z8 — Security & Trust Services](./Z8-index.md)
- ↩️ [Voltar ao README — Mapa Z0–Z9](../../README.md)

> **Resumo**: Esta camada governa **chaves criptográficas** (criação, rotação, uso, revogação), **assinaturas/attestations** e a **PKI** (certificados TLS/mTLS). É a base para **sigilo, integridade e autenticação** em todo o pipeline (Z1–Z7) e alimenta a auditoria (Z9). No lab, **Vault Transit/PKI** simulam um KMS; em produção, integre com **KMS + HSM**.

---

## 1) Objetivos & Escopo

**Objetivos**

* Centralizar **ciclo de vida de chaves**: geração segura, **políticas de uso**, rotação, revogação e destruição segura.
* Oferecer **cripto como serviço** (*envelope encryption*, **HMAC/Sign/Verify**) sem expor chaves-mestras ao app.
* Operar **PKI** (CA *root* e *intermediárias*) para **TLS/mTLS** entre serviços e clientes (S2S, M2M).
* Prover **assinaturas e attestations** (imagens, modelos, SBOM) e verificação em **Z5/Z6**.

**Fora de escopo (nesta página)**

* Entrega de segredos/credenciais (ver **Z8-2.2 Vault**).
* Políticas de autorização de APIs (ver **Z8-2.4 OPA/Rego**).

---

## 2) Ameaças principais

* **Exfiltração/uso indevido de chaves** (keys sem controle de uso/escopo).
* **Cripto mal implementada** (bibliotecas inseguras, chaves hardcoded, rotação inexistente).
* **Certificados inválidos** (CA não confiável, CRL/OCSP inoperante, SAN errado).
* **Assinaturas não verificadas** (modelos/imagens sem *verify* no *startup*).
* **Falhas de rotação/backup** (perda de chaves, *outage* por expiração, *vendor lock-in* sem plano B).

---

## 3) Componentes & Controles

### 3.1 KMS (Key Management Service)

* **Papel**: *custódia lógica* de chaves-mestras e API para **encrypt/decrypt**, **sign/verify**, **HMAC**.
* **Policies de uso** por **propósito** e **identidade** (ex.: `model-sign`, `envelope-data`, `pki-ca`).
* **Rotação programada** (chaves-mestras) + **versões** com *grace period*.
* **Logs/auditoria**: quem usou, quando, qual operação, *request id*, *client*.

> *Lab*: usar **Vault Transit** como KMS (ver exemplos).
> *Produção*: KMS gerenciado + integração **HSM** para operações sensíveis.

### 3.2 HSM (Hardware Security Module)

* **Papel**: custódia **física** e execução de operações **dentro do hardware** (FIPS 140-3).
* **Uso típico**: chaves de **CA/assinatura**, **KMS backing**, **wrap/unwrap** de KEKs.
* **Controles**: **SoD**, *M of N* (*quorum*), **auditoria** de comandos, *tamper evidence*.
* **Fluxos**: geração de chaves no HSM; exportação **apenas** em formato embrulhado (se permitido).

### 3.3 PKI (CAs, emissão, revogação)

* **CAs**: *root* offline + **intermediárias** online (server, client/workload).
* **Perfis de cert** (EKU):

  * **ServerAuth** (serviços expostos via gateway),
  * **ClientAuth** (mTLS S2S/M2M),
  * **Workload SPIFFE/SPIRE** (opcional em K8s).
* **Ciclo**: emissão → distribuição → **renovação automática** → **revogação** (CRL/OCSP).
* **Sanidade**: **SAN obrigatório**, chaves **ECDSA P-256**/RSA-3072+, **TTL curto** (horas/dias para workload), *pinning* opcional.

### 3.4 Políticas de uso de chaves (*key-usage policies*)

* Limitar **quem** pode **usar** **qual operação** **em qual contexto**:

  * `kms:sign` **apenas** para `model-sign` por *role* `ml-sec` em **Z5/Z6**.
  * `kms:decrypt` **apenas** para `envelope-data` por serviços de **Z3/Z6**.
* **Deny-by-default**; todas as exceções **com tempo** (JIT) e **evidência** (Z9).

### 3.5 Envelope encryption (dados em repouso/trânsito)

* **Fluxo**: app gera **DEK** (chave de dados), **sela** no KMS (usa KEK); guarda **dados cifrados + DEK selada**.
* **Benefício**: app **nunca** vê KEKs; rotação de KEK **não** re-cifra dados.
* **Integridade**: **HMAC**/AEAD; versionamento de chaves no *header*.

### 3.6 Assinaturas & Attestations (supply chain)

* **O que assinar**: **imagens** (containers), **artefatos** (SBOM), **modelos** (binário + metadados).
* **Quando**: no *build* (CI) e na **promoção** (Z5).
* **Verificação**: no **startup** (Z6) e no **gateway** (Z6-2.1/2.2).
* **Ferramentas**: *cosign* / *in-toto*; **KMS/HSM** como *key material*.

### 3.7 Integrações por zona

* **Z1**: TLS/mTLS no gateway; *client certificates* para produtores sensíveis.
* **Z5**: assinatura/attestation obrigatórias para **registrar** modelo em PROD.
* **Z6**: **startup verification** (só sobe se assinaturas válidas/CA confiável).
* **Z7**: *mTLS + JWT binding* para clientes de alto risco (core/risk/fraud).
* **Z9**: logs de **key-usage**, emissões e falhas de *verify*.

---

## 4) Contratos & Padrões

### 4.1 Nomenclatura/purpose de chaves

```
kms/keys/model-sign/{env}/{tenant}/{model}/{version}
kms/keys/envelope-data/{env}/{domain}
pki/ca/{env}/{type}             # root, int-server, int-client
pki/certs/{env}/{svc}/{role}    # server, client
```

### 4.2 SLOs/limites (lab)

* `p95 kms:encrypt/decrypt` < 200 ms; `p95 sign/verify` < 150 ms.
* **Renovação automática** de certs antes de `80%` do TTL.
* **CRL/OCSP** respondendo em < 1 s; *cache* com *stale-if-error*.

### 4.3 Perfis de certificado (exemplos)

* **Server**: `EKU=ServerAuth`, SAN = `dns:api-gw.lab, dns:svc-x.lab`, TTL 24–72h.
* **Client/Workload**: `EKU=ClientAuth`, SAN = `uri:spiffe://lab/ns/ml/svc-x`, TTL 12–48h.
* **Admin UI** (opcional): `EKU=ServerAuth`, *security headers* e *HSTS* alinhados.

---

## 5) Fluxos de referência

### 5.1 Envelope encryption (Z3/Z6)

1. App gera **DEK** aleatória (32 bytes).
2. Chama **KMS:encrypt** (KEK) → recebe **DEK selada**.
3. Cifra dados com DEK; persiste **{ciphertext, dek_sealed, key_version}**.
4. Para ler, app chama **KMS:decrypt** → recupera DEK; valida **HMAC**; decifra.

### 5.2 Emissão mTLS para serviço (Z6)

1. Workload prova identidade (OIDC/K8s SA) ao **PKI**.
2. PKI emite **certificado de cliente** (TTLs curtos).
3. Serviço **armazenado em tmpfs**; **auto-renew** antes de expirar.
4. Gateway verifica **cadeia** e **SAN**; *policy* pode checar *claims* → **allow**.

### 5.3 Assinatura de modelo + verificação na subida (Z5→Z6)

1. CI gera **digest** do modelo; chama **KMS:sign(model-sign)** → guarda *signature*.
2. **Registry (Z5)** aceita `model + signature + sbom + attestation`.
3. **Z6 startup**: `cosign verify` (ou **KMS:verify**) contra *policy*; se falhar → **não sobe**.

---

## 6) Riscos × Controles × Frameworks

| Risco                                          | Controle                                                      | Referências (ex.)                               |
| ---------------------------------------------- | ------------------------------------------------------------- | ----------------------------------------------- |
| Exposição/uso indevido de chaves               | **KMS/HSM**, **key-usage policies**, SoD, *quorum*, auditoria | NIST **SC-12/SC-13**, 800-57, FIPS 140-3        |
| Dados em repouso sem proteção/rotação inviável | **Envelope encryption** com KEK no KMS; versionamento         | NIST **SC-28**, SSDF/SLSA (supply chain)        |
| mTLS frágil / certificados inválidos           | **PKI** com CA *root* offline, **CRL/OCSP**, SAN/EKU corretos | NIST **SC-23**, 800-52r2                        |
| Artefatos não assinados/verificados            | **Assinatura/attestation** + **verify** em Z5/Z6              | SSDF, SLSA, OWASP Supply Chain                  |
| Expiração inesperada (outage)                  | **Rotação automática**, *alarms*, *grace period*, *staging*   | NIST **CP-9/CP-10** (continuidade), AU-* (logs) |
| Falta de trilhas de uso de chaves              | **Audit** em KMS/PKI, WORM (→ Z9), *evidence links*           | NIST **AU-2/AU-12**, CSA **LOG/GRC**            |

---

## 7) Checklists operacionais

**Antes do go-live**

* [ ] **CAs**: root offline; intermediárias (server/client) com **policy** e **CRL/OCSP**.
* [ ] **KMS**: chaves por **propósito**; **key-usage policies** *deny-by-default*.
* [ ] **Rotação** de KEK planejada; alarmes de **expiração de certs**.
* [ ] **Startup verification** no Z6 (falha = não sobe).
* [ ] **Auditoria** KMS/PKI habilitada → **Z9** (retenção WORM).

**Operação contínua**

* [ ] **Auto-renew** de certs testado; **rekey** periódico.
* [ ] Revisão de **uso de chaves** (quem, o quê, quando); *access review*.
* [ ] Testes de **CRL/OCSP** e *failover*.
* [ ] Exercícios de **rotação de KEK** e **desastre** (table-top).

**Incidente**

* [ ] **Revogar** certs/chaves; atualizar CRL/OCSP; **block-list** temporária.
* [ ] *Forense* em logs KMS/PKI; **evidências** preservadas.
* [ ] Rotacionar artefatos afetados (modelos, imagens); revalidar Z5/Z6.

---

## 8) Exemplos práticos

**8.1 Vault Transit — criar chave e assinar**

```bash
# criar chave para assinatura de modelos
vault write -f transit/keys/model-sign type=ecdsa-p256 allow_plaintext_backup=false

# assinar digest (base64)
vault write transit/sign/model-sign input=$(base64 <<<"$DIGEST")
# verificar
vault write transit/verify/model-sign input=$(base64 <<<"$DIGEST") signature="$SIG"
```

**8.2 Vault PKI — CA intermediária e emissão (server)**

```bash
# gerar CA intermediária
vault write pki_int/intermediate/generate/internal common_name="Lab Server CA" ttl=8760h

# assinar pela root offline (passo fora do cofre) e importar a cert-chain

# emitir cert de servidor (SAN obrigatório)
vault write pki_int/issue/server common_name="api-gw.lab" alt_names="api-gw.lab,svc-x.lab" ttl=72h
```

**8.3 Cosign — assinatura e verificação (modelo)**

```bash
# assinar (usando key no KMS/Transit via provider, ou arquivo/fulcio no lab)
cosign sign-blob --key kms://model-sign <model.bin> > model.sig

# verificar na subida (startup do Z6)
cosign verify-blob --key kms://model-sign --signature model.sig <model.bin>
```

**8.4 Política de uso de chaves (Rego)**

```rego
package z8.kms
default allow = false
allow {
  input.key_purpose == "model-sign"
  input.claims.role == "ml-sec"
  input.env == "prod"
  time.now_ns() - input.claims.session_start < 3600000000000  # 1h
}
```

**8.5 CSR com SAN/EKU (OpenSSL conf — trecho)**

```
[ req ]
prompt = no
distinguished_name = dn
req_extensions = v3_req

[ dn ]
CN = svc-x.lab

[ v3_req ]
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = svc-x.lab
DNS.2 = api-gw.lab
```

---

## 9) Frases prontas (entrevista)

* “**Assinamos modelos/imagens e verificamos no *startup*** — sem *verify*, **não sobe** em Z6.”
* “**Envelope encryption**: o app nunca vê KEK; rotaciono KEK sem recifrar todo o acervo.”
* “**PKI com CA root offline** e **intermediárias**; **SAN/EKU** corretos, **CRL/OCSP** vivos, TTL **curto** para workloads.”
* “**Key-usage policies** *deny-by-default*; operações sensíveis via **HSM**/**KMS** com **auditoria** para Z9.”
