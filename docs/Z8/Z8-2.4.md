# Z8-2.4 — Policy-as-Code & Authorization (OPA/Rego)

- ↩️ [Voltar ao Z8 — Security & Trust Services](./Z8-index.md)
- ↩️ [Voltar ao README — Mapa Z0–Z9](../../README.md)

> **Resumo**: Centraliza **decisões de autorização** e **gates de segurança/compliance** como **código versionado**. Usa **OPA (Open Policy Agent)** com **Rego** para avaliar **ABAC** (tenant/rota/modelo/versão/ambiente), aprovações de **promoção de modelos** (Z5) e decisões **runtime** em **APIs de ingestão/serving** (Z1/Z6/Z7). Todas as decisões geram **evidências** e **auditoria** (→ Z9).

---

## 1) Objetivos & Escopo

**Objetivos**

* Padronizar **autorização fina (ABAC)** e **gates** de promoção/deploy via **policy-as-code**.
* **Desacoplar** lógica de negócio de decisões de segurança/compliance.
* Tornar **auditável e testável** (CI) cada mudança de política; **rollback** previsível (GitOps).
* Fornecer **decisões rápidas** (p95 baixo) com **caching** e **fail-mode** controlado.

**Escopo**

* **Z1**: autorização por rota/tenant/contrato de ingestão.
* **Z5**: *gates* de promoção — requisitos de segurança, risco, ética/LGPD.
* **Z6/Z7**: autorização de inferência online/batch; *feature flags*, *deprecation windows*.

---

## 2) Ameaças principais

* **AuthZ inconsistente** (políticas espalhadas no código).
* **Mudanças sem teste** (introduzem brechas de acesso).
* **Decisão opaca** (sem trilha/evidência).
* **Bypass** (serviços chamando recursos sem passar pelo PEP).
* **Fail-open** acidental (PDP indisponível → tudo permitido).

---

## 3) Componentes & Controles

### 3.1 Padrão arquitetural (PDP/PEP/PIP)

* **PEP (Policy Enforcement Point)**: o **gateway/API** intercepta a requisição, **monta o `input`** e chama o PDP.
* **PDP (Policy Decision Point)**: **OPA** avalia **Rego** e retorna *allow/deny* (+ *reason*, *obligations*).
* **PIP (Policy Information Point)**: fontes de contexto (IdP/JWT, catálogo, registry, KMS, etiquetas do modelo).

**Topologias**

* **Sidecar** (OPA junto do serviço): baixa latência, *bundles* locais.
* **PDP central**: facilita governança; usar **cache** e *circuit breakers*.
* **Admission control** (K8s): Gatekeeper/Kyverno para **políticas de cluster** (imagens assinadas, *namespaces*, *resources*).

### 3.2 Ciclo de vida da política (GitOps)

1. **Authoring** (Rego + *fixtures*).
2. **Tests** (`opa test`, cobertura mínima).
3. **Review** (PR + *owners* de segurança).
4. **Build** (*bundle* assinado).
5. **Staged rollout** (canário, ambiente *np*).
6. **Promote** (tag semântica; changelog).
7. **Rollback** (bundles versionados).

### 3.3 Desenho do `input` (contrato)

Campos mínimos que o **PEP** deve enviar ao **PDP**:

```json
{
  "route": "/api/churn/v2/predict",
  "method": "POST",
  "tenant": "bankA",
  "env": "prod",
  "claims": { "sub": "svc:core-banking", "scopes": ["inference:churn:v2:invoke"], "roles": ["consumer"] },
  "model": { "name": "churn", "version": "v2", "digest": "sha256:...", "signed": true, "bias_score": 0.03 },
  "context": { "client_ip": "203.0.113.10", "mtls": true, "purpose": "risk-scoring" },
  "time": "2025-11-14T23:00:00Z"
}
```

### 3.4 Performance & Resiliência

* **p95 decisão**: alvo < **5–10 ms** (sidecar) / < **20–30 ms** (remoto com cache).
* **Cache** de políticas/decisões; **`stale-if-error`**.
* **Fail-mode** explícito:

  * **Fail-closed** para rotas sensíveis (deny se PDP inoperante).
  * **Fail-open seguro** apenas com *degrade* (ex.: resposta *redacted*).

---

## 4) Contratos & Padrões

### 4.1 Namespaces/Repositório

```
repo: policies-mlsec/
  bundles/
    z1.ingest/
    z5.registry/
    z6.inference/
  rego/
    z1/
    z5/
    z6/
  tests/
    z1/*.rego
    z5/*.rego
    z6/*.rego
```

### 4.2 Convenções de decisão

* **Decision ID** (`dec_id`) único por chamada.
* **Policy digest** (hash do bundle) anexado ao log.
* **Obligations**: ações que o PEP deve executar (ex.: “mascarar campo X”, “registrar *evidence link* Y”).

---

## 5) Fluxos de referência

### 5.1 Gate de promoção (Z5)

1. CI publica **artefatos** (modelo, SBOM, *attestations*, métricas, *bias report*).
2. Registry chama **PDP** com `input` de promoção.
3. Rego verifica **assinaturas**, **score mínimo**, **drift**, **bias**, **vulns ≤ threshold**, **PII policy**, **aprovadores**.
4. Se **allow**, gera **evidence link** e **policy digest**; se **deny**, lista *reasons*.

### 5.2 Autorização de inferência (Z6/Z7)

1. Cliente chama **Inference Gateway** com **JWT + mTLS**.
2. PEP monta `input` (rota/tenant/model/claims).
3. OPA decide **allow/deny** e pode devolver **obligations** (ex.: *redact fields*).
4. Decisão/auditoria → **Z9** (com **dec_id** + **policy_digest**).

### 5.3 Ingestão (Z1)

* Checa **escopos** do produtor, **contrato** do dataset (schema/purpose), **janela de envio**, **rate**, **pii_allowed=false** se rota não permite.

---

## 6) Riscos × Controles × Frameworks

| Risco                                  | Controle                                             | Referências (ex.)                         |
| -------------------------------------- | ---------------------------------------------------- | ----------------------------------------- |
| AuthZ inconsistente/espalhada          | **OPA/Rego** centralizados; **GitOps**; *tests/CI*   | OWASP API1/5; NIST AC-2/AC-6; CSA IAM/AAC |
| Mudança sem validação                  | *Unit tests* (`opa test`), *code owners*, canário    | NIST CM-3/CM-6; SSDF (Governance)         |
| Bypass do mecanismo de política        | **PEP obrigatório** nos gateways; *egress controls*  | NIST SC-7; CSA IVS/SEF                    |
| Falha do PDP libera acesso (fail-open) | **Fail-closed** + *stale-if-error*; *degrade plans*  | NIST SC-24 (fail-safe); CSA TVM           |
| Decisão não auditável                  | **dec_id**, **policy_digest**, *evidence links* → Z9 | NIST AU-2/AU-12; CSA LOG/GRC              |
| *Tenant escape* / escopos excessivos   | **ABAC**, *deny-by-default*, *SoD* nos aprovadores   | NIST AC-6; OWASP ASVS Access Control      |

---

## 7) Checklists operacionais

**Antes do go-live**

* [ ] Repositório de políticas com **tests** e **owners** definidos.
* [ ] **Bundles assinados** e distribuídos (canário → prod).
* [ ] **PEPs** instalados (Z1 gateway, Z6 gateway, Z7 BFF).
* [ ] **Fail-mode** documentado por rota (closed/open-degrade).
* [ ] Painéis/alertas para **deny spikes** e **PDP health**.

**Operação contínua**

* [ ] **Access reviews** por *scope/tenant*.
* [ ] Auditoria de **policy changes** (quem, o quê, por quê).
* [ ] Testes de **rollback** e **disaster recovery** (bundles).
* [ ] *Table-top* de falha do PDP e de decisão incorreta.

---

## 8) Exemplos Rego (trechos)

### 8.1 ABAC por rota/tenant/versão (Z6)

```rego
package z6.authz
default allow = false

allow {
  input.route == sprintf("/api/%s/%s/predict", [input.model.name, input.model.version])
  input.tenant == input.claims.tenant
  some s
  s := input.claims.scopes[_]
  s == sprintf("inference:%s:%s:invoke", [input.model.name, input.model.version])
  input.context.mtls == true
}
```

### 8.2 Gate de promoção de modelo (Z5)

```rego
package z5.gates
default allow = false

signed(input) {
  input.model.signed == true
  startswith(input.model.digest, "sha256:")
}

vulns_ok(input) { input.security.max_cvss < 7.0 }
metrics_ok(input) { input.eval.auc >= 0.80; input.eval.drift <= 0.02 }
bias_ok(input) { input.eval.bias_score <= 0.05 }
approvers_ok(input) { count(input.approvers) >= 2; input.approvers[_] == "ml-sec" }

allow {
  signed(input)
  vulns_ok(input)
  metrics_ok(input)
  bias_ok(input)
  approvers_ok(input)
}
```

### 8.3 Obligation para mascarar PII (Z6/Z7)

```rego
package z6.obligations
mask_fields := {f | f := input.response_fields[_]; f.class == "PII"}
```

### 8.4 Teste de política (`opa test`)

```rego
package z6.authz_test

import data.z6.authz.allow

test_invoke_ok {
  input := {
    "route": "/api/churn/v2/predict",
    "tenant": "bankA",
    "model": {"name": "churn", "version": "v2"},
    "claims": {"tenant": "bankA", "scopes": ["inference:churn:v2:invoke"]},
    "context": {"mtls": true}
  }
  allow with input as input
}
```

---

## 9) Integrações por zona

* **Z1**: PEP no **Ingestion Gateway**; políticas para contrato de rota, *rate*, propósito de coleta.
* **Z5**: *Gates* de promoção com *evidence links*; **policy_digest** salvo no Registry.
* **Z6**: PEP no **Inference Gateway**; ABAC, *feature flags*, *deprecation windows*.
* **Z7**: BFF/consumidores consultam PDP quando necessário (ex.: *view filtering* por perfil).

---

## 10) Frases prontas (entrevista)

* “**Autorização é policy-as-code**: uso **OPA/Rego** com **deny-by-default**, ABAC por **rota/tenant/model/version**.”
* “**Gates de promoção** (Z5) exigem **assinatura**, **SBOM**, **vulns ≤ threshold**, **métricas mínimas** e **bias** dentro do aceitável.”
* “Toda decisão gera **dec_id + policy_digest** e **evidence link** (→ Z9), o que facilita auditoria e *post-mortem*.”
* “Definimos **fail-closed** nas rotas críticas; onde há *degrade*, o PEP aplica **obligations** (ex.: *redaction*).”