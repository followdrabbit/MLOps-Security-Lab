# Z8-2.6 — SIEM/UEBA/SOAR (Detecção & Resposta)

- ↩️ [Voltar ao Z8 — Security & Trust Services](./Z8-index.md)
- ↩️ [Voltar ao README — Mapa Z0–Z9](../../README.md)

> **Resumo**: Consolida **telemetria** de todas as zonas, aplica **detecções** (regras + UEBA), **orquestra respostas** automáticas e preserva **evidências**. Foco em abuso de API, exfiltração, incidentes de LLM (prompt-injection/exfil), supply chain (assinaturas/attestations) e integridade de modelos em produção.

---

## 1) Objetivos & Escopo

**Objetivos**

* **Coletar, normalizar e correlacionar** logs/métricas/traces de Z1–Z7 (+ Z8 audit) em **Z9**.
* Detectar **ataques e desvios** (API abuse, malware upload, LLM exfil/prompt-injection, drift suspeito).
* **Responder** com *playbooks* automatizados (bloqueio WAF/OPA, revogação de *tokens*, *rollback* de modelo).
* Preservar **evidências forenses** (WORM, *evidence links*) e apoiar **compliance**.

**Escopo**

* **Z1** gateway/WAF/AV/CDR → eventos de entrada.
* **Z5** registry/gates → promoção/assinatura/attestation.
* **Z6** inference/LLM gateways & serving → chamadas/decisões/policies.
* **Z7** consumo (BFF/portais/core) → chamadas/autorização.
* **Z8** Vault/KMS/OPA/IdP → auditoria.
* **Z9** como *data plane* de observabilidade/auditoria.

---

## 2) Ameaças principais

* **Abuso de API** (DoS, scraping, uso fora de contrato/propósito).
* **Exfiltração** via respostas (PII em payload, *oversharing* por LLM).
* **Prompt-injection/TOFU** em LLM (desvio de regras, *tool exfil*).
* **Supply chain** (imagem sem assinatura, *attestation* faltante).
* **Modelo comprometido** (carga não assinada, *startup verify* falha).
* **Drift/bias** não detectado levando a prejuízo operacional/regulatório.

---

## 3) Componentes & Controles

### 3.1 Coleta & Normalização

* **Coletores**: OpenTelemetry/Fluent Bit/Beats → **SIEM** (ECS/CEF/JSON).
* **Fontes mínimas**:

  * Z1: API GW, WAF, **Anti-malware/CDR** (resultado + hash), *rate-limit*.
  * Z5: gates de promoção (*allow/deny*, *reasons*, `policy_digest`).
  * Z6: Inference/LLM Gateways (metadados de req/resp, **sem payload sensível**), *startup verify*.
  * Z7: BFF/core (chamadas, *purpose*, *claims*).
  * Z8: **Vault audit**, **KMS key-usage**, **OPA decisions** (decisão + `dec_id`).
* **Enriquecimento**: GeoIP/ASN, *threat intel*, *device fingerprint*, *tenant/owner*.

### 3.2 Integridade & Tempo

* **NTP**/PTP; *clock skew* monitorado.
* **WORM**/retenção conforme LGPD/compliance.
* **Hash encadeado**/*signing* de lotes de logs críticos (Vault audit, KMS, OPA).

### 3.3 Deteções (Regras + UEBA)

* **Determinísticas (Sigma/KQL)**

  * *API abuse*: picos de 4xx/5xx, *burst* fora do perfil, *oversized payload*.
  * **Upload malicioso**: detecção AV/CDR `infected/suspicious`, *zip-bomb* (tamanho expandidos).
  * **Supply chain**: *startup* com assinatura inválida/ausente; *policy_digest* divergente.
  * **DLP**: PII sinalizada em resposta; *egress* não permitido.
* **UEBA/Anomalias**

  * Desvio por **identidade/tenant/rota** (RPM, tamanho, horários, origem).
  * **Serving**: salto na **entropia**/comprimento de resposta; taxa de *errors/latência*.
  * **LLM**: padrão “ignore previous…”, “reveal system prompt”, tentativas de *tool-exfil*.
  * **Drift/bias**: cruzar métricas Z9 (drift > *threshold* + spikes de reclamação/negações).

### 3.4 SOAR — Orquestração & Resposta

* **Playbooks automáticos**:

  * **WAF**: *block/ratelimit* IP/ASN/rota.
  * **OPA**: inserir *deny rule* temporária (rota/tenant/modelo).
  * **IAM/IdP**: revogar *tokens*, forçar *re-auth*.
  * **Vault**: revogar *leases*; **KMS**: rotacionar chaves afetadas.
  * **Serving**: tirar **modelo canário** do ar, **rollback** para versão estável, **pausar batch**.
  * **LLM Gateway**: subir nível de *output redaction* e bloquear *tools* sensíveis.
  * **Ticketing/Notificação**: abrir incidente, acionar on-call, *chatops*.
* **SLA/SLO** (lab sugerido):

  * P1 (exfil/model compromise): **TTD ≤ 5 min**, **TTC ≤ 15 min**.
  * P2 (abuso/DoS controlado): **TTD ≤ 15 min**, **TTC ≤ 60 min**.

### 3.5 Painéis & Métricas

* **API Security**: *deny rate*, 4xx/5xx, *top abusive tenants*, WAF blocks.
* **Model Health**: *startup verify*, latência, erro, **drift/bias**.
* **LLM Security**: *input/output filters hits*, tentativas de *prompt-injection*, *redactions*.
* **Key/Secrets**: *leases* por serviço, erros de Agent, uso de **KMS**.
* **IR**: *MTTD/MTTR/TTC*, *autoblocks*, *playbook success*.

### 3.6 Privacidade em Logs

* **Sem payload sensível** por padrão.
* **Mascaramento/tokenização** de IDs (ver Z8-2.5).
* **Campos mínimos**: `dec_id`, `policy_digest`, `tenant`, `route`, `model.name/version/digest`, `purpose`, `result`.

---

## 4) Contratos & Eventos (esquema de referência)

```json
{
  "event_type": "inference_call",
  "timestamp": "2025-11-14T23:05:00Z",
  "tenant": "bankA",
  "env": "prod",
  "route": "/api/churn/v2/predict",
  "actor": {"id": "svc:core-banking", "mtls": true},
  "model": {"name": "churn", "version": "v2", "digest": "sha256:..."},
  "decision": {"allow": true, "dec_id": "d-9f2...", "policy_digest": "p-81a..."},
  "dlp": {"redactions": 2, "pii_detected": false},
  "perf": {"lat_ms": 38},
  "geo": {"ip": "203.0.113.10", "asn": 13335},
  "purpose": "risk-scoring"
}
```

Outros tipos: `ingest_upload_scan`, `model_startup_verify`, `registry_promotion_gate`, `vault_audit`, `kms_key_usage`, `waf_block`.

---

## 5) Fluxos de referência

### 5.1 Detecção de exfil na saída (LLM/Inference)

1. Gateway (Z6) marca **PII detectada** em *output filter* → evento DLP.
2. Regra SIEM (KQL/Sigma) **correla** `inference_call` + `dlp_hit`.
3. **SOAR** aplica *obligation* OPA (redaction alta) e **WAF ratelimit**; abre ticket P1.

### 5.2 Modelo não assinado tentando subir

1. `model_startup_verify` = *fail* (assinatura inválida).
2. SIEM cria alerta P1.
3. **SOAR** impede *deployment*, **rollback** versão, **notifica** ML-Sec; reúne evidências (Z5 attestation, imagem, SBOM).

### 5.3 Abuso de upload (Z1)

1. Padrão *burst* + `infected` do AV/CDR.
2. **WAF block** do IP/ASN/rota + *quarentena* do arquivo (hash).
3. **SOAR** revoga *token* do produtor, notifica parceiro.

---

## 6) Riscos × Controles × Frameworks

| Risco                                | Controles (nesta página)                                                | Referências (ex.)                           |
| ------------------------------------ | ----------------------------------------------------------------------- | ------------------------------------------- |
| Abuso de API / DoS                   | Regras SIEM + **WAF autoblock**, quotas, *rate-limit*                   | OWASP API4; NIST **SC-5/SC-7**; CSA **IVS** |
| Exfiltração por resposta/LLM         | **DLP hits**, *output filtering*, **SOAR obligation** (redaction/deny)  | NIST **SC-28/AU-***; CSA **DSI/LOG**        |
| Supply chain (sem assinatura/verify) | Alerta de **startup verify falhou**, bloqueio de *deploy*, **rollback** | SSDF/SLSA; NIST **CM-**/**SI-**             |
| Modelo comprometido/desvio perigoso  | Telemetria de **drift/bias** + correlação IR; **pausa/rollback**        | NIST AI RMF (risk mgmt.); CSA **AIS**       |
| Vazamento de segredo/chave           | **Vault/KMS audit** + *autoblock* (revogação/rotação)                   | NIST **AU-12/IA-5/SC-12**                   |
| Falta de evidência/auditoria         | **WORM**, `dec_id`/`policy_digest`, *evidence links*                    | NIST **AU-2/AU-9**; CSA **GRC/LOG**         |

---

## 7) Checklists operacionais

**Antes do go-live**

* [ ] Conectores de **todas as zonas** para o SIEM (incl. Vault/KMS/OPA).
* [ ] **Normalização** (ECS/CEF/JSON) e *PII-safe logging* aplicados.
* [ ] **Regras Sigma/KQL** publicadas (API abuse, DLP, supply chain, LLM).
* [ ] **Playbooks SOAR** testados (WAF/OPA/IAM/Vault/KMS/Serving).
* [ ] **NTP/WORM** e retenção configurados; **dashboards** e **alertas**.

**Operação contínua**

* [ ] *Tuning* de regras/UEBA (reduzir *false-positive*).
* [ ] Testes de **rollback** de modelo e **assinado/verify**.
* [ ] *Drills* trimestrais (exfil por resposta, *prompt-injection*, supply chain).
* [ ] *Access reviews* para playbooks que alteram políticas (SoD).

**Incidente**

* [ ] **Containment** automatizado (WAF/OPA/IAM).
* [ ] Preservar **evidências** (hash, *evidence pack*).
* [ ] **Comunicação** (interno/regulador), *post-mortem* com ações de melhoria.

---

## 8) Exemplos práticos

**8.1 Sigma — pico anômalo de respostas grandes por rota**

```yaml
title: Large API Responses Spike (Possible Exfil)
logsource: { product: webserver, service: api-gateway }
detection:
  sel_route: request.path: "/api/churn/v2/predict"
  sel_size:  response.bytes: ">524288"   # >512KB
  condition: sel_route and sel_size
level: high
fields: [tenant, actor.id, route, response.bytes, dec_id]
```

**8.2 KQL — PII redigida mas com hit repetido (elevar severidade)**

```kql
inference_call
| where dlp.redactions > 0
| summarize hits=count() by tenant, route, bin(1h, timestamp)
| where hits > 50
```

**8.3 SOAR (pseudo) — *prompt-injection* detectada**

```yaml
on_alert: llm_prompt_injection
steps:
  - opa.add_obligation:
      route: "/api/llm/*"
      action: "increase_redaction"
      ttl: "2h"
  - waf.block:
      signature_id: "llm-injection-001"
      ttl: "1h"
  - notify.oncall: { sev: P1, channel: "ml-sec" }
```

**8.4 Regra simples — *startup verify* falhou**

```kql
model_startup_verify
| where allow == false
| where reason in ("signature_invalid","attestation_missing")
```

---

## 9) Frases prontas (entrevista)

* “Todo **allow/deny** carrega `dec_id` e `policy_digest`; correlo com eventos de gateway/registry para **reconstrutibilidade**.”
* “Para **LLM**, coleto *input/output filter hits* e **elevo redaction** via OPA quando detecto *prompt-injection*.”
* “**Startup verification** bloqueia modelo sem assinatura/attestation; **SOAR** faz **rollback** automático.”
* “Logs são **PII-safe** por padrão; evidências ficam em **WORM** com *hash chain*.”
