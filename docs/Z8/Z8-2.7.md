# Z8-2.7 — Data Catalog, Classification & Lineage

- ↩️ [Voltar ao Z8 — Security & Trust Services](./Z8-index.md)
- ↩️ [Voltar ao README — Mapa Z0–Z9](../../README.md)

> **Resumo**: Centraliza **metadados, classificação, contratos e linhagem** dos dados e modelos. Define **quem pode usar o quê e para qual finalidade** (purpose binding), controla **quebras de schema**, e mantém **proveniência** ponta a ponta (Z0→Z7) com **evidências** para auditoria (Z9). Em lab, você pode começar com **YAML + OpenAPI + eventos de lineage**; em produção, integre um catálogo/lineage dedicado.

---

## 1) Objetivos & Escopo

**Objetivos**

* Tornar **descoberta, classificação e governança** explícitas e versionadas.
* Amarrar **acesso a dados/modelos** a **finalidade** (LGPD) + **perfil de risco**.
* Rastrear **proveniência**: da fonte (Z0/Z1) até features (Z3), modelos (Z4/Z5) e serving (Z6/Z7).
* Servir como **fonte de verdade** para **policy-as-code** (Z8-2.4) e **DLP/masking** (Z8-2.5).

**Escopo**

* **Catálogo** de datasets/artefatos (Z2–Z7) + **glossário** de termos.
* **Classificação** (PII/PCI/PHI/Segredo/etc.), **propósito**, **retenção**, **owner/steward**.
* **Contratos de dados** (escrita/leitura) e **gestão de schema** (breaking vs non-breaking).
* **Lineage** operacional e de **supply chain** (artefatos, assinaturas, *policy_digest*).

---

## 2) Ameaças principais

* **Uso fora de propósito** (function creep).
* **Reidentificação** por *joins* não controlados.
* **Quebras de schema** silenciosas (data poisoning estrutural).
* **Lacuna de proveniência** (não se sabe de onde veio o dado/modelo).
* **Inconsistência** entre catálogo e o que roda em produção.

---

## 3) Componentes & Controles

### 3.1 Data Catalog (metadados & glossário)

* Inventaria **datasets, features, modelos, endpoints de inferência, saídas batch**.
* Metadados **técnicos** (schema, formatos, *freshness*, SLOs) e **de negócio** (domínio, dono, glossário).
* **Busca** por nome/coluna/tag; **anchors** para Z1…Z7 (navegação direta do README).

### 3.2 Classificação & Purpose Binding

* Taxonomia **uniforme**: `class` (PII-Básica, PII-Sensível, PCI, PHI, Segredo, Público), `confidentiality`, `criticality`.
* **Purpose** obrigatório (ex.: *risk-scoring*, *fraud-detection*), **legal_basis** (LGPD), **retention_days**.
* Integra com **OPA/Rego** (Z8-2.4) e **DLP/masking** (Z8-2.5) para **decisão runtime**.

### 3.3 Data Contracts (write/read) & Gestão de Schema

* **Contrato de escrita** (produtor→Z1/Z2/Z3): JSON Schema/Expectations; define **compatibilidade**.
* **Contrato de leitura** (Z6/Z7): **OpenAPI versionado**, perfis de saída e **masking** esperado.
* Processo para **breaking change**: *proposal → review → canário → comunicação → cutover*.

### 3.4 Lineage & Proveniência (operacional e ML)

* Eventos de **lineage** por *run* (pipeline, job, *run_id*), com hashes/assinaturas (*policy_digest*).
* Encadeia **dataset → feature → treino → modelo → registry → endpoint → consumidor**.
* Inclui **supply chain**: imagem, SBOM, *attestations*, assinatura de modelo (Z5/Z6).

### 3.5 Governança & Stewardship

* **Owner** (responsável final), **Steward** (operacional/qualidade), **Custodian** (infra).
* **RACI** por dataset/modelo; **SLAs** (atualização, integridade, *freshness*).
* Revisões periódicas (**access review** e **purpose review**).

### 3.6 Integrações (Z1…Z7)

* **Z1**: vincula roteiros/rotas a **contratos de escrita** e **classificação** esperada.
* **Z3**: registra features com **lineage** e **classificação por coluna** (campos PII).
* **Z5**: salva **evidence links** (SBOM, *attestations*, *bias/drift reports*).
* **Z6/Z7**: contratos de leitura (OpenAPI), **masking profiles** e **purpose** consumido.

---

## 4) Contratos & Padrões

### 4.1 Metadado de Dataset (YAML)

```yaml
dataset: churn_events
zone: Z3-curated
domain: risk
owner: squad-risk
steward: data-eng-risk
classification: PII-Basica
confidentiality: internal
criticality: high
purpose: risk-scoring
legal_basis: legitimate_interest
retention_days: 365
pii: true
pii_fields: [cpf, email, phone]
masking_profile: default
tokenization: deterministic-fpe
encryption: field-level (transit/kms)
refresh_sla: "15m"
schema_version: 3
schema_hash: "sha256:..."
read_contract: "../contracts/openapi/churn_v2.yaml"
write_contract: "../contracts/schema/churn_events_v3.json"
lineage_tags:
  - run_id: "airflow:churn_etl:2025-11-14T22:00Z"
  - policy_digest: "z8-opa-bundle:81a..."
```

### 4.2 Contrato de Escrita (JSON Schema — trecho)

```json
{
  "$id": "churn_events_v3.json",
  "type": "object",
  "required": ["event_id", "customer_id", "ts", "channel"],
  "properties": {
    "event_id": {"type": "string"},
    "customer_id": {"type": "string"},
    "ts": {"type": "string", "format": "date-time"},
    "channel": {"enum": ["APP","WEB","ATM"]},
    "email": {"type": "string", "format": "email"}
  },
  "additionalProperties": false,
  "x-compatibility": "non-breaking"
}
```

### 4.3 Contrato de Leitura (OpenAPI — trecho)

```yaml
openapi: 3.0.3
info:
  title: Churn Inference API
  version: "2.1.0"
paths:
  /api/churn/v2/predict:
    post:
      security:
        - mtls_jwt: []
      x-purpose: risk-scoring
      responses:
        "200":
          description: Scored output (masked by profile)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Score"
components:
  schemas:
    Score:
      type: object
      properties:
        customer_id: { type: "string", x-masked: "hash" }
        score: { type: "number" }
        reason_codes: { type: "array", items: { type: "string" } }
```

### 4.4 Evento de Lineage (OpenLineage-like — trecho)

```json
{
  "eventType": "COMPLETE",
  "eventTime": "2025-11-14T22:00:00Z",
  "job": {"namespace": "airflow", "name": "churn_etl"},
  "run": {"runId": "3d8e9a..."},
  "inputs": [{"namespace": "z2.raw", "name": "raw/churn/2025-11-14/*.parquet", "facets": {"classification": {"class": "PII-Basica"}}}],
  "outputs": [{"namespace": "z3.curated", "name": "curated/churn_events_v3", "facets": {"policy_digest": "p-81a..."}}]
}
```

---

## 5) Fluxos de referência

### 5.1 Registro de novo dataset

1. Produtor propõe **metadado YAML** + **JSON Schema** (escrita).
2. **Review** (owner/steward/security); define **class/purpose/retention**.
3. **Z1** valida uploads conforme **write_contract**.
4. **Z3** publica dataset com **lineage** e **classificação por coluna**.

### 5.2 Evolução de schema (non-breaking/breaking)

* **Non-breaking** (`x-compatibility: non-breaking`): *deploy canário* + atualização de consumidores.
* **Breaking**: *proposal* com plano de migração, janelas e **comunicação**; **OPA gate** nega escrita antiga após *cutover*.

### 5.3 Propagação de classificação para runtime

1. Catálogo marca `pii=true`, `masking_profile=default`.
2. **OPA** alimenta Z6/Z7: **decide** perfis de masking por rota/tenant.
3. **DLP** aplica *redaction* automática em respostas; logs PII-safe.

### 5.4 RTBF & Retenção

* Catálogo define `retention_days`; **jobs** de expurgo coletam **evidence link**.
* **RTBF**: localizar registros por identificadores/token; remover/retokenizar.

---

## 6) Riscos × Controles × Frameworks

| Risco                               | Controles (nesta página)                                         | Referências (ex.)                       |
| ----------------------------------- | ---------------------------------------------------------------- | --------------------------------------- |
| Uso fora de propósito (LGPD)        | `purpose` obrigatório, contratos de leitura, **OPA ABAC**        | LGPD; NIST PM-*; CSA **GRC/IAM/AAC**    |
| Reidentificação por *joins*         | **Classificação por coluna**, tokenização/FPE, **context/tweak** | NIST 800-122; CSA **EKM/DSI**           |
| Quebra de schema silenciosa         | **Data contracts + versionamento**, gates OPA, canário           | OWASP ASVS (Data Validation); SSDF      |
| Proveniência incompleta             | **Lineage events** com *run_id* e *policy_digest*                | NIST AU-*; CNCF OpenLineage (conceitos) |
| Inconsistência catálogos ↔ produção | **Anchors** e *checks* de conformidade em CI/CD                  | SSDF; SLSA (supply chain)               |

---

## 7) Checklists operacionais

**Antes do go-live**

* [ ] Taxonomia de **classificação/confidencialidade** publicada.
* [ ] **YAML** de metadados por dataset + **JSON Schema** (escrita) e **OpenAPI** (leitura).
* [ ] **Lineage** integrado ao orquestrador (run_id + policy_digest).
* [ ] **Anchors** entre README ↔ Z1…Z7 ↔ catálogo.
* [ ] **OPA** consome metadados (class/purpose) para decisões.

**Operação contínua**

* [ ] *Access/purpose reviews* mensais.
* [ ] Auditoria de **breaking changes** e *deprecation windows*.
* [ ] Verificação de **consistência** (dataset rodando ↔ catálogo).
* [ ] Monitorar **retention/RTBF** e gerar **evidence packs**.

**Incidente**

* [ ] Congelar **contratos** afetados; bloquear leitura/escrita via OPA.
* [ ] Corrigir **classificação** e reprocessar **lineage**.
* [ ] Notificar consumidores (Z7) e ajustar **OpenAPI**.

---

## 8) Exemplos práticos

**8.1 Comentários SQL com tags (catálogo “pull”)**

```sql
COMMENT ON TABLE curated.churn_events_v3 IS
'{"owner":"squad-risk","classification":"PII-Basica","purpose":"risk-scoring","retention_days":365}';
```

**8.2 Rego — bloquear leitura sem purpose alinhado**

```rego
package z7.read_contract
default allow = false
allow {
  input.dataset == "curated/churn_events_v3"
  input.purpose == "risk-scoring"
  input.claims.tenant == input.tenant
}
```

**8.3 CI — checar metadados obrigatórios (pseudo)**

```bash
yq -e '.dataset and .owner and .classification and .purpose and .retention_days' catalog/*.yaml
```

**8.4 Expectation (Great-Expectations-like — trecho)**

```yaml
expect_table_schema:
  columns:
    - event_id: string
    - customer_id: string
    - ts: datetime
    - channel: { enum: [APP, WEB, ATM] }
```

---

## 9) Frases prontas (entrevista)

* “**Tudo tem dono, classe e propósito** no catálogo; **contratos** regem escrita/leitura e **OPA** aplica no runtime.”
* “A **linhagem** liga Z0→Z7 com **run_id** e **policy_digest**; consigo reconstruir **quem usou o quê, quando e por quê**.”
* “Para **LGPD**, amarro **purpose** à autorização; **DLP/masking** e **tokenização** reduzem exposição em APIs/LLM.”
* “**Breaking change** só com plano e *deprecation window*; consumo em **Z7** é **via API** (OpenAPI), **nunca** direto no bucket.”
