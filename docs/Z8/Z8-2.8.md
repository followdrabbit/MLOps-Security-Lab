# Z8-2.8 — Compliance, Evidence & Audit Trails

- ↩️ [Voltar ao Z8 — Security & Trust Services](./Z8-index.md)
- ↩️ [Voltar ao README — Mapa Z0–Z9](../../README.md)

> **Resumo**: Consolida **conformidade contínua**, **cadeia de custódia** e **rastreabilidade** ponta a ponta. Centraliza **evidências verificáveis** (artefatos assinados, aprovações, *policy digests*, métricas, logs imutáveis) e provê **trilhas de auditoria** com **integridade criptográfica** e **retenção**. Integra Z1…Z7 e aterrissa tudo no **Z9** para observabilidade/forense.

---

## 1) Objetivos & Escopo

**Objetivos**

* Garantir **accountability**: *quem fez o quê, quando, por quê e com qual evidência*.
* Manter **integridade** das trilhas (assinaturas, *hash chains*, WORM/retention).
* Oferecer **compliance-as-code**: controles mapeados a **evidências automatizadas**.
* Suportar **auditorias** internas/externas e **investigações forenses**.

**Escopo**

* **Evidence Store** (artefatos, manifests, aprovações, *attestations*, SBOM).
* **Audit Trails** (eventos normalizados com *dec_id*, *policy_digest* e correlação).
* **Matriz de conformidade** (NIST/CSA/OWASP/LGPD) ↔ **controles** ↔ **evidências**.
* **Continuous Controls Monitoring** (consultas e *checks* automáticos).
* **Retention & Legal Hold**, **access reviews** e **SoD** para aprovadores.

---

## 2) Ameaças principais

* **Falta de evidências** ou evidência fraca (prints, manuais, não reproduzível).
* **Violação de integridade** de logs/artefatos (edição, deleção, *time skew*).
* **Mudanças sem rastreio** (gates ignorados, deploy sem aprovação).
* **Não conformidade regulatória** (retenção/RTBF, segregação de funções, LGPD).
* **Lacuna de cadeia de custódia** (não é possível reconstruir o fluxo Z0→Z7).

---

## 3) Componentes & Controles

### 3.1 Evidence Store (repositório de evidências)

* **Artefatos**: SBOM, *attestations* (in-toto), assinaturas (cosign), *model cards*, *bias/drift reports*, *startup verify*, aprovações (Z5), *changelogs* de políticas (Z8-2.4).
* **Manifests**: *evidence manifests* por *run*/*release*, com *hashes* e *policy digests*.
* **Imutabilidade**: **WORM/retention** (Z2 conceito aplicado ao repositório) + *write-once append logs*.
* **Endereçabilidade**: `evidence_link` único referenciado por registros do Registry (Z5) e pelo SIEM (Z9).

### 3.2 Audit Trails (eventos normalizados)

* **Esquema mínimo**: `dec_id`, `policy_digest`, `tenant`, `actor`, `route/model/version/digest`, `purpose`, `result`, `reasons`.
* **Integridade**: *hash chain* por período (ex.: diário), **assinatura** de blocos, *timestamp* confiável (NTP/TSA).
* **Privacidade**: **PII-safe logging** (ver Z8-2.5), *redaction* por padrão.
* **Correlação**: *trace IDs* (OpenTelemetry) conectando Z1→Z5→Z6→Z7.

### 3.3 Compliance-as-Code & Matriz de Controles

* **Catálogo de requisitos** (ex.: NIST AU-*, SC-*, AC-*, CM-*; CSA CCM LOG/GRC/EKM; OWASP ASVS/Top10; LGPD).
* **Mapeamento**: requisito → **controle técnico/organizacional** → **consulta de evidência**.
* **Automação**: *pipelines* executam *checks* (ex.: “modelo em prod precisa de SBOM + assinatura + gate aprovado”).

### 3.4 Continuous Controls Monitoring (CCM)

* **Consultas** (KQL/SQL/OPA) que validam continuamente:

  * “Todos os endpoints expostos têm **mTLS + OPA** ativo?”
  * “Modelos em **prod** têm `startup_verify=ok` nas últimas 24h?”
  * “Há deploy sem **evidence_link** de gate?”
* **Resultados** viram **alertas** no SIEM e **tickets** (SOAR).

### 3.5 Change/Risk Records (ADR/SCDR/Decisão Ad Hoc)

* **ADR/SCDR**: decisão de arquitetura com **riscos**, **mitigações**, **resíduo** e **motivações**.
* **Decisão ad hoc** (caso fora de padrão): vincular **controles compensatórios** e **prazo**; aprovações com **SoD**.
* **Versionamento** e *anchors* para o Registry/Inference (Z5/Z6).

### 3.6 Retention, Legal Hold & RTBF

* **Retention schedules** por classe/purpose; **legal hold** suspende expurgo.
* **RTBF** (LGPD): localizar, apagar/re-tokenizar, gerar **evidence pack** do cumprimento.

### 3.7 Access Reviews & Segregation of Duties (SoD)

* **Revisões periódicas** de acessos/admin a Z5/Z6/Z8, *playbooks* SOAR e *bundles* OPA.
* **SoD** para quem cria políticas ≠ quem aprova ≠ quem opera release.

---

## 4) Contratos & Padrões

### 4.1 Evidence Manifest (JSON — exemplo)

```json
{
  "release_id": "churn-v2.3.1",
  "time": "2025-11-14T22:10:00Z",
  "registry_ref": "mlflow://models/churn@v2.3.1",
  "artifacts": [
    {"type": "signature", "algo": "sha256", "digest": "sha256:ab...", "signer": "kms:key/model-sign@v4"},
    {"type": "sbom", "format": "spdx", "digest": "sha256:cd...", "url": "evidence://sbom/spdx/churn-v2.3.1.json"},
    {"type": "attestation", "framework": "in-toto", "digest": "sha256:ef...", "url": "evidence://att/churn-v2.3.1.json"},
    {"type": "gate", "decision": "allow", "policy_digest": "p-81a...", "approvers": ["ml-sec","risk"], "url": "evidence://gates/churn-v2.3.1.json"},
    {"type": "eval", "auc": 0.84, "bias_score": 0.03, "drift": 0.01, "digest": "sha256:11...", "url": "evidence://eval/churn-v2.3.1.json"}
  ]
}
```

### 4.2 Evento de Auditoria (mínimo — JSON)

```json
{
  "event_type": "registry_promotion_gate",
  "dec_id": "d-9f2c...",
  "policy_digest": "p-81a...",
  "tenant": "bankA",
  "actor": "svc:ml-registry",
  "model": {"name": "churn", "version": "v2.3.1", "digest": "sha256:ab..."},
  "result": "allow",
  "reasons": ["signed_ok","sbom_ok","vulns_below_threshold","bias_ok","approvers=2"],
  "evidence_link": "evidence://bundle/churn-v2.3.1.manifest.json",
  "ts": "2025-11-14T22:10:07Z"
}
```

### 4.3 *Hash Chain* (conceito — YAML)

```yaml
log_block:
  index: 2025-11-14
  events_hash: "sha256:...aggregate..."
  prev_hash: "sha256:...from-2025-11-13..."
  block_signature: "kms:key/audit-log@v3:MEU_SIG..."
```

### 4.4 Consulta CCM (exemplos)

```kql
// Modelos em produção sem startup verify OK nas últimas 24h
model_startup_verify
| where env == "prod" and allow == false
```

```rego
# Gate obrigatório para promover modelo a prod
package z5.compliance
default allow = false
allow {
  input.artifacts.sbom_ok
  input.artifacts.signature_ok
  input.artifacts.attestation_ok
  input.approvers_count >= 2
}
```

---

## 5) Fluxos de referência

### 5.1 Promoção segura (Z5 → Evidence Store)

1. CI gera **SBOM + attestation**; *scan* de vulnerabilidades.
2. **OPA gate** avalia requisitos; **allow** gera `evidence_link`.
3. Registry salva **manifest** e publica `policy_digest`/`dec_id` nos eventos.

### 5.2 *Startup verification* (Z6)

1. Serviço valida **assinatura** e **attestation** do modelo na subida.
2. Em caso de **fail**: registra evento, **SOAR** bloqueia *deployment* e dispara **rollback**.

### 5.3 Auditoria/forense

1. Investigador coleta por `dec_id`/`evidence_link`.
2. Verifica **hashes/assinaturas** (manifest + bloco de log).
3. Reconstrói linha do tempo Z1→Z5→Z6→Z7 usando *trace IDs*.

### 5.4 RTBF com evidência

1. Solicitação LGPD → localizar registros/token.
2. Executar **erase/re-tokenize**; gerar **evidence pack** (IDs, *who/when*).
3. Atualizar **catalog/lineage** (Z8-2.7).

---

## 6) Riscos × Controles × Frameworks

| Risco                                        | Controles (nesta página)                                        | Referências (ex.)                      |
| -------------------------------------------- | --------------------------------------------------------------- | -------------------------------------- |
| Log/evidência adulterável                    | WORM/retention, *hash chain*, assinatura de blocos, TSA/NTP     | NIST **AU-9/AU-10/AU-12**; CSA **LOG** |
| Deploy sem gate/evidência                    | **Compliance-as-code**, CCM, *deny-by-default* no Registry      | NIST **CM-3/CM-6**; SSDF; SLSA         |
| Falta de trilha de auditoria/cadeia custódia | **Audit schema** + *trace IDs*; *evidence manifests*            | NIST **AU-2/AU-3**; CSA **GRC/LOG**    |
| Não conformidade LGPD (retenção/RTBF)        | **Retention schedules**, **Legal Hold**, **RTBF evidence pack** | LGPD; NIST **CP-9/MP-6**               |
| Conflito de interesse (sem SoD)              | **Access reviews** + **SoD** para políticas/aprovações          | NIST **AC-5/AC-6**; CSA **IAM/AAC**    |

---

## 7) Checklists operacionais

**Antes do go-live**

* [ ] **Evidence Store** criado (WORM + retenção) e acessos com **SoD**.
* [ ] **Esquema de auditoria** definido e aplicado em Z1/Z5/Z6/Z7/Z8.
* [ ] **Matriz de conformidade** mapeada a **consultas automatizadas** (CCM).
* [ ] **Assinaturas** ativas para modelos/artefatos; **SBOM** no pipeline.
* [ ] **NTP/TSA**, *hash chain* e **ass. de blocos** habilitados.

**Operação contínua**

* [ ] Execução de **CCM** (diário/horário) e *dashboards* no Z9.
* [ ] **Access reviews** mensais para Evidence/Registry/OPA.
* [ ] Testes periódicos de **restore** e de **verificação de integridade**.
* [ ] **Table-top** de auditoria regulatória e de incidente de exfiltração.

**Incidente/Auditoria**

* [ ] **Congelar** evidências (legal hold) e coletar **evidence pack**.
* [ ] Validar **assinaturas/hashes**; reconstruir fluxo por *trace IDs*.
* [ ] *Post-mortem* com **ações corretivas** e atualização da matriz.

---

## 8) Exemplos práticos

**8.1 `evidence_pack/manifest.json` (mínimo)**

```json
{
  "case_id": "INC-2025-1101",
  "dec_ids": ["d-9f2c...", "d-71aa..."],
  "evidence_links": [
    "evidence://bundle/churn-v2.3.1.manifest.json",
    "evidence://logs/block-2025-11-14.sig"
  ],
  "hashes": ["sha256:ab...", "sha256:cd..."],
  "verifications": ["signature_ok", "chain_ok"],
  "generated_at": "2025-11-14T23:40:00Z"
}
```

**8.2 `rego` — negar promoção sem evidências mínimas**

```rego
package z5.gate.evidence
default allow = false
allow {
  input.evidence.sbom
  input.evidence.signature
  input.evidence.attestation
  input.evidence.bias_report
  count(input.evidence.approvers) >= 2
}
```

**8.3 Pseudo Makefile — assinar e publicar evidências**

```makefile
evidence:
	opa test policies/...
	cosign sign --key k8s://kms/model-sign ./dist/model.tar
	intoto attest --predicate ./dist/slsa.json --key k8s://kms/model-sign
	spdx-sbom-generator -o ./dist/sbom.spdx.json
	curl -XPUT $(EVIDENCE_STORE)/bundle/$(RELEASE).manifest.json -d @./dist/manifest.json
```

---

## 9) Frases prontas (entrevista)

* “Trato **compliance como código**: cada requisito tem **consulta automática** que produz **evidência verificável** (hash/assinatura).”
* “**Evidências** vivem em **WORM** com **hash chain** e **assinatura de blocos**; toda decisão carrega `dec_id` + `policy_digest`.”
* “Sem **SBOM + assinatura + gate** o Registry **não promove**; em runtime, **startup verify** bloqueia carga inválida.”
* “Para **LGPD**, **retenção/RTBF** são automatizados e **auditáveis** via *evidence packs*.”
