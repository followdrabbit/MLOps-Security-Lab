# Z9-2.1 — Logging Estruturado & Correlação

↩️ [Voltar ao Z9 — Monitoring, Observability & Audit](./Z9-index.md) · ↩️ [Voltar ao README — Mapa Z0–Z9](../../README.md)

> **Resumo**: Define **um formato canônico de logs (JSON)** e **regras de correlação ponta-a-ponta** (request → ingestão → dados → serving → consumo), garantindo **rastreamento**, **auditoria** e **segurança** (sem PII em payloads, redaction, integridade). O `trace_id` nasce no gateway (Z1/Z6) e é propagado por todo o pipeline até Z7, convergindo na Z9.

---

## 1) Objetivos & Escopo

**Objetivos**

* Padronizar **campos de log** (JSON) para todos os serviços (Z1…Z7).
* Garantir **correlação** via `trace_id`/`span_id`/`request_id` e *evidence links*.
* Evitar **exfiltração** em logs: redaction/masking, sem PII/segredos.
* Facilitar **auditoria** e **forense** (cadeia de custódia e políticas aplicadas).

**Escopo**

* **Log canônico** por evento de app/API, ETL, storage, model serving e consumo.
* **Propagação de contexto** (W3C Trace Context) entre serviços.
* **Regras de ingestão** (amostragem, filtros, retenção) e **integridade** (hash/assinatura no nível do bloco – integração com Z8-2.8).

---

## 2) Ameaças & Antipadrões

* **Exfiltração por log**: PII/segredos em mensagens (headers, payloads, stack traces).
* **Log forgery/injection**: entrada do usuário manipulando linhas (CRLF, JSON truncado).
* **Incorrelação**: ausência de `trace_id` impede auditoria (ponta-a-ponta).
* **Cardinalidade explosiva**: chaves de alta cardinalidade quebram índices e custos.
* **Skew temporal**: *drift* de relógio destrói timelines (NTP/TSA ausente).

---

## 3) Componentes & Controles

### 3.1 Esquema Canônico (JSON Log)

**Campos mínimos (todas as zonas):**

* `ts` (ISO-8601 com `Z`), `level` (`INFO/WARN/ERROR`), `env` (`dev/stg/prod`), `zone` (`Z1`…`Z7`), `service`, `component`.
* `trace_id`, `span_id`, `parent_span_id`, `request_id` (separado do trace), `correlation_id` (externo/negócio, opcional).
* **Identidade/tenant**: `actor.type` (`user|svc|partner`), `actor.id`, `tenant`, `scopes` (claims resumidas).
* **Requisição**: `method`, `route` (normalizada), `path_template`, `status`, `latency_ms`, `ip_src` (normalizado), `user_agent` (hash/opcional), `size_in`, `size_out`.
* **Modelo (quando houver)**: `model.name`, `model.version`, `model.digest`, `registry_ref`, `startup_verify` (`ok|fail`).
* **Decisões/políticas**: `policy_digest`, `dec_id`, `opa.allow` (`true/false`), `reasons` (códigos curtos), `evidence_link`.
* **Segurança**: `waf.action`, `av.result` (`clean|infected|suspicious`), `cdr.applied` (`true/false`), `dlp.action` (`pass|mask|block`).
* **Erros (se houver)**: `error.code`, `error.class`, `error.msg` (sanitizado), `error.stack` (desligado por padrão em prod).
* **Padrões Z3/Z5/Z7**: `dataset`, `schema_version`, `read_contract_id`, `purpose`, `output_profile`.

> **Regra**: **sem payloads brutos** em log. IDs sensíveis podem ser **hash/tokens**. Headers críticos (**Authorization**, **Cookie**, **Set-Cookie**) **nunca** logados.

### 3.2 Correlação (Trace/Span/Request)

* Adotar **W3C Trace Context** (`traceparent`, `tracestate`) no gateway (Z1/Z6).
* Propagar `trace_id` e `request_id` via cabeçalhos internos; **regerar** no gateway se ausente.
* Anotar *spans* com **metadados de segurança** (policy results, assinatura de modelo, AV/CDR hits).

### 3.3 Redação & Minimização

* **Allowlist** de campos logáveis; **denylist** para chaves sensíveis.
* **Redaction** automática (regexs) para padrões como CPF, email, cartão.
* **Amostragem** (p.ex., apenas 1% de 200 OK; 100% de 4xx/5xx; *sampling* com *rate limiting*).

### 3.4 Integridade & Cadeia de Custódia

* Logs **append-only**; **WORM/retention** em *object store* (Z2 conceito).
* **Hash chain** e **assinatura de blocos** por janela (ex.: 5 min) – publicado como *evidence link* (ver Z8-2.8).
* **NTP/TSA** para carimbo de tempo confiável.

### 3.5 Qualidade do Log

* **Validação de esquema** (CI/CD e no coletor).
* **KPIs**: `% eventos com trace_id`, `% com tenant`, `% com policy_digest quando aplicável`, erros de parsing < 0,1%.

---

## 4) Contratos & Padrões

### 4.1 JSON Schema — Evento de API (trecho)

```json
{
  "$id": "log.api.v1.json",
  "type": "object",
  "required": ["ts","level","service","zone","trace_id","request_id","status","latency_ms"],
  "properties": {
    "ts": {"type":"string","format":"date-time"},
    "level": {"enum":["DEBUG","INFO","WARN","ERROR"]},
    "env": {"enum":["dev","stg","prod"]},
    "zone": {"pattern":"^Z[0-9]$"},
    "service": {"type":"string"},
    "trace_id": {"type":"string"},
    "span_id": {"type":"string"},
    "request_id": {"type":"string"},
    "actor": {
      "type":"object",
      "properties": {
        "type":{"enum":["user","svc","partner"]},
        "id":{"type":"string"}
      }
    },
    "tenant":{"type":"string"},
    "method":{"type":"string"},
    "route":{"type":"string"},
    "status":{"type":"integer"},
    "latency_ms":{"type":"number"},
    "model": {
      "type":"object",
      "properties": {
        "name":{"type":"string"},
        "version":{"type":"string"},
        "digest":{"type":"string"},
        "startup_verify":{"enum":["ok","fail","n/a"]}
      }
    },
    "policy_digest":{"type":"string"},
    "dec_id":{"type":"string"},
    "evidence_link":{"type":"string"}
  },
  "additionalProperties": true
}
```

### 4.2 Mapeamento OpenTelemetry (exemplo)

* **Atributos comuns**:

  * `service.name`, `deployment.environment`, `cloud.region`
  * `enduser.id` (hash), `http.route`, `http.target`, `http.status_code`
  * `ml.model.name`, `ml.model.version`, `ml.model.digest`
  * `sec.policy.digest`, `sec.decision.id`, `sec.waf.action`, `sec.av.result`

### 4.3 Cabeçalhos de correlação

* **Entrada externa**: gerar `X-Request-ID` (UUIDv4) e **W3C `traceparent`** no gateway.
* **Upstream interno**: sempre **propagar**; nunca substituir `trace_id` no meio da cadeia.

---

## 5) Fluxos de Referência

### 5.1 Requisição online (Z6 → Z7)

1. **Z6 Gateway** recebe requisição → cria `trace_id`/`request_id` → loga `route`, `actor`, `tenant`.
2. **OPA** avalia política → `policy_digest`, `dec_id` adicionados ao *span*.
3. **Model Serving** executa → anota `model.*`, `latency_ms`, `startup_verify`.
4. **Z7** registra consumo e **custo** (se LLM) com o **mesmo `trace_id`**.
5. Todos os eventos fluem para Z9 como **linhas JSON correlacionadas**.

### 5.2 Upload seguro (Z1 → Z2)

1. **Z1** processa WAF/AV/CDR → loga `waf.action`, `av.result`, `cdr.applied`.
2. **ETL/MQ** escreve no **Raw** (Z2) → auditoria de PUT com `trace_id` herdado.
3. Z9 consolida e permite reconstruir a linha do tempo.

---

## 6) Riscos × Controles × Frameworks

| Risco                              | Controle (nesta página)                                     | Referências úteis*                   |
| ---------------------------------- | ----------------------------------------------------------- | ------------------------------------ |
| PII/segredos vazando em logs       | 3.3 Redaction/denylist/allowlist; **sem payload bruto**     | OWASP ASVS (V7/V9); NIST AU-3/AU-13  |
| Falta de correlação ponta-a-ponta  | 3.2 Trace/Span + W3C Context; 4.3 cabeçalhos                | OWASP A09; NIST AU-2/AU-12           |
| Integridade fraca (edição/remoção) | 3.4 WORM + hash chain + assinatura + NTP/TSA                | NIST AU-9/AU-10; CSA CCM LOG/GRC     |
| Custos/ruído (cardinalidade alta)  | 3.3 amostragem + normalização de chaves; schema e KPIs      | SRE SLO/Error Budget                 |
| Injeção/forgery em logs            | Serialização **estruturada** (JSON) + sanitização de inputs | OWASP Cheat Sheets (Logging, Output) |

> *Use também Z8-2.8 para evidências e Z8-2.5 para privacidade/DLP.

---

## 7) Checklists Operacionais

**Antes do go-live**

* [ ] **Biblioteca de logging estruturado** (JSON) em todos os serviços.
* [ ] **Geração de `trace_id`** no gateway; **propagação** testada *e2e*.
* [ ] **Redaction** ativa (CPF, email, cartões, tokens); **denylist** de headers.
* [ ] **Validador de esquema** na ingestão (rejeitar logs inválidos).
* [ ] **NTP** sincronizado; rotação/retention definidas.

**Durante a operação**

* [ ] `% com `trace_id` ≥ 99,5%`; `% com `tenant` ≥ 99%`.
* [ ] Revisar **cardinalidade** e **sampling** mensalmente.
* [ ] Testes de **integridade** (hash/assinatura) por janela.
* [ ] *Drills* de forense: reconstruir um caso **apenas com Z9**.

---

## 8) Exemplos Práticos

### 8.1 Linha de log (API de inferência)

```json
{
  "ts":"2025-11-15T23:42:10Z",
  "level":"INFO",
  "env":"prod",
  "zone":"Z6",
  "service":"inference-gateway",
  "trace_id":"4f43a4b5c3c942a9",
  "request_id":"f0d2f7a1-6f9e-4d51-9b1d-0a1c3a6f2d33",
  "actor":{"type":"svc","id":"core-risk"},
  "tenant":"bankA",
  "method":"POST",
  "route":"/api/churn/v2/predict",
  "status":200,
  "latency_ms":42.7,
  "model":{"name":"churn","version":"v2.3.1","digest":"sha256:ab...","startup_verify":"ok"},
  "policy_digest":"p-81a...",
  "dec_id":"d-9f2c...",
  "evidence_link":"evidence://bundle/churn-v2.3.1.manifest.json"
}
```

### 8.2 Middleware (FastAPI) — *pseudo-código*

```python
@app.middleware("http")
async def log_ctx(request, call_next):
    trace_id = request.headers.get("traceparent") or gen_trace_id()
    request_id = request.headers.get("x-request-id") or gen_uuid()
    set_ctx(trace_id=trace_id, request_id=request_id)
    start = now()
    resp = await call_next(request)
    log_json({
      "ts": now_iso(),
      "level": "INFO",
      "env": ENV,
      "zone": "Z6",
      "service": "inference-api",
      "trace_id": trace_id,
      "request_id": request_id,
      "method": request.method,
      "route": normalize_route(request.url.path),
      "status": resp.status_code,
      "latency_ms": ms_since(start)
    })
    return resp
```

### 8.3 Redaction (regexs — pseudo)

```yaml
redact:
  - name: cpf
    pattern: '\b\d{3}\.\d{3}\.\d{3}\-\d{2}\b'
    replace: '[CPF]'
  - name: email
    pattern: '[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}'
    replace: '[EMAIL]'
  - name: bearer
    pattern: 'Authorization:\s*Bearer\s+[A-Za-z0-9\._-]+'
    replace: 'Authorization: Bearer [REDACTED]'
```

---

## 9) Frases prontas (entrevista)

* “**Todos os serviços logam em JSON** com `trace_id` e **policy/evidence links**, então eu consigo **auditar qualquer decisão** ponta-a-ponta.”
* “**Sem payload bruto** em logs; aplico **redaction/minimização** e **sampling** para conter custos e risco.”
* “Uso **W3C Trace Context** e anoto **resultados de OPA/WAF/AV/CDR** nos spans; **hash chain + WORM** asseguram integridade.”
