# Z9-2.10 ‚Äî Continuous Controls Monitoring (CCM) & Control Health

‚Ü©Ô∏è Voltar: [Z9 ‚Äî Monitoring, Observability & Audit](./Z9-index.md) ¬∑ Relacionados: Z8-2.4 (Policy-as-Code), Z8-2.6 (SIEM/UEBA/SOAR), Z9-2.6 (Auditoria/Evidence), Z9-2.7 (Alerting/SLOs)

> **Resumo**: Observabilidade **do estado e da efic√°cia dos controles** (seguran√ßa, privacidade e governan√ßa) em todas as zonas **Z1‚ÄìZ8**. Mede **se os controles est√£o ativos, atualizados e funcionando**, coleta **evid√™ncias autom√°ticas**, gera **scorecards** e **alertas** quando um controle degrada ou perde efic√°cia. Fecha o ciclo ‚Äúcontrole definido ‚Üí controle monitorado ‚Üí evid√™ncia ‚Üí auditoria‚Äù.

---

## 1) Objetivos & Escopo

**Objetivos**

* Verificar **continuidade, cobertura e efic√°cia** de controles cr√≠ticos (WAF, AuthZ, mTLS, AV/CDR, S3 Object Lock, assinatura de modelos, OPA/Rego, Vault, KMS, DLP, etc.).
* Gerar **evid√™ncias automatizadas** para auditoria (Z9-2.6), reduzindo esfor√ßo manual.
* Alimentar **scorecards executivos** e **SLOs de controles** (ex.: ‚Äú% de modelos servidos com verifica√ß√£o de assinatura ativa‚Äù).

**Escopo**

* **Controles preventivos, detectivos e corretivos** nas camadas: Z1 (borda) ‚Üí Z6 (serving/LLM) ‚Üí Z8 (servi√ßos transversais).
* **Conformidade operacional** (policy bundles v√°lidos, chaves dentro da janela de rota√ß√£o, leases do Vault, etc.) e **efic√°cia** (ex.: WAF bloqueando ataques reais, DLP evitando PII em logs).

---

## 2) Modelo de dados ‚Äî Evento de ‚ÄúControl Health‚Äù

Formato m√≠nimo (JSON) para cada verifica√ß√£o autom√°tica:

```json
{
  "ts": "2025-11-15T23:45:00Z",
  "control_id": "Z6.SIGN.VERIFY_MODEL_AT_STARTUP",
  "zone": "Z6",
  "service": "inference-runtime",
  "target": {"model":"churn","version":"2.3.1"},
  "status": "pass",         // pass | warn | fail | unknown
  "evidence_ref": "s3://evidence/attestations/churn-2.3.1.json",
  "details": {
    "signature_verified": true,
    "cosign_bundle_sha256": "a1b2c3...",
    "policy_digest": "sha256:..."
  },
  "next_check_in": "2025-11-16T00:00:00Z"
}
```

> **Observa√ß√£o**: n√£o armazenar PII/payload. Apenas metadados e *links* para evid√™ncias WORM (Z9-2.6).

---

## 3) Cat√°logo de Controles & Probes (exemplos por zona)

### 3.1 Z1 ‚Äî Ingestion & Security Gateway

* **Z1.WAF.RULEPACK_LOADED**: vers√£o do rulepack atual ‚â• X; auto-test de URL maliciosa retorna **block**.
* **Z1.GW.RATE_LIMIT_ACTIVE**: chamadas de teste acima do limiar ‚Üí **429**.
* **Z1.AV.MULTI_ENGINE**: *healthcheck* dos engines; **scan recursivo** com limites anti zip-bomb ativo.
* **Z1.CDR.ACTIVE**: upload de PDF com JS embutido ‚Üí **sanitizado**.
* **Z1.AUTHZ.DENY_BY_DEFAULT**: rota sem *scope* adequado ‚Üí **403**.
* **Z1.TLS.MTLS_REQUIRED_PARTNER**: cliente sem certificado v√°lido ‚Üí **fail**.

### 3.2 Z2/Z3 ‚Äî Dados (Raw/Curated/Feature)

* **Z2.S3.OBJECT_LOCK_ENABLED**: buckets cr√≠ticos com WORM/retention e pol√≠tica vigente.
* **Z2.ENCRYPTION.SSE_KMS**: *default bucket policy* exige SSE-KMS (key correta).
* **Z3.DATASET.PROVENANCE**: dataset curado com **lineage completo** (Z8-2.7).
* **Z3.FEATURESTORE.AUTHZ**: acesso via *service account* com *scopes* m√≠nimos; leitura direta sem gateway ‚Üí **bloqueada**.

### 3.3 Z4 ‚Äî Model Factory

* **Z4.CI.SBOM_PRESENT**: builds com SBOM anexada; scanners (SAST/DAST/deps) executados.
* **Z4.CONTAINER.SIGNED_BASE**: imagem base **assinada** e verificada (*cosign*).
* **Z4.DATASET.APPROVED**: jobs de treino consomem somente datasets aprovados (marcados no cat√°logo).

### 3.4 Z5 ‚Äî Registry & Governance

* **Z5.MODEL.SIGNED**: apenas vers√µes **assinadas** podem ser marcadas como *prod*.
* **Z5.GATE.APPROVALS**: promo√ß√£o exige **approvers** e **policy check** (OPA) registrado.
* **Z5.ATTESTATIONS.PRESENT**: *in-toto* / *SLSA provenance* anexadas ao *artifact*.

### 3.5 Z6 ‚Äî Serving & LLM Gateway

* **Z6.SIGN.VERIFY_MODEL_AT_STARTUP**: verifica√ß√£o de assinatura/attestation no *startup*.
* **Z6.MTLS.ENFORCED**: *pods* e *gateway* com **mTLS estrito**; certificados v√°lidos/atuais.
* **Z6.AUTHZ.OPA_ENFORCED**: decis√µes **deny-by-default**, *bundles* de pol√≠ticas atualizados.
* **Z6.LLM.GATEWAY_FILTERS**: filtros de **prompt/input/output**, DLP e PII masking **ativos**.
* **Z6.CACHE.LAST_K_ENABLED**: *cache* para rotas LLM cr√≠ticas habilitado.

### 3.6 Z7 ‚Äî Consumers

* **Z7.ACCESS.VIA_API_ONLY**: consumo sempre **via gateway Z6**, nunca direto do bucket (Regra de Ouro).
* **Z7.CONTRACT.OPENAPI_VERSIONED**: cliente usa vers√£o suportada (janela de *deprecation* v√°lida).

### 3.7 Z8 ‚Äî Security & Trust Services

* **Z8.VAULT.AGENT_RUNNING**: *leases* v√°lidos; zero *hardcoded secrets*.
* **Z8.KMS.KEY_ROTATION_WINDOW**: chaves dentro da janela m√°xima de rota√ß√£o; sem expira√ß√£o iminente.
* **Z8.PKI.CERT_EXPIRY_WINDOW**: certificados com anteced√™ncia de renova√ß√£o configurada (ex.: 30 dias).
* **Z8.OPA.BUNDLE_FRESH**: *bundles* de pol√≠tica recentes/assinados; *rollback* testado.
* **Z8.DLP.LOGS_WITHOUT_PII**: amostragem de logs sens√≠veis ‚Üí sem PII (mascaramento efetivo).

---

## 4) Scorecards & SLOs de Controles

### 4.1 Indicadores (exemplos)

* **Cobertura**: `% de servi√ßos com mTLS estrito` (meta: ‚â• 99%).
* **Efic√°cia**: `% de uploads maliciosos bloqueados na borda` (meta: 100%).
* **Conformidade**: `% de modelos em *prod* com *attestations* v√°lidas` (meta: 100%).
* **Atualidade**: `% de pol√≠ticas OPA atualizadas (<24h)` (meta: ‚â• 99.5%).

### 4.2 Sem√°foro por controle

| Controle                        | Meta | Status | Notas                                       |
| ------------------------------- | ---: | :----: | ------------------------------------------- |
| Z6.SIGN.VERIFY_MODEL_AT_STARTUP | 100% |   üü¢   | Todos os *deployments* verificam assinatura |
| Z1.AV.MULTI_ENGINE              | 100% |   üü°   | Engine-2 intermitente em `sa-east-1`        |
| Z8.KMS.KEY_ROTATION_WINDOW      | 100% |   üî¥   | 2 chaves expiram em 7 dias                  |

---

## 5) Alertas & Regras (exemplos)

### 5.1 PromQL ‚Äî Bundle OPA desatualizado

```promql
time() - opa_policy_bundle_timestamp_seconds{zone="Z6"} > 86400
```

### 5.2 PromQL ‚Äî mTLS ausente em rota cr√≠tica

```promql
sum(traffic_without_mtls{route=~"/api/(churn|fraud)/.*"}) > 0
```

### 5.3 PromQL ‚Äî WORM desabilitado em bucket cr√≠tico

```promql
min_over_time(s3_object_lock_enabled{bucket="raw-train-critical"}[15m]) == 0
```

### 5.4 OPA/Rego ‚Äî negar *promote* sem attestation

```rego
package z9.ccm.promote_guard
default allow = false
allow {
  input.action == "model.promote"
  input.attestations.present
  input.signature.verified
}
```

---

## 6) Dashboards recomendados

* **Mapa de Controles por Zona (Z1‚ÄìZ8)** com cobertura, falhas abertas e tend√™ncia.
* **Linha do Tempo de Efic√°cia** (bloqueios WAF, DLP hits, policy denies) por tenant/rota.
* **Validade de chaves/certificados** (KMS/PKI) com *drill-down*.
* **Estado do Vault & Segredos** (leases, *agent status*, *secrets sprawl* zero).

---

## 7) Integra√ß√µes

* **SIEM/UEBA/SOAR (Z8-2.6)**: ingest√£o de *control-health events* e execu√ß√£o de *playbooks* (ex.: bloquear rota, for√ßar *policy refresh*).
* **Evidence Store (Z9-2.6)**: arquivar *snapshots* de *scorecards* e *probes* assinados (WORM).
* **Registry (Z5)**: travar promo√ß√£o/rollback com base no **estado dos controles**.
* **CI/CD (Docs 06)**: *gates* que impedem *deploy* quando *control SLOs* est√£o em vermelho.

---

## 8) Riscos √ó Controles √ó Frameworks

| Risco                                            | Controles neste m√≥dulo                               | Conex√µes       |
| ------------------------------------------------ | ---------------------------------------------------- | -------------- |
| **Controles ‚Äúno papel‚Äù, n√£o ativos**             | *Probes* automatizados + scorecards + alertas        | Z8-2.4, Z9-2.7 |
| **Perda de efic√°cia sem perceber**               | M√©tricas de **efic√°cia** (bloqueios reais, DLP hits) | Z1, Z6, Z8     |
| **Falha de conformidade**                        | Evid√™ncias autom√°ticas (WORM) + *gates* de promo√ß√£o  | Z5, Z9-2.6     |
| **Janela de risco (chaves/pol√≠ticas expirando)** | Monitora√ß√£o de **validade/rota√ß√£o** com *lead time*  | Z8-2.3, Z8-2.4 |

> **Referenciais** (exemplos): NIST SP 800-53 (CA/CM/SC/IA/AU), ISO 27001 (A.5/A.8/A.12), **CSA CCM**, **OWASP ASVS/Top10/API**, **SSDF/SLSA** (supply chain).

---

## 9) Checklists

**Antes do go-live**

* [ ] Cat√°logo de **control IDs** e **probes** por zona, com metas e severidade.
* [ ] Gera√ß√£o de **eventos padronizados** de *control health* + envio para Z9.
* [ ] **Scorecards** e **alertas** publicados (Prometheus/Alertmanager + SIEM).
* [ ] Integra√ß√£o com **gates** do CI/CD e do **registry** (promo√ß√£o condicionada).

**Opera√ß√£o**

* [ ] Revis√£o semanal dos **controles em amarelo/vermelho** e CAPA associadas.
* [ ] Verifica√ß√£o mensal de **efic√°cia** (testes sint√©ticos de WAF/DLP/AuthZ).
* [ ] Auditoria trimestral de **evid√™ncias** (snapshots WORM + *chain-of-custody*).
* [ ] *Game days* de **falha de controle** (ex.: simular bundle OPA inv√°lido).

---

## 10) Frases prontas (entrevista)

* ‚ÄúEu monitoro **estado e efic√°cia** dos controles com **CCM**: WAF/AV/CDR, **Assinatura de modelos**, **mTLS/OPA**, **Vault/KMS**, **DLP** ‚Äî tudo com **probes autom√°ticos** e **scorecards** por zona.‚Äù
* ‚ÄúPromo√ß√£o/rollback no **registry** √© **gateada** por **control health**; se OPA/WORM/mTLS n√£o est√£o verdes, **n√£o sobe**.‚Äù
* ‚ÄúGeramos **evid√™ncias autom√°ticas** (WORM + hash-chain) e alertamos **SRE/SOC** quando controle degrada, com *playbooks* no **SOAR** para resposta r√°pida.‚Äù
