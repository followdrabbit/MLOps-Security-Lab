# Z9-2.2 — Métricas, SLOs & Painéis

## 1) Objetivo & escopo

Padronizar **SLIs/SLOs**, dimensões e painéis que consolidam a observabilidade **fim-a-fim** (Z1→…→Z7) e alimentam detecção/resposta (Z8→Z9). Z1 e Z2 já enviam eventos/telemetria para o **Z9** (ingestão, auditoria e acesso), o que permite correlação com identidades, pipelines e modelos.  

---

## 2) Dimensões canônicas (labels)

Para todas as métricas, padronize **labels**:

* `zone` (Z1…Z7), `service`, `env`, `tenant`, `route`, `model_name`, `model_version`,
  `release_id` (Z5), `run_id` (treino/ETL), `policy_digest` (snapshot Rego), `consumer_id` (Z7),
  `dataset`/`feature`, `status_code`, `decision` (allow/deny), `reason` (policy, AV, CDR, DLP).

> Essas chaves permitem “seguir o rastro” — da chamada no gateway (Z1/Z6) ao acesso de dados (Z2/Z3), consumo (Z7) e eventos de promoção/revogação (Z5). 

---

## 3) SLIs por domínio

### 3.1 APIs (Z6 — online; Z1 — borda)

* **Disponibilidade**: % de janelas sem *5xx/unavailable* por rota/tenant.
* **Latência**: p50/p95/p99 por `route`×`tenant`; **SLO** típico: p95 ≤ 300 ms (online).
  Z7 exige acompanhar p95/p99 **por rota/tenant**. 
* **Taxa de erro**: 4xx/5xx por causa (Auth/WAF/Policy/Timeout/Upstream).
* **Saturação**: CPU/Mem/FD/ThreadPool; fila do worker e *queue time*.
* **Custo por chamada/tenant** (tokens, CPUms, $): rastreado no consumo. 

### 3.2 Consumo (Z7)

* **Custo por consumidor** e **por rota**; **hit-ratio de `/last`** (cache) e **limites/quotas**.
  Métricas requeridas: *p95/p99*, taxa de erro, **custo** e **hit-ratio** por rota/tenant.  
* **Enumeração/abuso**: consultas amplas/minutagem ⇒ alertas. 

### 3.3 Dados (Z2/Z3)

* **Ingest throughput** (req/s, bytes/s), **reject rate** por motivo (schema/WAF/AV/CDR),
  **quarentena** (contagem, idade média) e **hash mismatch** (integridade).
* **Logs de acesso e trilhas** para Z9 com **correlação** (quem/quê/quando). 
* **Qualidade & drift** (Z3): alarmes para **queda de qualidade** e **mudanças bruscas de distribuição**. 

### 3.4 Registro & Governança (Z5)

* **Release timeline** por versão: `promotion`, `revocation`, *approval lead-time*,
  **assinatura/attestation** OK/falha; painéis *per-version*. 

### 3.5 Segurança (Z8)

* **AuthZ (OPA)**: allow/deny por política, *drift* de regras; **DLP/masking** acionado;
  **SIEM/UEBA/SOAR** ingestindo logs/métricas/traces de Z1/Z6/Z7 → Z9. 

---

## 4) SLOs recomendados (exemplos)

> Ajuste metas por criticidade/rota; use **SLOs por rota/tenant** (Z7) com **quotas**. 

* **Disponibilidade (online)**: 99.9%/30d (rota crítica). Alerta *burn-rate* 14× (2h) e 6× (24h).
* **Latência**: p95 ≤ 300 ms (prod), p99 ≤ 800 ms.
* **Erros**: 5xx ≤ 0.05%; 4xx *policy-denied* ≥ 95% explicáveis (com `reason`).
* **Custo**: teto $/tenant/dia; alerta em 80% da cota.
* **Dados**: *reject rate* (schema/AV/CDR) ≤ 1%; **quarentena vazia** ≤ 24 h.
* **Qualidade (Z3)**: PSI/JS < 0.2; *DQ score* ≥ 0.98 por tabela crítica.

---

## 5) Painéis (dashboards)

1. **Executivo (C-level)**
   *Disponibilidade*, *erros*, *latência p95*, **custo por produto/tenant**, releases recentes (Z5).
2. **Operação (NOC/SRE)**
   Tráfego, filas, saturação, *rate limiting*, *error budget*, *top N* rotas/tenants.
3. **Segurança (SOC)**
   WAF/AV/CDR/DLP acionados, *policy denies*, *anomalies UEBA*, incidentes e *playbooks*.
4. **Dados (Z2/Z3)**
   Ingest/ETL, *rejects*, integridade (hash/assinatura), *drift*, *quarentena*.
5. **Model Serving (Z6)**
   Latência por versão, *cache hit*, *warmups*, verificação de assinatura/políticas (startup).
6. **Consumo (Z7)**
   p95/p99 por rota/tenant, **custo**, **hit-ratio `/last`**, *quotas* e *depreciações*. 

---

## 6) Alertas (playbooks acoplados ao SOAR)

* **Latência p95 > SLO** (5 min) ⇒ checar saturação, *autoscale*, *cache warm*.
* **Erro 5xx spike** (3× baseline/15 min) ⇒ *roll-back canário*, health dos *upstreams*.
* **Custo** > 80% cota/dia (tenant) ⇒ throttling/prompts menores/limite de contexto. 
* **Reject AV/CDR** > 0.5%/h ⇒ testar amostra; possível campanha maliciosa (Z1).
* **DLP/Masking** hits em respostas ⇒ bloquear rota, inspecionar *policy* (Z8). 

> Todos os alertas geram eventos no SIEM/UEBA/SOAR (Z8) e são guardados no Z9. 

---

## 7) Exemplos (consultas/contratos)

**Ex.1 — Latência p95 por rota/tenant (PromQL):**

```promql
histogram_quantile(
  0.95,
  sum(rate(http_server_duration_bucket{zone="Z6"}[5m])) by (le, route, tenant)
)
```

**Ex.2 — Custo por consumidor (por hora):**

```promql
sum by (tenant, route) (rate(inference_cost_usd_total{zone="Z7"}[1h]))
```

**Ex.3 — Rejects por motivo (ingest):**

```promql
sum by (reason) (rate(ingest_reject_total{zone="Z1"}[10m]))
```

---

## 8) Retenção, amostragem & privacidade

* **Retenção**: 13 m (métricas agregadas), 30–90 d (logs detalhados).
* **Amostragem de *traces***: 10% padrão; 100% para erros/rotas críticas.
* **Privacidade**: **sem PII em logs**; *redaction/tokenização* em campos sensíveis (conforme Z8). 

---

## 9) Checklists

**Antes do go-live**

* [ ] SLOs por **rota/tenant** definidos (Z7) e **quotas** aplicadas. 
* [ ] Exporters/histogramas configurados (latência p50/p95/p99 por rota). 
* [ ] Pipelines enviando *rejects* com `reason` (schema/AV/CDR/DLP/Policy). 
* [ ] Painéis por público (Exec/Oper/Sec/Dados/Serving/Consumo) publicados.
* [ ] Integração de eventos de **release/promoção/revogação** (Z5). 

**Durante operação**

* [ ] *Error-budget* monitorado; burn-rate alerts em 2h/24h.
* [ ] *Access reviews* (Z7) e *policy drift* (Z8) revistos mensalmente.  
* [ ] Anomalias de qualidade/drift (Z3) investigadas e anotadas. 

---

### Notas de alinhamento

* Este módulo usa as mesmas **métricas de consumo** (p95/p99, erro, custo, *hit-ratio*) exigidas por Z7 e centraliza os **logs de acesso** e **auditoria** de Z1/Z2.   
* Integra com o **SIEM/UEBA/SOAR** da Z8 para fechar o ciclo de **detecção e resposta**. 
