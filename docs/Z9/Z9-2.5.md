# Z9-2.5 — Detecção de Anomalias & UEBA (User/Entity Behavior Analytics)

↩️ [Voltar ao Z9 — Monitoring, Observability & Audit](./Z9-index.md) · ↩️ [Voltar ao README — Mapa Z0–Z9](../../README.md)

> **Resumo**: Converte **logs/métricas/traces padronizados** (Z9-2.1/2.2/2.3) em **sinais de anomalia operacionais e de segurança**. Perfila **usuários, serviços e parceiros (UEBA)**, detecta **desvios estatísticos/ML** e envia **alertas qualificados** para o **SIEM/UEBA/SOAR** (Z8-2.6) com **evidências** para auditoria (Z8-2.8). Inclui detectores específicos para **LLMs/GenAI**.

---

## 1) Objetivos & escopo

**Objetivos**

* Detectar **abuso de API**, **uso fora de propósito**, **fraudes** e **anomalias operacionais** (latência/custo).
* Aprender **baselines por identidade/tenant/rota/modelo** e identificar desvios significativos.
* Gerar **alertas enriquecidos** (quem/quando/onde/por quê) com **minimização de falsos positivos**.

**Escopo**

* **Fontes**: eventos de Z1 (WAF/AV/CDR), Z6 (gateway/serving/LLM), Z7 (consumo), Z2/Z3 (acessos a dados), Z5 (promoções/revogação).
* **Sinais**: taxas, contagens, custo/tokens, padrões de chamadas, payload size, decisões de política (OPA), resultados DLP/mascaração, *drift* e *bias* (Z9-2.4).

---

## 2) Sinais & features por domínio

### 2.1 API/Serviços (Z6/Z1)

* **Taxa de chamadas** por `tenant/route/identity/IP ASN` (picos, bursts).
* **Latência p95/p99** com *z-score* por janela; **erro 4xx/5xx** por causa (Auth/WAF/Policy/Upstream).
* **Tamanho de payload** e **variação súbita**.
* **Decisões de OPA** (allow/deny) e **motivos** (policy drift).

### 2.2 Consumo (Z7)

* **Custo por rota/tenant** (tokens/$), **context length** e **padronização de prompts** (LLM).
* **Padrões temporais** (hora/dia/estação) por consumidor; **enumeração** (varredura de IDs/queries amplas).
* **Hit-ratio** de cache `/last` fora do normal (abuso).

### 2.3 Dados (Z2/Z3)

* **Acesso a datasets**: quem/leu/o quê/quando (linhas/colunas sensíveis).
* **Rejeições** de ingestão por AV/CDR/schema e **quarentena** (campanhas maliciosas).

### 2.4 Modelos/LLMs (Z6)

* **Score/Output drift** (ver Z9-2.4) correlacionado a **padrões de prompt**.
* **Assinatura/attestation** do modelo; **startup verification** falha/sucesso.

---

## 3) Técnicas de detecção

### 3.1 Regras & limiares dinâmicos

* **Holt-Winters/ETS**, **EWMA**, **STL (seasonal-trend)**, **ESD (Extreme Studentized Deviate)**.
* **Z-score robusto** (mediana & MAD) para séries com *outliers*.
* **Buckets** por chave (route×tenant×identity) para evitar efeito Simpson.

### 3.2 ML não supervisionado

* **Isolation Forest**, **One-Class SVM**, **Autoencoders** (reconstrução de sequência).
* **HMMs/LSTMs** para sequências (ordem de rotas/chamadas).
* **Grafos**: *centrality* anômala (nova relação consumidor→rota→dataset).

### 3.3 UEBA (perfil por identidade/entidade)

* **Baselines** por identidade (usuário/serviço/parceiro) e por **tenant**.
* **Features**: janela móvel de *TPS*, **rotas únicas/dia**, **IPs/ASN**, **faixa horária**, **custo/tokens**, **taxa de negações por política**.
* **Anomalia** = desvio relevante do perfil histórico daquela entidade.

### 3.4 Detectores específicos para LLMs/GenAI

* **Prompt injection/exfil**: *regexs* e classificadores para *canary tokens*, *secret prompts*, *jailbreak strings*.
* **Custo/token spike** e **context-length outliers**.
* **Output filtering hits** (DLP/máscara) como *leading indicator* de abuso.

---

## 4) Enriquecimento, correlação & priorização

* **Enriquecer** alerta com: `trace_id`, `tenant`, `identity`, `route`, *policy_digest*, `model.version`, **geolocalização/ASN**.
* **Correlacionar** com eventos contemporâneos (ex.: picos de **WAF/AV/CDR**; **deny** por OPA).
* **Severidade** (S1–S4) por impacto: **dados sensíveis**, **fraude**, **exfiltração**, **DoS**.
* **Deduplicação** por *fingerprint* (chave do evento) e **agrupamento** (mesma campanha).

> **Saída**: enviar para **SIEM/UEBA/SOAR** (Z8-2.6) com campos de **evidence link** e **playbook sugerido**.

---

## 5) Fluxos de resposta (alto nível)

1. **Anomalia detectada** → gerar **alerta enriquecido** (Z9).
2. **SOAR** aplica **playbook**: coleta *contexto*, bloqueia no **WAF/IAM/OPA**, abre **ticket** e notifica **on-call**.
3. **Evidências** armazenadas (bundles, *attestations*, *policy snapshots*) em **Evidence Store** (Z8-2.8).
4. **Pós-incidente**: *post-mortem* e **regra/limiar** ajustados (evitar recorrência).

---

## 6) Limiares & exemplos práticos

### 6.1 Exemplo — *z-score robusto* (Python)

```python
import numpy as np
def robust_z(x):
    med = np.median(x)
    mad = np.median(np.abs(x - med)) + 1e-9
    return (x[-1] - med) / (1.4826 * mad)  # ~z-score
# alerta se |z| > 4 e variação > 200% vs. mediana
```

### 6.2 PromQL — burst anômalo por rota/tenant

```promql
# TPS atual vs. baseline suavizado
rate(http_requests_total{zone="Z6"}[1m])
/
avg_over_time(rate(http_requests_total{zone="Z6"}[1m])[1h])
> 5
```

### 6.3 PromQL — custo por tenant (LLM)

```promql
sum by (tenant) (rate(inference_cost_usd_total{zone="Z7"}[5m])) > 2 * avg_over_time(inference_cost_usd_total{zone="Z7"}[24h])
```

### 6.4 Detector simples de *prompt injection* (pseudocódigo)

```python
patterns = [r"ignore previous", r"disable.*guard", r"system:.*reveal", r"exfiltrate", r"base64\(.*\)"]
if any(re.search(p, prompt.lower()) for p in patterns):
    flag("prompt_injection", severity="S2")
```

### 6.5 Política (OPA/Rego) — *rate guard* por identidade

```rego
package z9.anomaly.guard
default allow = true
deny[msg] {
  input.identity == "partner-foo"
  input.route == "/api/llm/predict"
  input.rate_tps > 5 * input.baseline_tps
  msg := "burst anomalous for partner-foo"
}
```

---

## 7) Riscos × Controles × Frameworks

| Risco observado                          | Controle (neste módulo)                                     | Conexões        |
| ---------------------------------------- | ----------------------------------------------------------- | --------------- |
| **DoS/abuso de API**                     | Holt-Winters/EWMA + *rate-guards* + bloqueio WAF/IAM/OPA    | Z1/Z6 ↔ Z8-2.6  |
| **Exfiltração / prompt-injection (LLM)** | Regras/ML de padrão + DLP/Output-filter + custo/token guard | Z6/Z7 ↔ Z8-2.5  |
| **Fraude/uso fora de propósito**         | UEBA por identidade/tenant, baseline temporal               | Z7 ↔ Z8-2.4/2.6 |
| **Campanhas de arquivo malicioso**       | Correlação AV/CDR + *quarentena* + bloqueio automático      | Z1 ↔ Z8-2.6     |
| **Falsos positivos em massa**            | Deduplicação/agrupamento + limiares dinâmicos               | Z9 ↔ SOAR       |

**Referenciais** (exemplos): NIST **SP 800-53** (AU, SI, IR), **NIST AI RMF** (Measure/Manage), **CSA AICM** (Detection & Response), **OWASP API/LLM** (abuso, exfiltração).

---

## 8) Checklists

**Antes do go-live**

* [ ] **Catálogo de sinais** (quais métricas, por rota/tenant/identidade).
* [ ] **Baselines** por entidade (mínimo 14–30 dias) e janelas por tipo de rota.
* [ ] **Limiares** iniciais: z-score robusto, Holt-Winters, quotas por identidade.
* [ ] **Playbooks SOAR** mapeados para cada categoria (DoS, exfil, fraude, malware).

**Operação**

* [ ] **Revisão mensal** de falsos positivos e ajuste de limiares/modelos.
* [ ] **Testes de mesa (table-top)** para cenários de abuso de LLM e exfiltração.
* [ ] **Acompanhamento de custo** (LLM) com *guardrails* e *quotas* por tenant.
* [ ] **Retroalimentar** regras com lições de incidentes (post-mortem).

---

## 9) Frases prontas (entrevista)

* “Eu mantenho **baselines por identidade/tenant** e aciono **UEBA** quando o padrão muda (hora, rota, custo/tokens, decisões de política).”
* “Para **LLM**, monitoro **prompt-injection/exfil** e **spikes de custo/contexto**; **bloqueios** são orquestrados via **WAF/IAM/OPA**.”
* “Os alertas saem **enriquecidos** com `trace_id`, `policy_digest`, `model.version` e seguem para **SOAR** com **evidence links**.”
