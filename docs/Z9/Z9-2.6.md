# Z9-2.6 — Auditoria, Evidence Store & Conformidade

↩️ Voltar: [Z9 — Monitoring, Observability & Audit](./Z9-index.md) · [README (Mapa Z0–Z9)](../../README.md) · Relacionado: Z8-2.8 (Compliance & Evidências)

> **Resumo**: Padroniza **trilhas de auditoria** e um **repositório de evidências** para provar “quem fez o quê, quando, por quê e com qual resultado” em todo o pipeline (Z0→Z7). Garante **integridade, imutabilidade, retenção e descobribilidade**, sustentando auditorias internas, regulatórias e pós-incidente.

---

## 1) Objetivos & escopo

**Objetivos**

* Gerar **evidências verificáveis** de operações, mudanças e decisões (humanas e de workload).
* Assegurar **integridade/imutabilidade** (hash/assinatura/WORM) e **linha do tempo** confiável.
* Permitir **consulta e correlação** rápida com logs/métricas/traces (Z9-2.1/2.2/2.3).
* Atender **requisitos regulatórios** (financeiro/LGPD), *forensics* e *post-mortem*.

**Escopo**

* Eventos de **ingestão** (Z1), **dados/curadoria** (Z2/Z3), **treino** (Z4), **governança/promoção** (Z5), **serving** (Z6) e **consumo** (Z7).
* Artefatos como **SBOMs**, **assinaturas/attestations** (*cosign/in-toto*), **políticas** (Rego), **gates** (decisão), **model cards**, **playbooks** e **relatórios**.

---

## 2) Modelo de dados — Evento de Auditoria (campos mínimos)

Cada evento deve seguir um **envelope JSON** (ou Protobuf/Avro equivalente):

```json
{
  "ts": "2025-11-15T23:14:07Z",
  "zone": "Z6",
  "service": "inference-gateway",
  "actor": { "type": "workload", "id": "svc.core-banking", "tenant": "bankA" },
  "subject": { "type": "model", "name": "churn", "version": "2.3.1", "stage": "prod" },
  "action": "predict.invoke",
  "decision": { "result": "allow", "reason": "policy:opa:allow", "policy_digest": "sha256:..." },
  "request": { "route": "/api/churn/v2/predict", "method": "POST", "size_bytes": 1820 },
  "response": { "status_code": 200, "latency_ms": 132 },
  "trace": { "trace_id": "7f3c5d...", "span_id": "9ab21c..." },
  "integrity": { "event_hash": "sha256:...", "prev_hash": "sha256:...", "signature": "sig:..." }
}
```

**Observações**

* **Sem PII/payloads**: apenas **metadados** (ver Z8-2.5 para DLP/masking).
* `policy_digest` referencia a **política** aplicada (Rego/versão).
* `prev_hash` cria **cadeia (hash-chain)** por *stream* (append-only).

---

## 3) Pipeline de Auditoria (coleta → imutabilidade → consulta)

1. **Coleta**

   * Bibliotecas/SDKs padronizados injetam eventos nos serviços (Z1/Z6/Z7).
   * **Sidecars/agents** capturam *admin actions* (UIs, CLI, consoles).

2. **Normalização & enriquecimento**

   * Enriquecer com `zone`, `tenant`, `policy_digest`, `model_signature`, `release_id` (Z5).
   * Correlacionar **Trace-ID** (Z9-2.3) e **run_id** (treino/ETL).

3. **Integridade & imutabilidade**

   * Calcular `event_hash` e `prev_hash`.
   * **Assinar** lote/janela (chave de auditoria, guardada em **KMS/HSM**, Z8-2.3).
   * Persistir em **WORM/Object Lock** (S3-compatível) com **retention**.

4. **Indexação & descoberta**

   * Indexar metadados em *data store* de busca (ex.: OpenSearch/Lucene).
   * Tabelas “quentes” (30–90d) para investigação rápida; “frias” (>90d) arquivadas, porém consultáveis.

5. **Consulta & export**

   * DSL/SQL para consultas por `actor/subject/action/tenant/trace_id`.
   * **Bundles de evidência** (zip/tar) com manifest (hashes), prontos para auditoria externa.

---

## 4) Integridade, tempo & cadeia de custódia

* **Tempo confiável**: sincronização NTP/TLS; registrar *clock skew*.
* **Hash-chain** por *stream* (ex.: por `zone/service/day`) para **detecção de buracos**.
* **Assinatura** de janelas (ex.: a cada 5 min) → *notarization* interna (ou âncora externa).
* **Cadeia de custódia**: cada *transfer/restore/export* gera novo evento com hash/assinatura.

---

## 5) Retenção & classificação (exemplos)

| Tipo de artefato                         | Retenção sugerida | Imutabilidade | Observações                           |
| ---------------------------------------- | ----------------: | :-----------: | ------------------------------------- |
| Eventos de auditoria (metadados)         |       12–24 meses |      WORM     | Quentes 90d, frios >90d               |
| *Approvals/gates* (Z5)                   |       24–36 meses |      WORM     | Inclui *attestations* e *model cards* |
| Logs de acesso a dados sensíveis (Z2/Z3) |       24–36 meses |      WORM     | Restritos por LGPD                    |
| Relatórios de incidente/post-mortem      |          36 meses |      WORM     | Vincular *evidence bundle*            |
| SBOMs/assinaturas de build               |       24–36 meses |      WORM     | Necessários para *supply chain*       |

> Ajustar à política corporativa e regulações locais.

---

## 6) Consultas operacionais (exemplos)

**6.1 — Quem promoveu o modelo `churn@2.3.1` para *prod*?**

```sql
SELECT ts, actor.id, decision.reason
FROM audit_events
WHERE subject.type='model'
  AND subject.name='churn'
  AND subject.version='2.3.1'
  AND action='model.promote'
ORDER BY ts DESC LIMIT 5;
```

**6.2 — Todas as negações de política (OPA) na rota `/api/churn/v2/predict` nas últimas 24h**

```sql
SELECT ts, actor.id, tenant, decision.reason, policy_digest, trace.trace_id
FROM audit_events
WHERE action='predict.invoke'
  AND request.route='/api/churn/v2/predict'
  AND decision.result='deny'
  AND ts > now() - interval '24 hours';
```

**6.3 — Evidências para um incidente (por `trace_id`)**

```sql
SELECT *
FROM audit_events
WHERE trace.trace_id='7f3c5d...'
ORDER BY ts;
```

---

## 7) Integrações essenciais

* **Z8-2.3 (KMS/HSM)**: chaves de assinatura, rotação, CRL.
* **Z8-2.8 (Evidence Store)**: armazenamento dos bundles; *links* nos eventos.
* **Z5 (Registry)**: *release_id*, *attestations*, *approvals* referenciados nos eventos.
* **Z6/Z7**: *hooks* para registrar **startup verification**, **policy checks** e **DLP hits**.
* **SIEM/UEBA/SOAR (Z8-2.6)**: ingestão dos eventos e disparo de playbooks.

---

## 8) Riscos × Controles × Frameworks

| Risco                     | Controles (neste módulo)                                         | Apoios           |
| ------------------------- | ---------------------------------------------------------------- | ---------------- |
| **Log adulterado**        | Hash-chain, assinatura por janela, WORM/Object Lock              | Z8-2.3 (KMS/HSM) |
| **Lacunas na trilha**     | `prev_hash` + verificação de sequência; *alerts* para saltos     | Z9-2.1 (ingest)  |
| **Evidência incompleta**  | Envelope canônico + *bundles* com manifest e hashes              | Z8-2.8           |
| **Quebra de privacidade** | Metadados sem PII; DLP/masking; acesso mínimo                    | Z8-2.5           |
| **Não conformidade**      | Políticas de retenção/classificação; *access reviews* periódicos | GRC interno      |

**Referenciais comuns**: NIST-style (AU-*, SC-*, IA-*), CSA CCM (LOG, EKM, IAM), SSDF/SLSA (supply chain), LGPD (minimização/acesso).

---

## 9) Checklists

**Antes do go-live**

* [ ] Envelope de auditoria padronizado (campos mínimos).
* [ ] Hash-chain + assinatura por janela com chaves em **KMS/HSM**.
* [ ] **WORM/Object Lock** configurado e testado (retenção/Legal Hold).
* [ ] Índices/consultas mais usadas publicadas (catálogo).
* [ ] Processo de **evidence bundle** (manifest + hashes + assinaturas).

**Operação**

* [ ] **Verificação periódica de integridade** (amostras de janelas).
* [ ] **Access reviews** do Evidence Store e trilhas.
* [ ] *Runbooks* de export para auditoria externa (com *chain-of-custody*).
* [ ] Testes de **restore** e **descoberta** (busca por trace/actor/subject).

---

## 10) Trechos práticos

**10.1 — Geração de hash-chain (pseudocódigo)**

```python
prev = read_prev_hash(stream="Z6/inference-gateway/2025-11-15")
event_hash = sha256(json_bytes(event))
link_hash = sha256((prev + event_hash).encode())
store(event, integrity={"event_hash": event_hash, "prev_hash": prev, "link_hash": link_hash})
write_prev_hash(link_hash)
```

**10.2 — Política OPA: negar *promote* sem evidência mínima**

```rego
package z9.audit.guard
default allow = false
allow {
  input.action == "model.promote"
  input.subject.type == "model"
  input.subject.name != ""
  input.subject.version != ""
  input.policy_digest != ""
  input.integrity.signature != ""
}
```

**10.3 — Manifest do *bundle* (YAML)**

```yaml
bundle:
  id: "incident-2025-11-15-1337"
  created_at: "2025-11-15T23:20:00Z"
  artifacts:
    - path: events.jsonl
      sha256: "..."
    - path: approvals.pdf
      sha256: "..."
    - path: attestations.json
      sha256: "..."
  signature: "sig:..."
```

---

## 11) Frases prontas (entrevista)

* “Minhas **trilhas de auditoria** são **append-only**, com **hash-chain**, **assinatura por janela** e **WORM**; qualquer lacuna é detectável.”
* “Cada decisão crítica (ex.: **promoção de modelo**) gera **evidência vinculada** (policy digest, approvers, attestations, release_id).”
* “Para **forense/regulatório**, eu exporto **bundles assinados** com *manifest* e preservo **cadeia de custódia** do início ao fim.”
