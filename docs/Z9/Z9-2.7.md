# Z9-2.7 — Alerting, SLOs & On-Call Orchestration

↩️ Voltar: [Z9 — Monitoring, Observability & Audit](./Z9-index.md) · ↩️ [README (Mapa Z0–Z9)](../../README.md) · Relacionado: Z9-2.1/2.2/2.3 (logs/métricas/traces), Z9-2.4 (drift/bias), Z9-2.5 (UEBA), Z9-2.6 (evidências), Z8-2.6 (SIEM/UEBA/SOAR)

> **Resumo**: Define **SLIs/SLOs**, **regras de alerta** e o **fluxo de on-call** (paginação, escalonamento, playbooks, pós-incidente) para eventos **operacionais** e **de segurança**. Reduz *alert fatigue* com **correlação, deduplicação, burn rate** e janelas múltiplas. Conecta telemetria de Z1/Z6/Z7 ao SOC/SRE via **SIEM/UEBA/SOAR**.

---

## 1) Objetivos & escopo

**Objetivos**

* Traduzir requisitos de negócio em **SLOs mensuráveis** e **alertas acionáveis**.
* Garantir **resposta rápida** a falhas (MTTD/MTTR baixos) e **evitar ruído**.
* Orquestrar **on-call 24×7** com **playbooks automatizados** e **evidências** auditáveis.

**Escopo**

* **Operação** (latência, erro, disponibilidade, custo) e **Segurança** (abuso, exfil, drift crítico).
* **Online, batch e LLM/GenAI** (inclui custo/tokens e sinais de prompt-abuse).
* Integrações com **Z8-2.6 (SIEM/SOAR)** e **Z9-2.6 (Evidence Store)**.

---

## 2) Conceitos (rápido)

* **SLA**: compromisso contratual externo.
* **SLO**: meta interna (ex.: *Disponibilidade 99,9%/30d*).
* **SLI**: métrica que mede o SLO (ex.: *taxa de sucesso HTTP 2xx/3xx*).
* **Erro Budget**: 1 − SLO (ex.: 0,1% falhas permitidas/mês).
* **Burn Rate**: velocidade de consumo do erro budget (alertas por janelas curtas/longas).
* **Severidade (S1–S4)**: impacto/urgência para roteamento e escalonamento.

---

## 3) SLIs/SLOs recomendados (exemplos por domínio)

### 3.1 Z6 — Inference Gateway (online)

* **Disponibilidade**: `success_rate >= 99.9%` (30d).
* **Latência**: `p95 <= 250 ms` (modelo tabular) • `p95 <= 800 ms` (LLM proxy).
* **Taxa de erro**: `5xx <= 0.1%` (30d).
* **Custo (LLM)**: `usd_per_1k_requests <= target` por rota/tenant.
* **Qualidade** (quando há *ground truth*): desvio de acurácia ≤ *ε* vs. baseline.

### 3.2 Z7 — Consumo (apps/core/fraud)

* **Tempo fim-a-fim p95** (cliente→resposta) ≤ *X* ms.
* **Quota de chamada por tenant** respeitada (proteção anti-abuso).
* **Contrato de versão** (rota/modelo) conforme *deprecation window*.

### 3.3 Segurança (transversal)

* **Gate de política**: taxa de *deny* anômala acionando S2.
* **LLM**: *prompt-abuse hits* e *output-filter hits* acima do baseline → S2/S3.
* **Drift crítico** (PSI/KS/score-drift) acima do limiar → S2 e *shadow/canary* automático.

> **Observação**: métricas sensíveis **sem PII/payload** (ver Z8-2.5).

---

## 4) Estratégia de alertas (ruído baixo, ação alta)

* **Burn Rate** em **duas janelas** (ex.: 5m/1h e 1h/6h) para diferenciar surto vs. degradação sustentada.
* **Deduplicação & agregação** por `tenant/route/model_version` (evita *storm*).
* **Suppress/maintenance window** em mudanças planejadas.
* **Correlacionar** com **SIEM** (WAF/OPA/DLP/UEBA) para elevar severidade quando houver sinal de abuso/exfil.
* **Roteamento por tipo**: SRE (operacional) vs. SOC (segurança) com *fallback* conjunto para S1.

---

## 5) Severidade & roteamento (exemplo)

| Sev    | Critério típico                                                  | Quem atende       | SLA de resposta  |
| ------ | ---------------------------------------------------------------- | ----------------- | ---------------- |
| **S1** | indisponibilidade ampla, exfil detectada, custo fora de controle | **SRE+SOC**       | **5 min**        |
| **S2** | latência/erros altos em rota crítica, drift crítico, abuso forte | SRE ou SOC        | 15 min           |
| **S3** | degradação moderada, taxa de denials anômala                     | SRE/SOC (triagem) | 1 h              |
| **S4** | aviso/tendência, backlog batch                                   | Observação        | Próximo dia útil |

---

## 6) Playbooks (SOAR) — linhas gerais

* **S1 operação**: *rollback* de modelo (via Z5), reduzir tráfego (*canary off*), *circuit breaker*, aumentar *sampling*, abrir war-room.
* **S1 segurança**: bloquear no WAF/IAM, ativar *mTLS strict*, reforçar filtros de saída, *legal hold* no Evidence Store.
* **S2 drift/bias**: acionar *shadow*, congelar *feature pipeline* afetada, preparar *retrain* (Z4), abrir comitê de risco.
* **S2 custo (LLM)**: **throttle/quotas** por tenant, ativar *cache*, revisar *context length*.
* **S3**: investigar picos regionais/tenant-específicos, ajustar *rate limit* e *keepalive*.

Todos os playbooks: **registrar evidências** (Z9-2.6) e **vincular trace** do incidente.

---

## 7) Regras Prometheus (exemplos)

### 7.1 Burn rate — erro orçamental (SRE style)

```promql
# SLO: success_rate >= 99.9% (error_budget=0.1%)
# Curta (5m/1h) → S2
sum(rate(http_requests_total{zone="Z6",status=~"5.."}[5m]))
/ sum(rate(http_requests_total{zone="Z6"}[5m])) > 0.01
and
sum(rate(http_requests_total{zone="Z6",status=~"5.."}[1h]))
/ sum(rate(http_requests_total{zone="Z6"}[1h])) > 0.001
```

### 7.2 Latência p95 elevada

```promql
histogram_quantile(
  0.95, sum(rate(http_request_duration_seconds_bucket{zone="Z6"}[5m])) by (le, route, tenant)
) > 0.8
```

### 7.3 Custo LLM por tenant

```promql
rate(inference_cost_usd_total{zone="Z7"}[5m])
> 2 * avg_over_time(inference_cost_usd_total{zone="Z7"}[24h])
```

### 7.4 Sinais de abuso (OPA/WAF)

```promql
increase(opa_denies_total{zone="Z6"}[10m]) > 100
or
increase(waf_block_total{zone="Z1"}[10m]) > 100
```

> **Ação**: enviar para **Alertmanager** com **roteamento** SRE/SOC e **anotação** de *playbook*.

---

## 8) Integrações

* **Z6**: exporta SLIs (latência, erro, custo) e eventos de política/DLP para correlação.
* **Z7**: métricas fim-a-fim por app/tenant/use-case.
* **Z8-2.6**: SIEM/UEBA/SOAR recebe alertas, executa **playbooks** e devolve status.
* **Z9-2.6**: cada alerta incidente gera/consulta **evidence bundle**.

---

## 9) Riscos × Controles × Frameworks

| Risco                             | Controles aqui                                                    | Conexões           |
| --------------------------------- | ----------------------------------------------------------------- | ------------------ |
| **Alert fatigue**                 | burn rate multi-janela, dedup/suppress, roteamento por severidade | Z9-2.1/2.2/2.3     |
| **Incidentes longos (MTTR alto)** | playbooks SOAR, evidência pronta, rollback/canary autom.          | Z5, Z8-2.6, Z9-2.6 |
| **Vazamento/abuso sem resposta**  | integração SIEM/OPA/WAF, S1 conjunto SRE+SOC                      | Z1, Z6, Z8-2.5/2.6 |
| **FinOps (LLM) fora de controle** | SLO de custo, quotas/teto, alertas por tenant                     | Z7                 |

**Referenciais**: práticas SRE (SLO/erro budget), NIST SP 800-53 (IR, AU, SI), CSA CCM (LOG/STA/SEF), OWASP API/LLM (abuso e exfiltração).

---

## 10) Checklists

**Antes do go-live**

* [ ] SLOs por rota/tenant/modelo definidos e publicados.
* [ ] Regras de alerta com **janelas curta/longa** e **dedup** por chave.
* [ ] Matriz de **severidade & roteamento** (SRE/SOC), escalonamentos e contatos.
* [ ] Playbooks SOAR para **operação** e **segurança** (links no alerta).
* [ ] Teste de **página** (game day) e **simulação de incidentes**.

**Operação**

* [ ] Revisar **falsos positivos** mensalmente; ajustar limiares.
* [ ] Medir **MTTD/MTTR** e **burn** do erro budget; reportar tendências.
* [ ] Pós-incidente com **ações preventivas** e atualização de playbooks.
* [ ] Revisar **custos LLM** e ajustar **quotas**/contexto.

---

## 11) Frases prontas (entrevista)

* “Nossos SLOs cobrem **disponibilidade, latência p95, erro e custo** por rota/tenant; alertamos por **burn rate** com janelas curta/longa.”
* “Integro **OPA/WAF/DLP** ao SIEM para elevar severidade em **abuso/exfil**, e **SOAR** aplica *playbooks* (rollback/circuit-breaker) com **evidências**.”
* “Controlamos **custos LLM** por tenant com alertas e **quotas**, além de *shadow/canary* quando drift crítico é detectado.”
